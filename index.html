<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<link rel="icon" type="image/x-icon" href="assets/favicon.png">
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title>مجموعة محمد بن ذعار العجمي للسيارات</title>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700;800&amp;display=swap" rel="stylesheet"/>
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js">
<script>
function showFastModal(title){
  const m = document.getElementById('fastActionModal');
  const t = document.getElementById('fastActionTitle');
  if(t) t.textContent = title || 'جاري التنفيذ';
  if(m) m.style.display = 'flex';
}

function hideFastModal(){
  const m = document.getElementById('fastActionModal');
  if(m) m.style.display = 'none';
}
</script>

</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
    :root{--brown:#3e2420;--beige:#bc8f74;--cream:#fff8ef;--bg:#f6f2ed;--card:#fff;--text:#1f1f1f;--muted:#6b6b6b;--line:#e9dfd5;--shadow:0 10px 24px rgba(0,0,0,.08);--r:12px}
    *{box-sizing:border-box}
    body{margin:0;font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:0 auto;padding:16px}
    .topbar{background:#fff;border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:10px}
    .dot{width:12px;height:12px;border-radius:50%;background:var(--beige);box-shadow:0 0 0 6px rgba(188,143,116,.18)}
    .title{font-weight:800;color:var(--brown);font-size:18px}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--cream);padding:8px 10px;border-radius:999px;font-size:13px;color:var(--brown)}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:10px;padding:10px 12px;font-weight:800;font-family:inherit;display:inline-flex;align-items:center;gap:8px}
    .btn.primary{background:var(--brown);color:#fff}
    .btn.secondary{background:#fff;border:1px solid var(--line);color:var(--brown)}
    .btn.danger{background:#b42318;color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow)}
    .card h3{margin:0;padding:14px;border-bottom:1px solid var(--line);color:var(--brown);font-size:16px}
    .card .body{padding:14px}

    .tabs{margin-top:14px}
    .tabbar{display:flex;gap:8px;flex-wrap:wrap;background:#fff;border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:8px}
    .tab{padding:10px 12px;border-radius:10px;border:1px solid transparent;font-weight:900;color:var(--brown);cursor:pointer}
    .tab.active{background:var(--cream);border-color:var(--line)}
    .view{display:none;margin-top:14px}
    .view.active{display:block}

    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}

    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;border:1px solid var(--line);border-radius:10px;padding:10px;font-family:inherit;background:#fff;outline:none}
    textarea{min-height:90px;resize:vertical}

    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
    @media(max-width:680px){.row{grid-template-columns:1fr}}
    .span2{grid-column:1 / -1}

    .checks{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    @media(max-width:980px){.checks{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:520px){.checks{grid-template-columns:repeat(2,1fr)}}
    .checkItem{border:1px solid var(--line);border-radius:10px;padding:10px;display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--cream)}
    .checkItem span{font-weight:900;color:var(--brown);font-size:13px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;align-items:flex-end}
    .toolbar .field{min-width:220px}

    .tableWrap{max-height:560px;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--line);color:var(--brown);font-size:12px;text-align:right;padding:6px 8px;white-space:nowrap}
    tbody td{border-bottom:1px solid var(--line);padding:6px 8px;font-size:12.5px;vertical-align:top}

    .linkBtn{display:inline-flex;align-items:center;justify-content:center;padding:7px 10px;border-radius:10px;border:1px solid var(--line);background:var(--cream);color:var(--brown);font-weight:900;cursor:pointer;white-space:nowrap}
    .linkBtn:hover{filter:brightness(.98)}

    .tag{display:inline-flex;align-items:center;border-radius:999px;padding:5px 10px;font-weight:900;font-size:12px;white-space:nowrap}
    .tag.ok{background:#e7f7ed;color:#087443;border:1px solid #bfe7cc}
    .tag.no{background:#feeceb;color:#a1130b;border:1px solid #f5c2be}

    .authBox{max-width:520px;margin:22px auto}
    .hidden{display:none !important}

    .toast{position:fixed;left:16px;bottom:16px;background:#111;color:#fff;padding:12px 14px;border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.25);opacity:0;transform:translateY(10px);transition:.25s;max-width:92vw;z-index:9999}
    .toast.show{opacity:1;transform:translateY(0)}

    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:14px;z-index:9998}
    .modalBackdrop.show{display:flex}
    #missingModal .modal{max-height:85vh;display:flex;flex-direction:column}
    #missingModal .modalBody{overflow:auto}

    /* ===== Missing Branches Modal - enhanced look ===== */
    #missingModal .modal{width:min(1100px,98vw)}
    #missingModal .modalHead{gap:12px}
    #missingModal .modalHead .titleWrap{display:flex;flex-direction:column;gap:4px}
    #missingModal .modalHead .subMeta{font-size:12px;color:var(--muted);font-weight:700}
    #missingModal .mbToolbar{display:flex;gap:10px;align-items:flex-end;flex-wrap:wrap;padding:14px;border-bottom:1px solid var(--line);background:#fff}
    #missingModal .mbToolbar .field{flex:1;min-width:260px}
    #missingModal .mbActions{display:flex;gap:8px;flex-wrap:wrap;align-items:flex-end}
    #missingModal .mbPill{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:var(--cream);border-radius:999px;padding:7px 10px;font-weight:900;color:var(--brown);white-space:nowrap}
    #missingModal .mbTableWrap{overflow:auto;max-height:70vh;border:1px solid var(--line);border-radius:12px;background:#fff;margin:14px}
    #missingModal table{min-width:1100px}
    #missingModal tbody tr:nth-child(even){background:#fafafa}
    #missingModal tbody td{font-weight:700}
    #missingModal .num{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}


    .modal{width:min(720px,96vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.2);overflow:hidden}
    .modalHead{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--line);background:var(--cream)}
    .modalHead h4{margin:0;color:var(--brown)}
    .modalBody{padding:14px}
    .modalFoot{padding:14px;border-top:1px solid var(--line);display:flex;gap:8px;justify-content:flex-start;flex-wrap:wrap}

    .small{font-size:12px;color:var(--muted);line-height:1.7}
  
/* توسيع جدول المخزون فقط */
#view-inventory .body{
  padding: 0;
}


/* سطر واحد لكل خلايا جدول المخزون */
#inv_table th,
#inv_table td{
  white-space: nowrap;
  vertical-align: middle;
  text-align: center;
  font-weight: 700;
}


/* جعل جدول المخزون بعرض الصفحة بالكامل */
#view-inventory{
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
}

#view-inventory .card{
  border-radius: 0;
}

#view-inventory .tableWrap{
  width: 100vw;
}


/* جدول النقل في تاب نقل السيارات بعرض الصفحة */
#view-transfer .tableWrap{
  width: 100vw;
  margin-left: calc(-50vw + 50%);
  margin-right: calc(-50vw + 50%);
  border-radius: 0;
}
#view-transfer .tableWrap table{
  width: 100%;
}



/* نقل السيارات: خليه نفس شكل تاب الطلبات (كارت بعرض الصفحة + جدول داخل الكارت) */
#view-transfer .grid{
  grid-template-columns: 1fr !important;
}

#view-transfer .card{
  width: 100%;
}

#tr_tableWrap{
  width: 100%;
  margin: 0;
}

#tr_tableWrap table{
  width: 100%;
}


/* Focus bar (المكان المستهدف + الحالة) */
#view-transfer .focusBar{
  margin-bottom:10px;
  padding:10px 12px;
  border:1px solid rgba(62,36,32,.18);
  background:#fff8ef;
  border-radius:12px;
  box-shadow:0 8px 18px rgba(0,0,0,.06);
}
#view-transfer .focusBar label{ font-weight:800; }
#view-transfer .focusBar select,
#view-transfer .focusBar input{
  background:#fff;
}



/* FIX FINAL: خلي تاب نقل السيارات نفس Layout تاب الطلبات */
#view-transfer{
  max-width: 100%;
}
#view-transfer > .card{
  max-width: 100%;
  margin: 0 auto;
}
#view-transfer .body{
  padding: 16px;
}
#view-transfer .tableWrap{
  width: 100%;
  margin: 0;
}
#view-transfer table{
  width: 100%;
}



    /* ===== Requests Focus Bar ===== */
    .reqFocus{border:1px solid var(--line);border-radius:14px;background:var(--cream);padding:12px 12px 10px 12px;margin-bottom:12px}
    .reqFocusGrid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;align-items:end}
    .reqFocusGrid label{color:var(--brown);font-weight:900}
    .reqFocusGrid select,.reqFocusGrid input{background:#fff;border:1px solid #eadfd4}
    @media(max-width:980px){.reqFocusGrid{grid-template-columns:repeat(2,minmax(0,1fr))}}
    @media(max-width:520px){.reqFocusGrid{grid-template-columns:1fr}}


    /* ===== Dashboard ===== */
    .dashGrid{display:grid;grid-template-columns:repeat(3, minmax(0,1fr));gap:14px;margin-top:14px}
    .dashCard .body{display:grid;gap:10px}
    .dashKpis{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:10px}
    
/* Car Shortages card layout (only) */
.dashKpis.csKpis{grid-template-columns:repeat(3, minmax(0,1fr));}
@media (max-width: 900px){
  .dashKpis.csKpis{grid-template-columns:repeat(2, minmax(0,1fr));}
}
.dashKpi{background:#fff;border:1px solid #f0e6dc;border-radius:12px;padding:10px 12px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .dashKpi span{color:var(--muted);font-size:13px;font-weight:700}
    .dashKpi b{font-size:18px;color:var(--brown)}
    .dashBtns{display:flex;gap:8px;flex-wrap:wrap}
    .dashFilters{display:grid;grid-template-columns:220px 1fr 220px;gap:12px;align-items:end}
    .dashStatusBox{border:1px solid #f0e6dc;border-radius:12px;background:#fff;padding:10px 12px}
    .dashChecks{display:flex;gap:10px;flex-wrap:wrap}
    .dashChk{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--brown);font-weight:700}
    .dashFilterActions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}

    @media (max-width:1100px){
      .dashGrid{grid-template-columns:repeat(2, minmax(0,1fr))}
      .dashFilters{grid-template-columns:1fr}
      .dashFilterActions{justify-content:flex-start}
    }
    @media (max-width:720px){
      .dashGrid{grid-template-columns:1fr}

/* === FIX: Card title total on the left + Notes column (Dash modal) === */
.cardTitleRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  flex-wrap:nowrap;
  padding:14px 16px;           /* داخل الكارت */
  border-bottom:1px solid var(--line);
}
.cardTitleRow h3{
  margin:0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.cardTotal{
  white-space:nowrap;
  font-weight:600;
}
.cardTotal b{font-weight:900;}
.cardTitleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:nowrap;}
.cardTitleRow h3{margin:0;min-width:0;}
.cardTotal{white-space:nowrap;}
#dashDataModal .dashNotesCol{display:none;}
#dashDataModal.showNotes .dashNotesCol{display:table-cell;}
    }


/* === FIX (GLOBAL): Card title total stays in same row + Notes column (Dash modal) === */
.cardTitleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:nowrap}
.cardTitleRow h3{margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(100% - 90px)}
.cardTotal{white-space:nowrap}
#dashDataModal .dashNotesCol{display:none;}
#dashDataModal.showNotes .dashNotesCol{display:table-cell;}

/* === PATCH: totals inline text (label + bold number) === */
.cardTotal{
  border:none !important;
  background:transparent !important;
  padding:0 !important;
  min-width:unset !important;
  height:auto !important;
  border-radius:0 !important;
  font-weight:400 !important;
  color:var(--brown) !important;
}
.cardTotal b{font-weight:900;}
.cardTitleRow{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:nowrap;}
.cardTitleRow h3{margin:0;min-width:0;}
.cardTotal{white-space:nowrap;}


/* داش بورد: تمييز الإجمالي الفعلي و */
#stk_totalActual, #stk_keysTotal,
#ag_totalActual,  #ag_keysTotal,
#b1_totalActual,  #b1_keysTotal,
#b2_totalActual,  #b2_keysTotal,
#b3_totalActual,  #b3_keysTotal{
  color: #d97706; /* برتقالي مناسب */
}


/* داش بورد: إبراز الإجمالي الفعلي و */
#view-dashboard .dashKpi:has(#stk_totalActual),
#view-dashboard .dashKpi:has(#stk_keysTotal),
#view-dashboard .dashKpi:has(#ag_totalActual),
#view-dashboard .dashKpi:has(#ag_keysTotal),
#view-dashboard .dashKpi:has(#b1_totalActual),
#view-dashboard .dashKpi:has(#b1_keysTotal),
#view-dashboard .dashKpi:has(#b2_totalActual),
#view-dashboard .dashKpi:has(#b2_keysTotal),
#view-dashboard .dashKpi:has(#b3_totalActual),
#view-dashboard .dashKpi:has(#b3_keysTotal){
  border: 2px solid #d97706;
  border-radius: 12px;
  padding: 10px 12px;
}
#view-dashboard #stk_totalActual, #view-dashboard #stk_keysTotal,
#view-dashboard #ag_totalActual,  #view-dashboard #ag_keysTotal,
#view-dashboard #b1_totalActual,  #view-dashboard #b1_keysTotal,
#view-dashboard #b2_totalActual,  #view-dashboard #b2_keysTotal,
#view-dashboard #b3_totalActual,  #view-dashboard #b3_keysTotal{
  color:#d97706;
}


/* Dashboard: saved cards container should flow inside grid */
#dash_saved_cards{display:contents}

/* Dashboard: highlight totals (اجمالي فعلي/مفاتيح) */
#view-dashboard .kpiHighlight{
  border:2px solid #d97706;
  border-radius:12px;
  padding:10px 12px;
}
#view-dashboard .kpiHighlight b{
  color:#d97706;
}


/* Dashboard enhancements */
.dashKpi.clickable{cursor:pointer;}
/* Dashboard card titles clickable */
#dash_trk_title, #dash_req_title{cursor:pointer;}

#dashDataModal .modalBox, #reqModal .modalBox, #detailsModal .modalBox{width:min(96vw, 1400px);}
#dashDataModal .tableWrap, #reqModal .tableWrap, #detailsModal .tableWrap{max-height:60vh;}


/* DASH MODAL TWEAK */
#dashDataModal .modal{max-width: 96vw; width: 96vw; max-height: 86vh; height: auto;}
#dashDataModal .modalBody{max-height: 70vh; overflow:auto;}
#dashDataModal table{min-width: 1100px;}


/* DASH DATA MODAL */
#dashDataModal .modal-card{max-width:95vw;width:95vw;max-height:85vh;height:85vh;display:flex;flex-direction:column;}
#dashDataModal .modal-body{flex:1;overflow:auto;}
#dashDataModal table{min-width:1100px;}

/* SHEET IMPORT MODAL */
#sheetImportModal .modal-card{max-width:900px;width:95vw;}


/* Tracking modal table */
.table.stickyHead thead th{position:sticky; top:0; background:#fff8ef; z-index:2;}
#detailsModal .modal{max-height:88vh;}
#detailsModal .modalBody{max-height:calc(88vh - 56px); overflow:auto;}

    /* ===== Admin Sub Tabs ===== */
    .subTabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .subTab{background:#fff;border:1px solid rgba(0,0,0,.12);border-radius:12px;padding:9px 14px;font-weight:900;color:var(--brown);cursor:pointer}
    .subTab.active{background:var(--brown);border-color:var(--brown);color:#fff}
    .subView.hidden{display:none}
    .btnRow{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}


    /* Approvals modal clickable rows */
    tr.apRow{cursor:pointer}
    tr.apRow:hover{background:rgba(188,143,116,.12)}

/* ===== Dashboard Total Badge ===== */
.dashTotalWrap{
  display:flex;
  align-items:center;
  justify-content:flex-end;
  gap:10px;
  margin:6px 0 12px;
}
.dashTotalLabel{
  font-size:12px;
  font-weight:600;
  color:rgba(62,36,32,.75);
}
.dashTotalBadge{
  display:inline-flex;
  align-items:center;
  justify-content:center;
  height:38px;
  min-width:38px;
  padding:0 12px;              /* يسمح لرقمين/3 أرقام بدون ما يبوظ */
  border-radius:999px;          /* دائري/بيضاوي حسب الرقم */
  background:#fff8ef;
  border:2px solid #bc8f74;
  color:#3e2420;
  box-shadow:0 6px 14px rgba(62,36,32,.12);
  font-weight:800;
  font-size:15px;
  line-height:1;
}
.dashTotalBadge b{font-weight:800;}

/* === Dashboard: Total inline with card title === */
.cardTitleRow .dashTitleTotal{
  display:inline-flex;
  align-items:center;
  gap:8px;
  white-space:nowrap;
  font-size:12px;
  font-weight:700;
  color:rgba(62,36,32,.75);
}
.cardTitleRow .dashTitleTotal .dashTotalBadge{
  height:30px;
  min-width:30px;
  padding:0 10px;
  font-size:13px;
  border-width:2px;
  box-shadow:0 4px 10px rgba(62,36,32,.10);
}
.cardTitleRow .dashTitleTotal .dashTotalBadge b{font-weight:900;}



/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}


/* ===== Transfer checklist segmented choice ===== */
.trSegBtn.active{background:var(--brown);border-color:var(--brown);color:#fff;}
</style>
<style>
    /* Dashboard modals wider */
    #dashDataModal .modal, #detailsModal .modal{width:96vw;max-width:96vw}
    #dashDataModal table.table{min-width:1200px}
  
/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<style>
/* FIX: Tracking tab layout without mzj-ui */
#tracking-tab,
.tracking-tab,
.tracking-container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 !important;
}

.tracking-content,
.sales-wrapper,
.sales-container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 auto !important;
  float: none !important;
}

.sales-side,
.sales-right,
.sales-panel {
  float: none !important;
}

body {
  overflow-x: hidden;
}

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<style>
html, body {
  direction: rtl;
  text-align: right;
}

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>

<!-- ===== MOBILE RESPONSIVE CSS (Added for Mobile Support) ===== -->
<style>
/* ===== Mobile Sidebar Toggle ===== */
#sidebarToggle{
  display:none;
  position:fixed;
  top:12px;
  right:12px;
  z-index:10000;
  width:44px;
  height:44px;
  border:none;
  border-radius:10px;
  background:var(--brown);
  color:#fff;
  font-size:22px;
  cursor:pointer;
  box-shadow:0 4px 14px rgba(0,0,0,.25);
  align-items:center;
  justify-content:center;
}

#mobileSidebar{
  display:none;
  position:fixed;
  top:0;
  right:-280px;
  width:280px;
  height:100%;
  background:#fff;
  z-index:10001;
  box-shadow:-4px 0 20px rgba(0,0,0,.15);
  transition:right .3s ease;
  overflow-y:auto;
  -webkit-overflow-scrolling:touch;
}

#mobileSidebar.sidebar-open{
  right:0;
}

#sidebarOverlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:10000;
  opacity:0;
  transition:opacity .3s ease;
}

#sidebarOverlay.sidebar-open{
  opacity:1;
}

#sidebarClose{
  position:absolute;
  top:12px;
  left:12px;
  width:36px;
  height:36px;
  border:none;
  border-radius:8px;
  background:var(--cream);
  color:var(--brown);
  font-size:20px;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
}

.sidebarHeader{
  padding:16px;
  border-bottom:1px solid var(--line);
  background:var(--cream);
}

.sidebarHeader .brand-title{
  font-weight:800;
  color:var(--brown);
  font-size:15px;
  margin-bottom:4px;
}

.sidebarHeader .brand-sub{
  font-size:12px;
  color:var(--muted);
}

.sidebarNav{
  padding:12px 0;
}

.sidebarNav .sidebarTab{
  display:block;
  width:100%;
  padding:14px 18px;
  border:none;
  background:transparent;
  text-align:right;
  font-family:inherit;
  font-size:14px;
  font-weight:700;
  color:var(--brown);
  cursor:pointer;
  border-bottom:1px solid var(--line);
  transition:background .15s;
}

.sidebarNav .sidebarTab:hover,
.sidebarNav .sidebarTab.active{
  background:var(--cream);
}

.sidebarNav .sidebarTab.active{
  border-right:4px solid var(--brown);
}

.sidebarAuth{
  padding:14px 16px;
  border-top:1px solid var(--line);
  background:var(--cream);
}

.sidebarAuth .pill{
  display:block;
  text-align:center;
  margin-bottom:10px;
}

.sidebarAuth .btn{
  width:100%;
  justify-content:center;
}

/* ===== Mobile Responsive Breakpoints ===== */

/* Tablet and below: 768px */
@media (max-width:768px){
  html,body{
    overflow-x:hidden;
  }
  
  #sidebarToggle{
    display:flex;
  }
  
  #mobileSidebar{
    display:block;
  }
  
  #sidebarOverlay{
    display:block;
    pointer-events:none;
  }
  
  #sidebarOverlay.sidebar-open{
    pointer-events:auto;
  }
  
  /* Hide desktop topbar tabs on mobile */
  .topbar{
    padding-right:60px;
  }
  
  .tabbar{
    display:none !important;
  }
  
  /* Wrap adjustments */
  .wrap{
    padding:10px;
    padding-top:60px;
  }
  
  /* Dashboard grid */
  .dashGrid{
    grid-template-columns:1fr !important;
  }
  
  .dashFilters{
    grid-template-columns:1fr !important;
  }
  
  .dashKpis{
    grid-template-columns:1fr !important;
  }
  
  .dashKpis.csKpis{
    grid-template-columns:1fr !important;
  }
  
  /* Cards */
  .card{
    border-radius:10px;
  }
  
  .card h3{
    font-size:14px;
    padding:12px;
  }
  
  .card .body{
    padding:12px;
  }
  
  /* Tables scroll */
  .tableWrap{
    overflow-x:auto;
    -webkit-overflow-scrolling:touch;
    max-width:100%;
  }
  
  table{
    min-width:600px;
  }
  
  /* Toolbar */
  .toolbar{
    flex-direction:column;
    align-items:stretch;
  }
  
  .toolbar .field{
    min-width:100% !important;
    width:100%;
  }
  
  /* Buttons */
  .btn{
    padding:10px 14px;
    font-size:13px;
  }
  
  .btnRow{
    flex-direction:column;
  }
  
  .btnRow .btn{
    width:100%;
    justify-content:center;
  }
  
  /* Forms */
  .row{
    grid-template-columns:1fr !important;
  }
  
  .checks{
    grid-template-columns:1fr 1fr !important;
  }
  
  /* Sub tabs */
  .subTabs{
    flex-direction:column;
  }
  
  .subTab{
    width:100%;
    text-align:center;
  }
  
  /* Modals */
  .modal{
    max-width:95vw !important;
    width:95vw !important;
    max-height:85vh !important;
    border-radius:12px;
  }
  
  .modalBody{
    max-height:65vh !important;
    overflow:auto !important;
    -webkit-overflow-scrolling:touch;
  }
  
  .modalFoot{
    flex-wrap:wrap;
  }
  
  .modalFoot .btn{
    flex:1;
    min-width:calc(50% - 4px);
    justify-content:center;
  }
  
  /* Request focus grid */
  .reqFocusGrid{
    grid-template-columns:1fr !important;
  }
  
  /* Full-width views reset */
  #view-inventory{
    margin-left:0;
    margin-right:0;
  }
  
  #view-inventory .tableWrap{
    width:100%;
  }
  
  #view-transfer .tableWrap{
    width:100%;
    margin-left:0;
    margin-right:0;
  }
  
  /* Logs filters */
  #view-logs .body > div:first-child{
    flex-direction:column;
  }
  
  #view-logs .body > div:first-child > div{
    width:100%;
    min-width:100% !important;
  }
  
  /* Card title row */
  .cardTitleRow{
    flex-wrap:wrap;
    gap:8px;
  }
  
  .cardTitleRow h3{
    max-width:100%;
    font-size:14px;
  }
  
  /* Auth box */
  .authBox{
    margin:10px auto;
    padding:0 10px;
  }
  
  /* Toast */
  .toast{
    left:10px;
    right:10px;
    bottom:10px;
    max-width:none;
  }
  
  /* Topbar brand */
  .brand-title{
    font-size:13px;
  }
  
  .brand-sub{
    font-size:11px;
  }
  
  .pill{
    font-size:11px;
    padding:6px 8px;
  }
}

/* Small mobile: 480px */
@media (max-width:480px){
  .wrap{
    padding:8px;
    padding-top:56px;
  }
  
  #sidebarToggle{
    top:10px;
    right:10px;
    width:40px;
    height:40px;
    font-size:20px;
  }
  
  #mobileSidebar{
    width:260px;
  }
  
  .topbar{
    padding:10px;
    padding-right:56px;
    gap:8px;
  }
  
  .brand{
    gap:6px;
  }
  
  .dot{
    width:10px;
    height:10px;
  }
  
  .brand-title{
    font-size:12px;
  }
  
  .brand-sub{
    font-size:10px;
  }
  
  .right{
    gap:6px;
  }
  
  .pill{
    font-size:10px;
    padding:5px 7px;
  }
  
  .btn{
    padding:8px 10px;
    font-size:12px;
  }
  
  .card h3{
    font-size:13px;
    padding:10px;
  }
  
  .card .body{
    padding:10px;
  }
  
  label{
    font-size:11px;
  }
  
  input,select,textarea{
    padding:8px;
    font-size:13px;
  }
  
  .checks{
    grid-template-columns:1fr !important;
  }
  
  .checkItem{
    padding:8px;
  }
  
  .checkItem span{
    font-size:12px;
  }
  
  .dashKpi{
    padding:8px 10px;
  }
  
  .dashKpi span{
    font-size:12px;
  }
  
  .dashKpi b{
    font-size:16px;
  }
  
  .modal{
    max-width:98vw !important;
    width:98vw !important;
    border-radius:10px;
  }
  
  .modalHead{
    padding:10px 12px;
  }
  
  .modalHead h4{
    font-size:14px;
  }
  
  .modalBody{
    padding:10px;
  }
  
  .modalFoot{
    padding:10px;
  }
  
  .modalFoot .btn{
    min-width:100%;
  }
  
  thead th,
  tbody td{
    padding:5px 6px;
    font-size:11px;
  }
  
  .linkBtn{
    padding:6px 8px;
    font-size:11px;
  }
  
  .small{
    font-size:11px;
  }
  
  /* Focus bar adjustments */
  .focusBar{
    padding:8px 10px;
  }
  
  .reqFocus{
    padding:10px;
  }
}
</style>
<!-- ===== END MOBILE RESPONSIVE CSS ===== -->

</head>
<body>

<!-- ===== Mobile Sidebar Toggle Button (Added for Mobile Support) ===== -->
<button id="sidebarToggle" type="button" aria-label="فتح القائمة">☰</button>

<!-- ===== Mobile Sidebar Overlay (Added for Mobile Support) ===== -->
<div id="sidebarOverlay"></div>

<!-- ===== Mobile Sidebar (Added for Mobile Support) ===== -->
<nav id="mobileSidebar" aria-label="القائمة الرئيسية">
  <button id="sidebarClose" type="button" aria-label="إغلاق القائمة">✕</button>
  <div class="sidebarHeader">
    <div class="brand-title">مجموعة محمد بن ذعار العجمي للسيارات</div>
    <div class="brand-sub">Workflow</div>
  </div>
  <div class="sidebarNav" id="sidebarNavItems">
    <!-- Tabs will be cloned here by JS -->
  </div>
  <div class="sidebarAuth" id="sidebarAuthArea">
    <!-- Auth info cloned here by JS -->
  </div>
</nav>

<div class="wrap">
<div class="topbar">
<div class="brand">
<div class="dot"></div>
<div>
<div class="brand-title">مجموعة محمد بن ذعار العجمي للسيارات</div>
<div class="brand-sub">Workflow</div>
</div>
</div>
<div class="right">
<span class="pill" id="authPill">غير مسجل</span>
<button class="btn secondary hidden" id="btnLogout">تسجيل خروج</button>
</div>
</div>
<!-- LOGIN -->
<div class="authBox" id="authBox">
<div class="card">
<h3>تسجيل الدخول</h3>
<div class="body">
<div class="row">
<div>
<label>البريد الإلكتروني</label>
<input id="loginEmail" placeholder="example@company.com" type="email"/>
</div>
<div>
<label>كلمة المرور</label>
<input id="loginPass" placeholder="••••••••" type="password"/>
</div>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap">
<button class="btn primary" id="btnLogin">تسجيل الدخول</button>
<button class="btn secondary" id="btnReset">نسيت كلمة المرور</button>
</div>
<div class="small" style="margin-top:10px">يجب أن تكون مسجل داخل مشروع <b>mzj-workflow</b>.</div>
</div>
</div>
</div>
<!-- APP -->
<div class="hidden" id="app">
<div class="tabs">
<div aria-label="Tabs" class="tabbar" role="tablist">
<div class="tab" data-view="view-dashboard" role="tab">الداش بورد</div>
<div class="tab active" data-view="view-admin" role="tab">الإدارة</div>
<div class="tab" data-view="view-inventory" role="tab">قاعدة البيانات</div>
<div class="tab" data-view="view-transfer" role="tab">الحركة</div>
<div class="tab" data-view="view-requests" role="tab">طلبات النقل</div>
<div class="tab" data-view="view-allcars" role="tab">كل السيارات</div>
<div class="tab" data-view="view-logs" role="tab">سجل الحركات</div>
<div class="tab" data-view="view-tracking" role="tab">التراكينج</div>
<div class="tab" data-view="view-media" role="tab">Media</div>
<div class="tab" data-view="view-users" role="tab">إدارة المستخدمين</div>
</div>
<!-- الداش بورد -->
<div class="view" id="view-dashboard" role="tabpanel">
<!-- Saved View Filters -->
<div class="card">
<h3>الداش بورد</h3>
<div class="body">
<div class="dashFilters">
<div>
<label>المكان</label>
<select class="selWithAdd" id="dash_filter_location">
<option value="">— اختر —</option>
</select>
</div>
<div class="dashStatusBox">
<div class="small" style="margin-bottom:6px">الحالات (يمكن اختيار أكثر من حالة)</div>
<div class="dashChecks" id="dash_filter_statuses">
<label class="dashChk"><input type="checkbox" value="متاح للبيع"/> متاح للبيع</label>
<label class="dashChk"><input type="checkbox" value="حجز"/> حجز</label>
<label class="dashChk"><input type="checkbox" value="بها ملاحظات"/> بها ملاحظات</label>
<label class="dashChk"><input type="checkbox" value="مباع تحت التسليم"/> مباع تحت التسليم</label>
<label class="dashChk"><input type="checkbox" value="مباع تم التسليم"/> مباع تم التسليم</label>
</div>
</div>
<div class="dashFilterActions">
<button class="btn secondary" id="dash_filter_show">عرض</button>
<button class="btn primary" id="dash_filter_save">حفظ</button>
<button class="btn danger" id="dash_filter_clear">تفريغ</button>
</div>
</div>
<div class="small" id="dash_filter_meta" style="margin-top:10px">—</div>
</div>
</div>

<div class="dashGrid" style="margin-top:14px">
  <div id="dash_missing_saved_cards"></div>
  <div id="dash_total_stock_card"></div>
</div>
<!-- Cards -->
<div class="dashGrid">
<div id="dash_saved_cards"></div>


<div class="card dashCard">
<div class="cardTitleRow"><h3 id="dash_ap_title">كارت الموافقة المالية والإدارية</h3><div class="dashTitleTotal"><span>الإجمالي</span><span class="dashTotalBadge"><b id="dash_ap_total">—</b></span></div></div>
<div class="body">


<div class="dashKpis">
<div class="dashKpi"><span>ناقص موافقة مالية</span><b id="ap_need_fin">—</b></div>
<div class="dashKpi"><span>ناقص موافقة إدارية</span><b id="ap_need_adm">—</b></div>
<div class="dashKpi"><span>موافقات مكتملة</span><b id="ap_ready">—</b></div>
</div>
<div class="small" style="margin-top:10px">مربوط بالحالة: مباع تحت التسليم. الأرشفة تتم من <b>قاعدة البيانات</b> (من <b>erp_orders</b> / <b>orders</b>).</div>
</div>
</div>
<div class="card dashCard">
<div class="cardTitleRow"><h3 id="dash_req_title">طلبات النقل</h3><div class="dashTitleTotal"><span>الإجمالي</span><span class="dashTotalBadge"><b id="dash_req_total">—</b></span></div></div>
<div class="body">


<div class="dashKpis">
<div class="dashKpi"><span>تم استلام الطلب</span><b id="rq_s1">—</b></div>
<div class="dashKpi"><span>تم ارسال السيارة</span><b id="rq_s2">—</b></div>
<div class="dashKpi"><span>تم استلام السيارة</span><b id="rq_s3">—</b></div>
<div class="dashKpi"><span>تم الانتهاء</span><b id="rq_s4">—</b></div>
</div>
<div class="small" style="margin-top:10px">الأرشفة تتم من تاب قاعدة البيانات بعد اكتمال الطلب.</div>
</div>
</div>

<div class="card dashCard">
  <div class="cardTitleRow">
    <h3 id="dash_cs_title">نواقص السيارات</h3>
    <div class="dashTitleTotal">
      <span>الإجمالي</span>
      <span class="dashTotalBadge"><b id="dash_cs_total">—</b></span>
    </div>
  </div>
  <div class="body">
    <div class="dashKpis csKpis">
      <div class="dashKpi clickable" id="cs_btn_moltaqa"><span>الملتقى</span><b id="cs_cnt_moltaqa">—</b></div>
      <div class="dashKpi clickable" id="cs_btn_salah"><span>الصالة</span><b id="cs_cnt_salah">—</b></div>
      <div class="dashKpi clickable" id="cs_btn_qadisiyah"><span>القادسية</span><b id="cs_cnt_qadisiyah">—</b></div>
    </div>
    <div class="small" style="margin-top:10px">
      يتم الحساب على مستوى <b>تركيبات</b> (السيارة + البيان + الموديل + اللون الخارجي + اللون الداخلي). 
      لا يتم احتساب: حساسّات/كاميرا/شاشة/مسجل/ريموت/فرشات/طفاية/شنطة سلامة/اسبير.
    </div>
  </div>
</div>

<div class="card dashCard">
<div class="cardTitleRow"><h3 id="dash_trk_title">تتبع إجراءات البيع (Tracking)</h3><div class="dashTitleTotal"><span>الإجمالي</span><span class="dashTotalBadge"><b id="dash_trk_total">—</b></span></div></div>
<div class="body">

<div class="toolbar" style="margin:0">
  <div class="field" style="flex:1;min-width:240px">
    <label>بحث في طلبات التتبع</label>
    <input id="dash_trk_search" placeholder="رقم الطلب / اسم العميل / VIN / الجوال"/>
  </div>
  <button class="btn secondary" id="dash_trk_search_btn" type="button">بحث</button>
  <button class="btn secondary" id="dash_trk_show_all" type="button">عرض الكل</button>
</div>

<div class="dashBtns" style="margin-top:10px">
<button class="btn secondary" id="dash_trk_new">طلبات لم تبدأ (—)</button>
<button class="btn secondary" id="dash_trk_inprog">طلبات تحت الإجراء (—)</button>
<button class="btn secondary" id="dash_trk_done">طلبات مكتملة (—)</button>
</div>
<div class="small" style="margin-top:10px">يعرض الطلبات حسب المرحلة من orders.</div>
</div>
</div>
</div>
</div>
<!-- الإدارة -->
<div class="view active" id="view-admin" role="tabpanel">
<!-- Admin Sub Tabs -->
<div class="card">
<h3>الإدارة</h3>
<div class="body">
<div aria-label="تبويبات الإدارة" class="subTabs" role="tablist">
<button aria-selected="true" class="subTab active" data-sub="edit" id="adm_tab_edit" role="tab" type="button">تعديل</button>
<button aria-selected="false" class="subTab" data-sub="add" id="adm_tab_add" role="tab" type="button">إضافة سيارة</button>
<button aria-selected="false" class="subTab" data-sub="io" id="adm_tab_io" role="tab" type="button">استيراد / تصدير</button>
</div>
<!-- تعديل -->
<div class="subView" id="adm_view_edit" role="tabpanel">
<div class="small" style="margin-bottom:10px">اكتب رقم الهيكل (VIN) وسيتم جلب البيانات تلقائيًا، ثم عدّل واحفظ.</div>
<div class="btnRow">
<button class="btn primary" id="btnSave" type="button">حفظ</button>
<button class="btn secondary" id="btnClear" type="button">تفريغ</button>
</div>
<div class="row">
<div><label>الهيكل (VIN)</label><input id="f_vin" placeholder="VIN"/></div>
<div><label>السيارة</label><input id="f_car" placeholder="مثال: سوناتا"/></div>
</div>
<div class="row">
<div><label>البيان</label><input id="f_statement"/></div>
<div><label>الوكيل</label><input id="f_agent"/></div>
</div>
<div class="row">
<div><label>اللون الداخلي</label><input id="f_int"/></div>
<div><label>اللون الخارجي</label><input id="f_ext"/></div>
</div>
<div class="row">
<div><label>موديل</label><input id="f_model" placeholder="2025 / 2026"/></div>
<div><label>اللوحة</label><input id="f_plate"/></div>
</div>
<div class="row">
<div><label>اسم الدفعة بالتاريخ</label><input id="f_batch"/></div>
<div>
<label>المكان (الفرع)</label>
<select class="selWithAdd" id="f_location">
<option value="">— اختر —</option>
</select>
</div>
</div>
<div class="row">
<div>
<label>الحالة</label>
<select class="selWithAdd" id="f_status">
<option value="">— اختر —</option>
</select>
</div>
<div><label>ملاحظات في السيارة</label><input id="f_notesLoc"/></div>
</div>
<div class="row">
<div><label>حجز - نواقص - تحديد مكان</label><input id="f_notesMissing"/></div>
<div class="hidden" id="f_carNotes_box"><label>ملاحظات السيارات</label><input id="f_carNotes" placeholder="تُفتح عند الحالة: بها ملاحظات"/></div>
</div>
<div class="row">
<div class="span2">
<div style="margin:10px 0 8px;color:var(--brown);font-weight:900">التشيك</div>
<div class="checks">
<div class="checkItem"><span>فرشات</span><input id="c_farshat" type="checkbox"/></div>
<div class="checkItem"><span>طفاية</span><input id="c_tafaia" type="checkbox"/></div>
<div class="checkItem"><span>شنطة</span><input id="c_shanta" type="checkbox"/></div>
<div class="checkItem"><span>اسبير</span><input id="c_spare" type="checkbox"/></div>
<div class="checkItem"><span>ريموت</span><input id="c_remote" type="checkbox"/></div>
<div class="checkItem"><span>شاشة</span><input id="c_screen" type="checkbox"/></div>
<div class="checkItem"><span>مسجل</span><input id="c_recorder" type="checkbox"/></div>
<div class="checkItem"><span>مكيف</span><input id="c_ac" type="checkbox"/></div>
<div class="checkItem"><span>كاميرا</span><input id="c_camera" type="checkbox"/></div>
<div class="checkItem"><span>حساس</span><input id="c_sensors" type="checkbox"/></div>
</div>
</div>
</div>
<div class="row">
<div>
<label>الموافقة المالية</label>
<select id="a_financial">
<option value="">—</option>
<option value="true">نعم</option>
<option value="false">لا</option>
</select>
</div>
<div>
<label>الموافقة الإدارية</label>
<select id="a_admin">
<option value="">—</option>
<option value="true">نعم</option>
<option value="false">لا</option>
</select>
</div>
</div>
<div class="row">
<div class="span2">
<label>Tracking (اختياري)</label>
<input id="f_tracking" placeholder="رابط/كود تتبع (اختياري)">
</input></div>
</div>
<div class="small">المسار الموحد: <b>cars</b> فقط.</div>
</div>
<!-- إضافة سيارة -->
<div class="subView hidden" id="adm_view_add" role="tabpanel">
<div class="small" style="margin-bottom:10px">اكتب رقم الهيكل (VIN) وباقي البيانات ثم احفظ.</div>
<div class="btnRow">
<button class="btn primary" id="btnSaveNew" type="button">حفظ</button>
<button class="btn secondary" id="btnClearNew" type="button">تفريغ</button>
</div>
<div class="row">
<div><label>الهيكل (VIN)</label><input id="n_vin" placeholder="VIN"/></div>
<div><label>السيارة</label><input id="n_car" placeholder="مثال: سوناتا"/></div>
</div>
<div class="row">
<div><label>البيان</label><input id="n_statement"/></div>
<div><label>الوكيل</label><input id="n_agent"/></div>
</div>
<div class="row">
<div><label>اللون الداخلي</label><input id="n_int"/></div>
<div><label>اللون الخارجي</label><input id="n_ext"/></div>
</div>
<div class="row">
<div><label>موديل</label><input id="n_model" placeholder="2025 / 2026"/></div>
<div><label>اللوحة</label><input id="n_plate"/></div>
</div>
<div class="row">
<div><label>اسم الدفعة بالتاريخ</label><input id="n_batch"/></div>
<div>
<label>المكان (الفرع)</label>
<select class="selWithAdd" id="n_location">
<option value="">— اختر —</option>
</select>
</div>
</div>
<div class="row">
<div>
<label>الحالة</label>
<select class="selWithAdd" id="n_status">
<option value="">— اختر —</option>
</select>
</div>
<div><label>ملاحظات في السيارة</label><input id="n_notesLoc"/></div>
</div>
<div class="row">
<div><label>حجز - نواقص - تحديد مكان</label><input id="n_notesMissing"/></div>
<div class="hidden" id="n_carNotes_box"><label>ملاحظات السيارات</label><input id="n_carNotes" placeholder="تُفتح عند الحالة: بها ملاحظات"/></div>
</div>
<div class="row">
<div class="span2">
<div style="margin:10px 0 8px;color:var(--brown);font-weight:900">التشيك</div>
<div class="checks">
<div class="checkItem"><span>فرشات</span><input id="n_farshat" type="checkbox"/></div>
<div class="checkItem"><span>طفاية</span><input id="n_tafaia" type="checkbox"/></div>
<div class="checkItem"><span>شنطة</span><input id="n_shanta" type="checkbox"/></div>
<div class="checkItem"><span>اسبير</span><input id="n_spare" type="checkbox"/></div>
<div class="checkItem"><span>ريموت</span><input id="n_remote" type="checkbox"/></div>
<div class="checkItem"><span>شاشة</span><input id="n_screen" type="checkbox"/></div>
<div class="checkItem"><span>مسجل</span><input id="n_recorder" type="checkbox"/></div>
<div class="checkItem"><span>مكيف</span><input id="n_ac" type="checkbox"/></div>
<div class="checkItem"><span>كاميرا</span><input id="n_camera" type="checkbox"/></div>
<div class="checkItem"><span>حساس</span><input id="n_sensors" type="checkbox"/></div>
</div>
</div>
</div>
<div class="row">
<div>
<label>الموافقة المالية</label>
<select id="n_financial">
<option value="">—</option>
<option value="true">نعم</option>
<option value="false">لا</option>
</select>
</div>
<div>
<label>الموافقة الإدارية</label>
<select id="n_admin">
<option value="">—</option>
<option value="true">نعم</option>
<option value="false">لا</option>
</select>
</div>
</div>
<div class="row">
<div class="span2">
<label>Tracking (اختياري)</label>
<input id="n_tracking" placeholder="رابط/كود تتبع (اختياري)">
</input></div>
</div>
<div class="small">المسار الموحد: <b>cars</b> فقط.</div>
</div>
<!-- استيراد / تصدير -->
<div class="subView hidden" id="adm_view_io" role="tabpanel">
<div class="btnRow">
<button class="btn secondary" id="btnTemplate" type="button">تصدير قالب فاضي</button>
<button class="btn secondary" id="btnExportAll" type="button">تصدير البيانات</button>
<button class="btn primary" id="btnImport" type="button">استيراد من شيت</button>
</div>
<div class="small" style="margin-top:10px">
                  الاستيراد يدعم 3 اختيارات: <b>استبدال كامل</b> / <b>إضافة فوق الحالي</b> / <b>تحديث من الشيت</b>.
                  <br/>الهيكل (VIN) هو المفتاح.
                </div>
</div>
</div>
</div>
</div>
<!-- المخزون -->
<div class="view" id="view-inventory" role="tabpanel">
<div class="card">
<h3>المخزون (قراءة فقط)</h3>
<div class="body">
<div class="toolbar">
<div class="field" style="flex:1">
<label>بحث عام</label>
<input id="inv_search" placeholder="ابحث بالهيكل/السيارة/الوكيل/اللوحة/المكان...">
</input></div>
<div class="field">
<label>الفرع (المكان)</label>
<select id="inv_location">
<option value="">الكل</option>
</select>
</div>
<div class="field">
<label>الحالة</label>
<select id="inv_status">
<option value="">الكل</option>
<option value="مباع تحت التسليم">مباع تحت التسليم</option>
<option value="متاح للبيع">متاح للبيع</option>
<option value="حجز">حجز</option>
<option value="مباع تم التسليم">مباع تم التسليم</option>
<option value="بها ملاحظات">بها ملاحظات</option>
<option value="مؤرشف">أرشيف</option>
</select>
</div>
<div class="field">
<label>الأرشيف</label>
<select id="inv_archive">
<option selected="" value="active">المخزون</option>
<option value="archived">المؤرشف</option>
<option value="all">الكل</option>
</select>
</div>
<div class="field">
<label>الموديل</label>
<select id="inv_model">
<option value="">الكل</option>
</select>
</div>
<div>
<button class="btn secondary" id="inv_export">تصدير النتائج</button>
</div>
</div>
<div class="small" style="margin-bottom:10px">
                يعرض: VIN, السيارة, البيان, الوكيل, الألوان, الموديل, اللوحة, الدفعة, المكان, الملاحظات, الحالة, ملاحظات السيارات, Tracking + زر عرض المزيد.
              </div>
<div class="tableWrap">
<table id="inv_table">
<thead>
<tr>
<th>الهيكل (VIN)</th>
<th>السيارة</th>
<th>البيان</th>
<th>الوكيل</th>
<th>اللون الداخلي</th>
<th>اللون الخارجي</th>
<th>موديل</th>
<th>اللوحة</th>
<th>اسم الدفعة بالتاريخ</th>
<th>المكان</th>
<th>ملاحظات في السيارة</th>
<th>حجز - نواقص - تحديد مكان</th>
<th>الحالة</th>
<th>Tracking</th>
<th>الموافقات</th>
<th>التشيك</th>
<th>طلبات النقل</th>
<th>الأرشيف</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="inv_meta" style="margin-top:10px">—</div>
</div>
</div>
</div>
<!-- نقل السيارات -->
<div class="view" id="view-transfer" role="tabpanel">
<div class="grid">
<div class="card">
<h3>إنشاء حركة (أكثر من سيارة إلى مكان واحد)</h3>
<div class="body">
<div class="toolbar" style="margin-bottom:8px">
<div class="field" style="min-width:unset">
<button class="btn secondary" id="tr_addRow">➕ إضافة سيارة</button>
<button class="btn danger" id="tr_clearRows">تفريغ القائمة</button>
</div>
</div>
<div class="focusBar">
<div class="row">
<div>
<label>المكان المستهدف</label>
<select class="selWithAdd" id="tr_to">
<option value="">— اختر —</option>
</select>
</div>
<div>
<label>الحالة</label>
<select class="selWithAdd" id="tr_status">
<option value="">— اختر —</option>
</select>
</div>
<div>
<label>حجز - نواقص - تحديد مكان</label>
<textarea id="tr_notesMissing" placeholder="اكتب ملاحظات الحجز أو النواقص..." rows="2" style="min-width:260px"></textarea>
</div>

<div class="hidden" id="tr_agency_box" style="margin-top:10px">
  <div class="card" style="margin:0">
    <h3 style="margin-bottom:10px">التشييك + اللون الداخلي (للـوكالة فقط)</h3>
    <div class="body">
      <div class="row" style="gap:12px;flex-wrap:wrap">
        
      <div style="flex:1;min-width:240px">
        <label>اختر رقم الهيكل للتشييك</label>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <select id="tr_agency_vin_select" style="flex:1;min-width:240px">
            <option value="">اختر رقم الهيكل</option>
          </select>
        </div>
      </div>

        <div style="flex:1;min-width:240px">
          <label>اللون الداخلي</label>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <select id="tr_int_color" style="min-width:200px">
              <option value="">— اختر —</option>
            </select>
            <button type="button" class="btn secondary" id="tr_add_int_color">إضافة لون داخلي</button>
          </div>
          <div id="tr_int_color_add_wrap" class="hidden" style="margin-top:8px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="tr_int_color_new" placeholder="اكتب اللون الداخلي..." style="min-width:220px"/>
            <button type="button" class="btn primary" id="tr_save_int_color">حفظ</button>
            <button type="button" class="btn secondary" id="tr_cancel_int_color">إلغاء</button>
          </div>
          <div class="small muted" style="margin-top:6px">يظهر هذا القسم فقط إذا كان المكان الحالي: الوكالة</div>
        </div>
      </div>

      <div class="row" style="gap:12px;flex-wrap:wrap;margin-top:10px">
        <div style="flex:1;min-width:260px">
          <label>قائمة التشييك (نعم/لا)</label>
          <div id="tr_checklist_grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:10px">
            <!-- filled by JS -->
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="hidden" id="tr_note_box">
<label>ملاحظة (مطلوبة عند اختيار: سيارات بها ملاحظات)</label>
<input id="tr_note" placeholder="اكتب الملاحظة هنا...">
</input></div>
</div>
</div>
<div class="tableWrap" id="tr_tableWrap" style="max-height:260px;margin-bottom:10px">
<table id="tr_vinTable">
<thead>
<tr>
<th style="min-width:220px">الهيكل (VIN)</th>
<th>السيارة</th>
<th>المكان الحالي</th>
<th>الحالة</th>
<th class="dashNotesCol">ملاحظات</th>
<th>الموافقات</th>
<th>حذف</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
<button class="btn primary" id="tr_submit">تنفيذ الحركة</button>
</div>
<div class="small" id="tr_hint" style="margin-top:10px">
                  المسموح بالحركة: <b>الادارة / اداري</b>. سيتم تسجيل آخر الحركات مع البريد المنفذ.
                
            <div class="card" style="margin-top:14px">
<h3>سجل آخر الحركات</h3>
<div class="body">
<div class="tableWrap" style="max-height:360px">
<table id="log_table">
<thead>
<tr>
<th>نوع الطلب</th>
<th>رقم الهيكل</th>
<th>من</th>
<th>إلى</th>
<th>ملاحظات</th>
<th>المستخدم</th>
<th>نوع الحركة</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="log_meta" style="margin-top:8px">آخر الحركات: 0</div>
</div>
</div>
</div>
</div>
</div>
<div class="small" id="tr_meta" style="margin-top:10px">—</div>
</div>
</div>
</div>
</div>
</div>





<!-- الطلبات -->
<div class="view" id="view-requests" role="tabpanel">
<div class="card">
<h3>طلبات النقل</h3>
<div class="body">
<div class="reqFocus" id="req_focusbar">
<div class="reqFocusGrid">
<div>
<label>اختر القسم</label>
<select id="req_mode">
<option value="create">إنشاء طلب</option>
<option value="track">متابعة الطلبات</option>
<option value="done">الطلبات المكتملة</option>
</select>
</div>
<div class="reqOnlyCreate">
<label>نوع الطلب</label>
<select id="req_type">
<option value="transfer">نقل</option>
<option value="photo">تصوير</option>
</select>
</div>
<div class="reqOnlyCreate">
<label id="req_loc_label">مكان النقل</label>
<select class="selWithAdd" id="req_to">
<option value="">— اختر —</option>
</select>
</div>
<div class="hidden reqOnlyCreate" id="req_photo_date_box">
<label>تاريخ التصوير</label>
<input id="req_photo_date" type="date">
</input></div>
</div>
<div class="small" style="margin-top:8px">اختار القسم + نوع الطلب + مكان النقل + تاريخ التصوير (لو تصوير) ثم اكتب أرقام الهياكل.</div>
</div>
<!-- إنشاء طلب -->
<div id="req_create_box">
<div class="toolbar" style="margin-bottom:8px">
<div class="field" style="min-width:unset">
<button class="btn secondary" id="req_addRow">➕ إضافة رقم هيكل</button>
<button class="btn danger" id="req_clearRows">تفريغ القائمة</button>
</div>
</div>
<div class="tableWrap" style="max-height:320px;margin-bottom:10px">
<table id="req_vinTable">
<thead>
<tr>
<th style="min-width:220px">رقم الهيكل (VIN)</th>
<th>السيارة</th>
<th>الفئة</th>
<th>الخارجي</th>
<th>الداخلي</th>
<th>الموديل</th>
<th>المكان الحالي</th>
<th>حذف</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
<button class="btn primary" id="req_submit">إرسال الطلب</button>
</div>
<div class="small" id="req_create_hint" style="margin-top:10px">—</div>
</div>
<!-- متابعة الطلبات -->
<div class="hidden" id="req_track_box">
<div class="small" style="margin-bottom:10px">يعرض الطلبات غير المكتملة فقط.</div>
<div class="tableWrap" style="max-height:520px">
<table id="req_table_open">
<thead>
<tr>
<th>التاريخ</th>
<th>النوع</th>
<th>عدد الهياكل</th>
<th>من</th>
<th>المكان المستهدف</th>
<th>فتح</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="req_open_meta" style="margin-top:10px">—</div>
</div>
<!-- الطلبات المكتملة -->
<div class="hidden" id="req_done_box">
<div class="small" style="margin-bottom:10px">يعرض الطلبات المكتملة فقط.</div>
<div class="tableWrap" style="max-height:520px">
<table id="req_table_done">
<thead>
<tr>
<th>التاريخ</th>
<th>النوع</th>
<th>عدد الهياكل</th>
<th>من</th>
<th>المكان المستهدف</th>
<th>اكتمل</th>
<th>فتح</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="req_done_meta" style="margin-top:10px">—</div>
</div>
</div>
</div>
</div>
<!-- كل السيارات -->
<div class="view" id="view-allcars" role="tabpanel">
<div class="card">
<h3>كل السيارات</h3>
<div class="body">
<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:10px">
<div class="small">التجميع حسب (السيارة + البيان + الموديل) مع إجمالي العدد.</div>
<button class="btn secondary" id="btnExportAllCars">تصدير Excel</button>
</div>
<div class="tableWrap" style="padding:0">
<table id="allCarsTable">
<thead>
<tr>
<th style="width:60px">#</th>
<th>السيارة</th>
<th>البيان</th>
<th>الموديل</th>
<th style="width:140px">إجمالي العدد</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="allCarsMeta" style="margin-top:8px">—</div>
</div>
</div>
</div>
<!-- سجل الحركات -->
<div class="view" id="view-logs" role="tabpanel">
<div class="card">
<h3>سجل الحركات</h3>
<div class="body">
<div style="display:flex;gap:10px;flex-wrap:wrap;align-items:end">
<div style="min-width:160px">
<div class="small">من تاريخ</div>
<input class="input" id="lg_from" type="date">
</input></div>
<div style="min-width:160px">
<div class="small">إلى تاريخ</div>
<input class="input" id="lg_to" type="date">
</input></div>
<div style="min-width:160px">
<div class="small">فلترة</div>
<select class="input" id="lg_filter">
<option value="all">الكل</option>
<option value="vin">رقم الهيكل</option>
<option value="car">السيارة</option>
<option value="from">من</option>
<option value="to">إلى</option>
</select>
</div>
<div id="lg_search_box" style="min-width:220px">
<div class="small">بحث</div>
<input class="input" id="lg_search" placeholder="اكتب رقم الهيكل أو اسم السيارة">
</input></div>
<div class="hidden" id="lg_from_box" style="min-width:260px">
<div class="small">اختار المكان (من)</div>
<select class="input" id="lg_from_loc"></select>
</div>
<div class="hidden" id="lg_to_box" style="min-width:260px">
<div class="small">اختار المكان (إلى)</div>
<select class="input" id="lg_to_loc"></select>
</div>
<button class="btn primary" id="lg_apply">عرض</button>
<button class="btn secondary" id="lg_export">تصدير Excel</button>
<select class="input" id="lg_paper" style="width:120px;min-width:120px">
<option selected="" value="A3">A3</option>
</select>
<button class="btn secondary" id="lg_pdf">تصدير PDF</button>
</div>
<div style="margin-top:12px;overflow:auto">
<table class="table" id="lg_table">
<thead>
<tr>
<th>رقم الهيكل (VIN)</th>
<th>السيارة</th>
<th>البيان</th>
<th>الوكيل</th>
<th>اللون الداخلي</th>
<th>اللون الخارجي</th>
<th>موديل</th>
<th>اللوحة</th>
<th>اسم الدفعة بالتاريخ</th>
<th>التاريخ</th>
<th>المكان</th>
<th>ملاحظات في السيارة</th>
<th>حجز - نواقص - تحديد مكان</th>
<th>الحالة</th>
<th>حساس</th>
<th>كاميرا</th>
<th>مكيف</th>
<th>مسجل</th>
<th>شاشة</th>
<th>ريموت</th>
<th>فرشات</th>
<th>طفاية</th>
<th>شنطة سلامة</th>
<th>اسبير</th>
<th>الموافقة المالية</th>
<th>الموافقة الادارية</th>
<th>منفذ الحركة</th>
<th>نوع الحركة</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>
<div class="small" id="lg_meta" style="margin-top:10px">—</div>
</div>
</div>
</div>
<!-- Import Modal -->
<div class="modalBackdrop" id="importModal">
<div aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<h4>استيراد من شيت</h4>
<button class="btn secondary" id="closeImport">إغلاق</button>
</div>
<div class="modalBody">
<label>اختر ملف Excel</label>
<input accept=".xlsx,.xls" id="importFile" type="file">
<div style="margin-top:10px">
<label>نوع الاستيراد</label>
<select id="importMode">
<option value="replace">استبدال كامل (مسح القديم + إضافة الجديد)</option>
<option value="append">إضافة فوق الحالي (بدون مسح)</option>
<option value="update">تحديث من الشيت (تعديل الموجود فقط)</option>
</select>
</div>
<div class="small" id="importPreview" style="margin-top:10px">—</div>
</input></div>
<div class="modalFoot">
<button class="btn primary" disabled="" id="runImport">تنفيذ الاستيراد</button>
<button class="btn danger" id="clearImport">تفريغ</button>
</div>
</div>
</div>
<!-- DETAILS MODAL (Checklist + Approvals) -->
<div class="modalBackdrop" id="detailsModal">
<div aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<h4>عرض المزيد</h4>
<button class="btn secondary" id="detailsClose">إغلاق</button>
</div>
<div class="modalBody" id="detailsBody"></div>
</div>
</div>
<!-- REQUEST DETAILS MODAL -->
<div class="modalBackdrop" id="reqModal">
<div aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<h4 id="reqModalTitle">تفاصيل الطلب</h4>
<button class="btn secondary" id="reqClose">إغلاق</button>
</div>
<div class="modalBody" id="reqModalBody"></div>
<div class="modalFoot" id="reqModalFoot"></div>
</div>
</div>
<div class="toast" id="toast"></div>
<!-- Dashboard Data Modal -->
<div class="modalBackdrop" id="dashDataModal">
<div aria-modal="true" class="modal" role="dialog">
<div class="modalHead">
<h4 id="dashDataTitle">عرض البيانات</h4>
<button class="btn secondary" id="dashDataClose">إغلاق</button>
</div>
<div class="modalBody">
<div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
<div class="field" style="flex:1;min-width:220px">
<label>بحث</label>
<input autocomplete="off" id="dashDataSearch" placeholder="ابحث بـ VIN / السيارة / البيان / المكان / الحالة">
</input></div>
<div class="field" style="min-width:200px">
<label> </label>
<button class="btn" id="dashDataExport">تصدير Excel</button>
</div>
</div>
<div class="muted" id="dashDataMeta" style="margin-bottom:10px"></div>
<div style="overflow:auto;max-height:70vh;border:1px solid var(--line);border-radius:12px;background:#fff">
<table class="table" style="min-width:1100px">
<thead>
<tr>
<th>(VIN) الهيكل</th>
<th>السيارة</th>
<th>البيان</th>
<th>موديل</th>
<th>الوكيل</th>
<th>الداخلي</th>
<th>الخارجي</th>
<th>المكان</th>
<th>الحالة</th>
<th class="dashNotesCol">ملاحظات</th>
<th>الموافقات</th>
</tr>
</thead>
<tbody id="dashDataBody"></tbody>
</table>
</div>
</div>

<!-- Missing Branches Modal -->

<div class="modalBackdrop" id="missingModal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="titleWrap">
        <h4 id="missingTitle">نواقص الفروع</h4>
        <div class="subMeta" id="missingSubMeta">—</div>
      </div>
      <button class="btn secondary" id="missingClose">إغلاق</button>
    </div>
    <div class="modalBody" style="padding:0">
      <div class="mbToolbar">
        <div class="field">
          <label>بحث</label>
          <input autocomplete="off" id="missingSearch" placeholder="ابحث بـ السيارة / البيان / الألوان / الموديل"></input>
        </div>
        <div class="mbActions">
          <div class="mbPill"><span>النتائج:</span> <span class="num" id="missingCount">0</span></div>
          <button class="btn" id="missingExport">تصدير Excel</button>
        </div>
      </div>

      <div class="mbTableWrap">
        <table class="table">
          <thead>
            <tr>
              <th>السيارة</th>
              <th>البيان</th>
              <th>اللون الداخلي</th>
              <th>اللون الخارجي</th>
              <th>الموديل</th>
              <th>عدد الفرع</th>
              <th>الإجمالي العام</th>
            </tr>
          </thead>
          <tbody id="missingBody"></tbody>
        </table>
      </div>

      <div class="muted" id="missingMeta" style="padding:0 14px 14px"></div>
    </div>
  </div>
</div>
</div>

</div>


<!-- Car Shortages Modal -->
<div class="modalBackdrop" id="carShortageModal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <div class="titleWrap">
        <h4 id="carShortageTitle">نواقص السيارات</h4>
        <div class="subMeta" id="carShortageSubMeta">—</div>
      </div>
      <button class="btn secondary" id="carShortageClose">إغلاق</button>
    </div>
    <div class="modalBody" style="padding:0">
      <div class="mbToolbar">
        <div class="field">
          <label>بحث</label>
          <input autocomplete="off" id="carShortageSearch" placeholder="ابحث بـ السيارة / البيان / الألوان / الموديل"></input>
        </div>
        <div class="mbActions">
          <div class="mbPill"><span>النتائج:</span> <span class="num" id="carShortageCount">0</span></div>
          <button class="btn" id="carShortageExport">تصدير Excel</button>
        </div>
      </div>

      <div class="mbTableWrap">
        <div id="carShortageTableWrap" style="overflow:auto;max-height:60vh;border:1px solid var(--line);border-radius:12px;background:#fff;margin:14px;"><table class="table">
          <thead>
            <tr>
              <th style="position:sticky;top:0;background:#fff;z-index:1">السيارة</th>
              <th style="position:sticky;top:0;background:#fff;z-index:1">البيان</th>
              <th style="position:sticky;top:0;background:#fff;z-index:1">الموديل</th>
              <th style="position:sticky;top:0;background:#fff;z-index:1">اللون الخارجي</th>
              <th style="position:sticky;top:0;background:#fff;z-index:1">اللون الداخلي</th>
              <th style="position:sticky;top:0;background:#fff;z-index:1">الإجمالي الفعلي</th>
            </tr>
          </thead>
          <tbody id="carShortageBody"></tbody>
        </table></div>
      </div>

      <div class="muted" id="carShortageMeta" style="padding:0 14px 14px"></div>
    </div>
  </div>
</div>

<!-- Dashboard Missing Branches Config Modal -->
<div class="modalBackdrop" id="dashMissingCfgModal">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="modalHead">
      <h4>إعدادات كارت نواقص الفروع</h4>
      <button class="btn secondary" id="dashMissingCfgClose">إغلاق</button>
    </div>
    <div class="modalBody">
      <div class="small" style="margin-bottom:8px">اختر الفروع التي تريد ظهورها داخل كارت نواقص الفروع.</div>
      <div class="dashStatusBox">
        <div class="small" style="margin-bottom:6px">الفروع (يمكن اختيار أكثر من فرع)</div>
        <div class="dashChecks" id="dash_missing_branches"><!-- تُحمّل تلقائيًا --></div>
      </div>
      <div class="small" id="dash_missing_meta" style="margin-top:10px">—</div>
    </div>
    <div class="modalFoot">
      <button class="btn primary" id="dash_missing_save">حفظ</button>
      <button class="btn danger" id="dash_missing_clear">تفريغ</button>
    </div>
  </div>
</div>

<!-- التراكينج -->
<div class="view" id="view-tracking" role="tabpanel">
<div class="card" style="padding:16px;">
<iframe id="trackingFrame" loading="lazy" style="width:100%; height:calc(100vh - 260px); border:0; border-radius:12px; background:transparent;" title="Tracking"></iframe>
<!-- محتوى التراكينج (يُحقن داخل الـ iframe لتجنب مشاكل GitHub مع srcdoc الطويل) -->
<template id="trackingSrc">
<!DOCTYPE html>

<html dir="rtl" lang="ar">
<head>
<link href="assets/favicon.png" rel="icon" type="image/x-icon"/>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>MZJ – تتبع المبيعات</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&amp;display=swap" rel="stylesheet">
<style>
    :root{
      --brown:#3e2420;
      --beige:#bc8f74;
      --cream:#fff8ef;
      --text:#111827;
      --muted:#6b7280;
      --radius:16px;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Tajawal",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:radial-gradient(circle at top,#fffdf8 0,#fff3e6 40%,#fbe9da 70%,#f5e3d3 100%);
      color:var(--text);
    }
    .topbar{
      background:var(--brown);
      color:#fff;
      padding:10px 20px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 6px 14px rgba(0,0,0,.2);
    }
    .topbar-title{
      font-weight:800;
      letter-spacing:.6px;
      font-size:17px;
    }
    .topbar-right{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
    }
    .logout{
      border:0;
      padding:6px 12px;
      border-radius:999px;
      background:#fff;
      color:var(--brown);
      cursor:pointer;
      font-family:inherit;
      font-size:12px;
    }
    .wrap{
      max-width:1150px;
      margin:22px auto 36px;
      padding:0 14px;
    }
    .card{
      background:#fff;
      border-radius:var(--radius);
      box-shadow:0 16px 40px rgba(62,36,32,.13);
      padding:18px 18px 20px;
      margin-bottom:18px;
    }
    .title{
      margin:0 0 12px 0;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--brown);
      font-size:18px;
    }
    .title .icon{
      width:26px;
      height:26px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      font-size:16px;
    }
    .row{
      display:grid;
      grid-template-columns:repeat(12,1fr);
      gap:10px;
    }
    .col-3{grid-column:span 3;}
    .col-4{grid-column:span 4;}
    .col-6{grid-column:span 6;}
    .col-12{grid-column:span 12;}
    label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      color:var(--muted);
    }
    input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
    }
    input:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-family:inherit;
      font-size:14px;
      outline:none;
      appearance:none;
    }
    select:focus{
      background:#fff;
      border-color:var(--beige);
      box-shadow:0 0 0 1px rgba(188,143,116,.45);
    }
    .btn{
      border:0;
      border-radius:999px;
      padding:8px 16px;
      font-family:inherit;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:14px;
      background:var(--brown);
      color:#fff;
    }
    .btn-outline{
      border-radius:999px;
      border:1px solid var(--brown);
      padding:8px 14px;
      font-family:inherit;
      cursor:pointer;
      background:transparent;
      color:var(--brown);
      font-size:13px;
    }
    .btn:disabled,.btn-outline:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .muted{color:var(--muted);font-size:13px;}
    .hint{color:var(--muted);font-size:12px;margin-top:4px;}
    .ok{color:#047857;font-weight:700;}
    .err{color:#b91c1c;font-weight:700;}
    .badge{
      display:inline-block;
      padding:3px 9px;
      border-radius:999px;
      background:rgba(188,143,116,.16);
      color:var(--brown);
      font-size:11px;
      margin-left:4px;
    }
    .erp-table-wrap{
      margin-top:8px;
      overflow-x:auto;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    thead{
      background:#f3f4f6;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      white-space:nowrap;
    }
    th{font-weight:600;color:#374151;text-align:right;}
    td{color:#111827;}
    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .stage{
      background:#fffaf3;
      border-radius:12px;
      padding:10px 12px;
      border:1px dashed rgba(188,143,116,.55);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .stage.done{
      background:#ecfdf5;
      border-style:solid;
      border-color:#22c55e;
    }
    .stage-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .stage strong{color:var(--brown);font-size:13px;}
    .stage small{font-size:11px;color:var(--muted);}

    .tabs{
      display:none;
      margin:-8px 0 10px;
      gap:8px;
    }
    .tab-btn{
      padding:6px 14px;
      border-radius:999px;
      border:1px solid transparent;
      background:#f3f4f6;
      color:#374151;
      font-size:13px;
      cursor:pointer;
      font-family:inherit;
    }
    .tab-btn.tab-active{
      background:var(--brown);
      color:#fff;
      border-color:var(--brown);
    }
    .link-btn{
      border:0;
      background:none;
      color:#1d4ed8;
      text-decoration:underline;
      cursor:pointer;
      font-size:13px;
      font-family:inherit;
      padding:0;
    }

    /* Orders list: unread (not opened yet) rows */
    .unread-row td{font-weight:800;}
    .unread-row td .link-btn{font-weight:900;}

    .totals-box{
      margin:6px 0 10px;
      padding:8px 10px;
      border-radius:10px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.4);
      font-size:13px;
      color:var(--brown);
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .totals-box span{
      white-space:nowrap;
    }

    /* VIN picker box احترافي */
    .vin-box{
      display:none;
      margin:10px 0 14px;
      padding:10px 12px;
      border-radius:12px;
      background:#fffaf3;
      border:1px solid rgba(188,143,116,.6);
    }
    .vin-box-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .vin-box-title{
      font-size:13px;
      font-weight:600;
      color:var(--brown);
    }
    .vin-chip{
      padding:3px 10px;
      border-radius:999px;
      background:rgba(62,36,32,.06);
      font-size:11px;
      color:var(--muted);
    }

    @media(max-width:900px){
      .row{grid-template-columns:1fr;}
      .col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
      .grid-2{grid-template-columns:1fr;}
      .topbar{flex-direction:column;align-items:flex-start;gap:6px;}
      .tabs{flex-wrap:wrap;}
    }
  
/* ===== Admin-like Topbar overrides for Sales ===== */
.topbar{
  position:sticky;
  top:0;
  z-index:1000;
  background:#fff;
  border-bottom:1px solid var(--line, #e5e7eb);
  color:var(--text);
  padding:0; /* override sales padding */
  box-shadow:none; /* override sales shadow */
}
.topbar-inner{
  max-width:1240px;
  margin:auto;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:10px 16px;
  gap:12px;
}
.brand{display:flex;align-items:center;gap:10px}
.brand .logo{
  width:36px;height:36px;border-radius:10px;
  background:linear-gradient(135deg,var(--brown),#2a1613);
  display:grid;place-items:center;color:#fff;font-weight:800;
}
.brand-text h1{margin:0;font-size:18px;color:var(--brown);font-weight:800;line-height:1.1}
.brand-text .hint{color:var(--muted);font-size:12px}

/* Tabs (keep original sales .tabs for page content untouched, target only in topbar) */
.topbar .tabs{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-start}
.topbar .tab{
  padding:8px 12px;
  border:1px solid var(--line, #e5e7eb);
  border-radius:999px;
  background:#fff;
  text-decoration:none;
  color:var(--text);
  font-weight:800;
  font-size:13px;
}
.topbar .tab.active{background:var(--brown);border-color:var(--brown);color:#fff}

/* Right side actions (avoid .row conflict in sales page) */
.topbar-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
.status-badge{
  display:inline-flex;gap:8px;align-items:center;
  border:1px solid var(--line, #e5e7eb);
  background:#fff;border-radius:12px;padding:6px 10px;font-size:12px
}
.dot{width:10px;height:10px;border-radius:999px;background:#f59e0b}
.dot.ok{background:var(--ok, #16a34a)} .dot.err{background:var(--danger, #ef4444)} .dot.warn{background:#f59e0b}
.whoami{color:var(--muted);font-size:12px;font-weight:700}

/* Button style like admin */
.tb-btn{
  border:1px solid var(--line, #e5e7eb);
  background:#fff;
  border-radius:12px;
  padding:8px 12px;
  cursor:pointer;
  font-weight:800;
  font-size:13px;
}
.tb-btn:hover{transform:translateY(-1px)}
.tb-btn:active{transform:translateY(0)}

@media (max-width:900px){
  .topbar-inner{align-items:flex-start;flex-direction:column}
  .topbar-actions{justify-content:flex-start}
}


/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<link href="./mzj-ui.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<style>
  /* ===== Sales Safe Refactor: hide legacy topbar ONLY (keep #tabsBar visible) ===== */
  .legacy-sales .topbar,
  .legacy-sales .topbar .tabs,
  .legacy-sales .nav-tabs,
  .legacy-sales .header,
  .legacy-sales header:not(.mzj-topbar){display:none !important;}

  /* Keep content spacing nice */
  .legacy-sales{padding-top: 6px;}

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<style>
  /* Ensure the functional tabs bar (بحث عن طلب / كل الطلبات) is visible when JS enables it */
  .legacy-sales #tabsBar{ display:flex !important; }
  .legacy-sales #tabsBar[style*="display: none"]{ display:none !important; } /* respect JS when it hides */

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<style>
/* Embedded in Workflow Dashboard (Tracking Tab) */
html,body{height:100%;}
body{background:transparent !important;}
/* FIX: remove embedded sales chrome + prevent max-width causing empty space */
.topbar, header, .pagehead, .breadcrumb, .mzj-topbar{display:none !important;}
.wrap{max-width:none !important; margin:0 !important; padding:16px !important;}
/* ensure content uses full width inside iframe */
.legacy-sales, .legacy, .mzj-content{width:100% !important; max-width:none !important;}
/* avoid weird horizontal blank space */
body{overflow-x:hidden !important;}

/* safety: hide any leftover global chrome */
.mzj-topbar,.mzj-sidebar,.mzj-pagehead,#mzjSidebar,#mzjSidebarBtn,.mzj-breadcrumb{display:none !important;}
.mzj-content{padding:0 !important; margin:0 !important;}
.legacy{padding:0 !important; margin:0 !important;}

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
<style>
html, body {
  direction: rtl;
  text-align: right;
}

/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style>
</link></link></link></head>
<body class="mzj">
<!-- MZJ Unified Topbar -->
<div class="mzj-shell" id="mzjShell">
<main class="mzj-content">
<div class="legacy legacy-sales">
<!-- Topbar (Matched with Admin) -->
<div class="topbar">
<div class="topbar-inner">
<div class="brand">
<div class="logo" title="MZJ">MZJ</div>
<div class="brand-text">
<h1>لوحة تتبع المبيعات</h1>
<small class="hint">مجموعة محمد بن ذعار العجمي للسيارات</small>
</div>
</div>
<div class="tabs">
<a class="tab" href="admin.html">الإدارة</a>
<a class="tab active" href="sales.html">المبيعات</a>
<a class="tab" href="inventory.html">المخزون</a>
<a class="tab" href="dashboard.html">الداش بورد</a>
<a class="tab" href="vt.html">نقل السيارات</a>
<a class="tab" href="photoshoot-user.html">إدارة الطلبات</a>
<a class="tab" href="cars.html">كل السيارات</a>
<a class="tab" href="Activity.html">سجل النشاط</a>
</div>
<div class="topbar-actions">
<div class="status-badge">
<span class="dot warn" id="connDot"></span>
<span id="connText">—</span>
</div>
<span class="whoami" id="whoami"></span>
<button class="tb-btn" id="logoutBtn" style="display:none;">تسجيل الخروج</button>
</div>
</div>
</div>
<div class="wrap">
<!-- Auth -->
<div class="card" id="authCard">
<h3 class="title"><span class="icon">🔐</span>تسجيل الدخول</h3>
<div class="row">
<div class="col-4">
<label>البريد الإلكتروني</label>
<input id="email" placeholder="user@mzjcars.com" type="email">
</input></div>
<div class="col-4">
<label>كلمة السر</label>
<input id="password" placeholder="••••••••" type="password"/>
</div>
<div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
<button class="btn" id="loginBtn">دخول</button>
</div>
</div>
<div class="muted" id="authMsg" style="margin-top:6px;"></div>
<div class="hint">الدخول مطلوب لإدارة الطلبات وتحديث مراحلها.</div>
</div>
<!-- Search -->
<div class="card" id="orderCard" style="display:none;">
<h3 class="title"><span class="icon">📄</span>البحث عن طلب</h3>
<div class="row">
<div class="col-4">
<label>رقم الطلب</label>
<input id="orderId" placeholder="SAL-ORD-2025-01109 أو SAL-ORD-2025-01109_1"/>
</div>
<div class="col-4" style="display:none;">
<label>رقم الهيكل (VIN)</label>
<input id="vinInput" placeholder="اكتب رقم الهيكل (VIN)"/>
</div>
<div class="col-4" style="display:flex;align-items:flex-end;gap:8px;">
<button class="btn" id="loadBtn">فتح الطلب</button>
<button class="btn-outline" id="clearBtn">تفريغ</button>
</div>
</div>
<div class="muted" id="orderMsg" style="margin-top:6px;"></div>
<div class="hint">اكتب رقم الطلب ثم اضغط فتح الطلب.</div>
</div>
<!-- Tabs -->
<div class="tabs" id="tabsBar">
<button class="tab-btn tab-active" id="tabSearchBtn">بحث عن طلب</button>
<button class="tab-btn" id="tabListBtn">كل الطلبات</button>
<button class="tab-btn" id="tabArchiveBtn">الأرشيف</button>
</div>
<!-- ERP details -->
<div class="card" id="erpCard" style="display:none;">
<h3 class="title">
<span class="icon">📊</span>
        تفاصيل الطلب من نظام المبيعات (ERP)
      </h3>
<div class="muted" id="erpMeta" style="margin-bottom:6px;"></div>
<!-- اختيار رقم الهيكل لو الطلب فيه أكثر من VIN -->
<div class="vin-box" id="vinPickerBox">
<div class="vin-box-header">
<div class="vin-box-title">اختر رقم الهيكل للعمل عليه</div>
<div class="vin-chip" id="vinCountChip"></div>
</div>
<select id="vinPicker"></select>
<div class="hint">أي تحديث في مراحل تتبع الطلب سيكون لهذا رقم الهيكل فقط.</div>
<button class="btn" id="trackLinkBtn" style="margin-top:8px;width:100%;" type="button">رابط التتبع</button>
<button class="btn-outline" id="trackQrBtn" style="margin-top:8px;width:100%;" type="button">QR التتبع (اضغط لفتح)</button>
</div>
<div class="totals-box" id="erpTotals" style="display:none;"></div>
<div class="erp-table-wrap">
<table>
<thead>
<tr>
<th>اسم العميل</th>
<th>الرقم الضريبي للعميل</th>
<th>رقم جوال العميل</th>
<th>الفرع</th>
<th>تاريخ الطلب</th>
<th>تاريخ التسليم</th>
<th>مسؤول المبيعات</th>
<th>رقم الصنف</th>
<th>نوع الصنف</th>
<th>فئة الصنف</th>
<th>الموديل</th>
<th>رقم الهيكل VIN</th>
<th>اللون الداخلي</th>
<th>اللون الخارجي</th>
<th>الوكيل</th>
<th>الكمية</th>
<th>سعر الوحدة</th>
<th>قيمة الصنف</th>
<th>كود الضريبة</th>
<th>نوع الضريبة</th>
<th>نسبة الضريبة</th>
<th>قيمة الضريبة</th>
<th>الإجمالي قبل الضريبة</th>
<th>الإجمالي شامل الضريبة</th>
</tr>
</thead>
<tbody id="erpBody">
</tbody>
</table>
</div>
</div>
<!-- Orders list tab -->
<div class="card" id="ordersListCard" style="display:none;">
<h3 class="title"><span class="icon">📋</span>كل الطلبات</h3>
<div class="hint">اضغط على رقم الطلب لفتحه، واختيار رقم الهيكل من الأعلى لو كان أكثر من سيارة.</div>
<div class="row" style="margin-top:10px;">
<div class="col-6">
<label>بحث سريع</label>
<input id="ordersSearch" placeholder="اكتب اسم العميل / رقم الجوال / رقم الهيكل (VIN) / رقم الطلب"/>
<div class="hint">تقدر تبحث بأي جزء من البيانات.</div>
</div>
</div>
<div class="erp-table-wrap">
<table>
<thead>
<tr>
<th>رقم الطلب</th>
<th>اسم العميل</th>
<th>رقم الجوال</th>
<th>الفرع</th>
<th>رقم الهيكل VIN</th>
</tr>
</thead>
<tbody id="ordersListBody"></tbody>
</table>
</div>
</div>
<!-- Archive list tab -->
<div class="card" id="archivesListCard" style="display:none;">
<h3 class="title"><span class="icon">🗄️</span>الأرشيف</h3>
<div class="hint">هنا تظهر الطلبات المؤرشفة. اضغط على رقم الطلب لعرض تفاصيله (قراءة فقط).</div>
<div class="row" style="margin-top:10px;">
<div class="col-6">
<label>بحث سريع</label>
<input id="archivesSearch" placeholder="اكتب رقم الطلب / اسم العميل / رقم الجوال"/>
<div class="hint">البحث داخل الأرشيف فقط.</div>
</div>
</div>
<div class="erp-table-wrap">
<table>
<thead>
<tr>
<th>رقم الطلب</th>
<th>اسم العميل</th>
<th>رقم الجوال</th>
<th>الفرع</th>
<th>تاريخ الأرشفة</th>
</tr>
</thead>
<tbody id="archivesListBody"></tbody>
</table>
</div>
</div>
<!-- Stages -->
<div class="card" id="stagesCard" style="display:none;">
<h3 class="title"><span class="icon">🚦</span>مراحل تتبع الطلب</h3>
<div class="grid-2" id="stagesList"></div>
<div class="hint" style="margin-top:8px;">
        اضغط على <strong>تم الانتهاء</strong> أمام أي مرحلة ليتم ختمها وتحديث صفحة تتبع العميل تلقائياً.  
        بعد ختم جميع المراحل لهذا الهيكل لا يمكن تعديلها مرة أخرى.
      </div>
<!-- Archive actions -->
<div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-start;width:100%;margin:10px 0 0;">
<button class="btn-outline" id="archiveOrderBtn" style="font-size:12px;" type="button">
<i class="fa-solid fa-box-archive"></i> أرشفة الطلب
        </button>
<button class="btn-outline" id="unarchiveOrderBtn" style="font-size:12px;display:none;" type="button">
<i class="fa-solid fa-rotate-left"></i> إلغاء الأرشفة
        </button>
<span class="muted" id="archiveHint" style="font-size:12px;"></span>
</div>
<div class="muted" id="stageMsg" style="margin-top:6px;"></div>
</div>
</div>

<script>
  // Topbar connection badge helper (non-invasive)
  (function(){
    const who = document.getElementById('whoami');
    const dot = document.getElementById('connDot');
    const txt = document.getElementById('connText');
    function tick(){
      const hasUser = who && (who.textContent||'').trim().length>0;
      if(dot) dot.className = 'dot ' + (hasUser ? 'ok' : 'warn');
      if(txt) txt.textContent = hasUser ? 'متصل' : 'غير مسجل';
    }
    setInterval(tick, 700);
    setTimeout(tick, 50);
  })();
</script>
<script src="./mzj-ui.js"></script>
</div>
</main>
</div>
<!-- Message Modal (Edit before send) -->
<div id="msgModal" style="display:none;position:fixed;inset:0;z-index:9999;">
<div id="msgModalBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
<div style="position:relative;max-width:680px;margin:7vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
<div style="display:flex;align-items:center;gap:10px;">
<div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
<i class="fa-solid fa-paper-plane"></i>
</div>
<div>
<div id="msgModalTitle" style="font-weight:900;color:var(--brown);">إرسال رسالة</div>
<div id="msgModalSub" style="font-size:12px;color:var(--muted);margin-top:2px;">—</div>
</div>
</div>
<button class="btn-outline" id="msgModalClose" style="font-size:12px;" type="button">إغلاق</button>
</div>
<div style="padding:12px 14px;">
<label style="margin:0 0 6px 0;">نص الرسالة (تقدر تعدّل قبل الإرسال)</label>
<textarea id="msgModalText" rows="9" style="width:100%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#f9fafb;font-family:inherit;font-size:14px;outline:none;resize:vertical;"></textarea>
<div style="display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:space-between;margin-top:10px;">
<div class="muted" style="font-size:12px;">
<span class="badge" id="msgModalChannel">—</span>
<span class="badge" id="msgModalPhone">—</span>
<span class="badge" id="msgModalVin">—</span>
</div>
<div style="display:flex;gap:8px;flex-wrap:wrap;">
<button class="btn-outline" id="msgModalCopy" style="font-size:12px;" type="button"><i class="fa-regular fa-copy"></i> نسخ النص</button>
<button class="btn-outline" id="msgModalReset" style="font-size:12px;" type="button"><i class="fa-solid fa-rotate-left"></i> رجوع للنص الأصلي</button>
<button class="btn" id="msgModalSend" style="font-size:12px;" type="button"><i class="fa-solid fa-paper-plane"></i> إرسال</button>
</div>
</div>
<div class="muted" id="msgModalMsg" style="margin-top:8px;"></div>
</div>
</div>
</div>
<!-- Dynamic QR (Clickable) -->
<div id="trackQrModal" style="display:none;position:fixed;inset:0;z-index:9998;">
<div id="trackQrBackdrop" style="position:absolute;inset:0;background:rgba(0,0,0,.45);"></div>
<div style="position:relative;max-width:420px;margin:10vh auto;background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);overflow:hidden;">
<div style="display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid #e5e7eb;">
<div style="display:flex;align-items:center;gap:10px;">
<div style="width:36px;height:36px;border-radius:12px;display:grid;place-items:center;background:rgba(188,143,116,.16);color:var(--brown);font-weight:900;">
<i class="fa-solid fa-qrcode"></i>
</div>
<div>
<div style="font-weight:900;color:var(--brown);">QR تتبع العميل</div>
<div id="trackQrSub" style="font-size:12px;color:var(--muted);margin-top:2px;">اضغط على الـ QR لفتح التتبع مباشرة</div>
</div>
</div>
<button class="btn-outline" id="trackQrClose" style="font-size:12px;" type="button">إغلاق</button>
</div>
<div style="padding:14px;text-align:center;">
<a href="#" id="trackQrLink" style="display:inline-block;text-decoration:none;" target="_blank">
<img alt="QR Tracking" id="trackQrImg" style="width:240px;height:240px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;"/>
</a>
<div class="hint" style="margin-top:10px;">رابط التتبع: <button class="link-btn" id="trackQrCopy" type="button">نسخ الرابط</button></div>
</div>
</div>
</div>

<!-- Fast Action Modal (Lightweight) -->
<div class="modalBackdrop" id="fastActionModal" style="display:none">
  <div class="modal" style="max-width:360px;text-align:center">
    <h4 id="fastActionTitle">جاري التنفيذ</h4>
    <div class="small" style="margin:12px 0">برجاء الانتظار…</div>
    <div class="loader"></div>
  </div>
</div>

</body>
</html>
</template>
</div>
</div>


<!-- Media -->
<div class="view" id="view-media" role="tabpanel">
<div class="card" style="padding:16px;">
<iframe id="mediaFrame" loading="lazy" style="width:100%; height:calc(100vh - 260px); border:0; border-radius:12px; background:#fff;" title="Media"></iframe>
</div>
</div>


<!-- الأرشيف (فارغ مؤقتًا) -->
<!-- إدارة المستخدمين -->
<div class="view" id="view-users" role="tabpanel">
<div class="grid">
<div class="card">
<h3>إدارة المستخدمين</h3>
<div class="body">
<div class="toolbar">
<div class="field" style="flex:1;min-width:240px">
<label>بحث</label>
<input autocomplete="off" id="ua_search" placeholder="ابحث بالبريد أو الاسم أو UID"/>
</div>
<div class="field" style="min-width:220px">
<label>فلتر الحالة</label>
<select id="ua_active_filter">
<option value="all">الكل</option>
<option value="active">نشط فقط</option>
<option value="inactive">غير نشط فقط</option>
</select>
</div>
<button class="btn secondary" id="ua_refresh">تحديث</button>
</div>
<div class="row" style="margin-top:8px">
<div>
<label>اسم المستخدم (لإنشاء سجل جديد)</label>
<input autocomplete="off" id="ua_new_name" placeholder="اسم المستخدم"/>
</div>
<div>
<label>البريد الإلكتروني</label>
<input autocomplete="off" id="ua_new_email" placeholder="email@example.com"/>
</div>
<div>
<label>UID (اختياري)</label>
<input autocomplete="off" id="ua_new_uid" placeholder="UID"/>
</div>
<div style="display:flex;align-items:flex-end;gap:8px">
<button class="btn primary" id="ua_create">إنشاء سجل مستخدم</button>
</div>
</div>
<div class="small" style="margin-top:8px;color:var(--muted)">
                  ملاحظة: هذا التاب لإدارة صلاحيات المستخدمين في Firestore فقط (collection: <b>users</b>) حسب قالب الصلاحيات الذي اعتمدته.
                </div>
<div class="hr" style="margin:12px 0"></div>
<div class="tableWrap" style="max-height:520px">
<table>
<thead>
<tr>
<th>الاسم</th>
<th>البريد</th>
<th>UID</th>
<th>الحالة</th>
<th>آخر تحديث</th>
<th>إجراء</th>
</tr>
</thead>
<tbody id="ua_tbody">
<tr><td class="small muted" colspan="6">—</td></tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="card" id="ua_editor" style="display:none">
<h3>صلاحيات المستخدم</h3>
<div class="body">
<div class="small muted" id="ua_editor_user">—</div>
<div class="hr" style="margin:12px 0"></div>
<div class="row">
<div>
<label>الاسم</label>
<input id="ua_name"/>
</div>
<div>
<label>البريد</label>
<input id="ua_email"/>
</div>
<div>
<label>الحالة</label>
<select id="ua_active">
<option value="true">نشط</option>
<option value="false">غير نشط</option>
</select>
</div>
<div style="display:flex;align-items:flex-end;gap:8px">
<button class="btn primary" id="ua_save">حفظ</button>
<button class="btn secondary" id="ua_close">إغلاق</button>
</div>
</div>
<div class="hr" style="margin:12px 0"></div>
<div class="small" style="margin-bottom:8px"><b>التابات</b></div>
<div class="checks" id="ua_tabs_box"></div>
<div class="hr" style="margin:12px 0"></div>
<div class="small" style="margin-bottom:8px"><b>الصلاحيات التفصيلية</b></div>
<div id="ua_perms_box"></div>
<div class="hr" style="margin:12px 0"></div>
<div class="small muted">تُحفظ الصلاحيات بنفس شكل القالب: tabs + permissions (buttons/fields/sections...)
                </div>
</div>
</div>
</div>
</div>
<script>
    // Helper: short selector by id
    const $ = (id)=>document.getElementById(id);

    // ===== Admin Sub Tabs (داخل تبويب الإدارة) =====
    function setAdminSubTab(which){
      const tabs = ['edit','add','io'];
      tabs.forEach(k=>{
        const btn = document.querySelector('.subTab[data-sub="'+k+'"]');
        const view = document.getElementById('adm_view_'+k);
        if(btn){
          if(k===which){ btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
          else{ btn.classList.remove('active'); btn.setAttribute('aria-selected','false'); }
        }
        if(view){
          if(k===which) view.classList.remove('hidden');
          else view.classList.add('hidden');
        }
      });
      // تحديث التوجل الخاص بالملاحظات في الفورم الظاهر
      try{ uiStatusNotesToggle(); }catch(_){}
      try{ uiNewStatusNotesToggle(); }catch(_){}
    }

    function bindAdminSubTabs(){
      const holder = document.querySelector('.subTabs');
      if(!holder) return;
      holder.querySelectorAll('.subTab').forEach(b=>{
        b.addEventListener('click', ()=>{
          const which = b.getAttribute('data-sub') || 'edit';
          setAdminSubTab(which);
        });
      });
      setAdminSubTab('edit');
    }

    // ===== Firebase Config (mzj-workflow) =====
    const firebaseConfig = {
      apiKey: "AIzaSyBaor-9gU1XYmTD-3YCP14Kstf7HvMEC_M",
      authDomain: "mzj-workflow.firebaseapp.com",
      projectId: "mzj-workflow",
      storageBucket: "mzj-workflow.firebasestorage.app",
      messagingSenderId: "71098850303",
      appId: "1:71098850303:web:ac5d165282c197f8fa65ca",
      measurementId: "G-N5Q63YGLWF"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // ===== Access Control (tabs + permissions) =====
    // UI visibility is controlled here (Firestore Rules control data access only).
    const ADMIN_EMAILS = [
      'mr.ahmed_rashed@outlook.sa',
      'ceo@mzjcars.com',
      'hossamzayan10@gmail.com'
    ];

    // صلاحيات أزرار حذف/تفريغ في الداش بورد (محددة ليوزرات معينة)
    const DASH_DANGER_EMAILS = [
      'mr.ahmed_rashed@outlook.sa',
      'ceo@mzjcars.com'
    ];

    function canUseDashDanger(){
      const em = (auth?.currentUser?.email || '').toLowerCase();
      return DASH_DANGER_EMAILS.includes(em);
    }

    // ===== Approvals managers (who can do المالية/الإدارية) =====
    const APPROVALS_EMAILS = [
      'ceo@mzjcars.com',
      'cfo@mzjcars.com',
      'coo@mzjcars.com',
      'mr.ahmed_rashed@outlook.sa'
    ];

    function canManageApprovals(){
      const em = (auth?.currentUser?.email || '').toLowerCase();
      // admins can also manage
      if(ADMIN_EMAILS && ADMIN_EMAILS.includes(em)) return true;
      return APPROVALS_EMAILS.includes(em);
    }

let CURRENT_USER_DOC = null;

    function isAdminClient(user, userDocData){
      const em = (user?.email || '').toLowerCase();
      if(ADMIN_EMAILS.includes(em)) return true;
      const role = (userDocData?.role || '').toString().toLowerCase();
      return role === 'admin' || role === 'administrator' || role === 'administration' || role.includes('ادار');
    }

    function canShowTabKey(tabKey, user, userDocData){
      if(isAdminClient(user, userDocData)) return true;
      if(userDocData?.active === false) return false;

      // Prefer tabs.* if present, otherwise fallback to permissions.*.view
      const tabs = userDocData?.tabs;
      if(tabs && Object.prototype.hasOwnProperty.call(tabs, tabKey)) {
        return tabs[tabKey] === true;
      }
      const perms = userDocData?.permissions;
      if(perms && perms[tabKey] && typeof perms[tabKey] === 'object' && 'view' in perms[tabKey]){
        return perms[tabKey].view === true;
      }
      // default: hidden
      return false;
    }

    const VIEW_TO_TABKEY = {
      'view-dashboard': 'dashboard',
      'view-admin': 'admin',
      'view-inventory': 'inventory',
      'view-transfer': 'car_transfer',
      'view-requests': 'requests',
      'view-allcars': 'all_cars',
      'view-logs': 'movement_log',
      'view-tracking': 'tracking',
'view-users': 'users_admin'
    };

    function applyAccessControl(user, userDocData){
      // Tabs in top bar
      document.querySelectorAll('.tabbar .tab').forEach(tabEl=>{
        const viewId = tabEl.dataset.view;
        const key = VIEW_TO_TABKEY[viewId];
        if(!key) return;
        const ok = canShowTabKey(key, user, userDocData);
        tabEl.style.display = ok ? '' : 'none';
        tabEl.setAttribute('aria-hidden', ok ? 'false' : 'true');
      });

      // If current active view is not allowed, open first allowed view
      const activeTab = document.querySelector('.tabbar .tab.active');
      const currentView = activeTab?.dataset?.view || 'view-admin';
      const currentKey = VIEW_TO_TABKEY[currentView];
      if(currentKey && !canShowTabKey(currentKey, user, userDocData)) {
        const first = Array.from(document.querySelectorAll('.tabbar .tab'))
          .find(t=>t.style.display !== 'none');
        if(first) {
          openView(first.dataset.view);
        } else {
          // nothing allowed -> force dashboard hidden app
          toast('لا توجد صلاحيات عرض لأي تبويب.');
        }
      }

      // Also disable some buttons/fields quickly based on detailed permissions if present
      // (We keep current behavior unless permission nodes exist).
      try{
        const perms = userDocData?.permissions || {};
        // Dashboard buttons
        if(perms.dashboard?.buttons){
          const b = perms.dashboard.buttons;
          if($('dash_filter_save')) $('dash_filter_save').style.display = (b.save===true || isAdminClient(user,userDocData)) ? '' : 'none';
          if($('dash_filter_clear')) $('dash_filter_clear').style.display = (b.clear===true || isAdminClient(user,userDocData)) ? '' : 'none';
        }
      }catch(e){ /* ignore */ }

      // ⚠️ تقييد أزرار الخطر (تفريغ الداش بورد + حذف كارت نواقص الفروع) ليوزرات محددة فقط
      try{
        if($('dash_filter_clear')) $('dash_filter_clear').style.display = canUseDashDanger() ? '' : 'none';
      }catch(_e){}
    }

    async function loadCurrentUserDoc(user){
      try{
        const snap = await db.collection('users').doc(user.uid).get();
        if(!snap.exists) return null;
        return snap.data() || null;
      }catch(e){
        console.warn('loadCurrentUserDoc', e);
        return null;
      }
    }

    // ===== Inventory Live (Fix: startInventoryLive/stopInventoryLive) =====
    let invUnsub = null;
    let invAll = [];

    function norm(v){ return (v ?? '').toString().trim(); }
    function toKey(v){ return norm(v).toLowerCase(); }

    function getInvFilters(){
      const q = toKey($('inv_search')?.value || '');
      const branch = norm($('inv_location')?.value || '').trim();
      const status = norm($('inv_status')?.value || '').trim();
      const model  = norm($('inv_model')?.value || '').trim();
      const archive = norm($('inv_archive')?.value || '').trim();
      return { q, branch, status, model, archive };
    }

    function matchesSearch(car, q){
      if(!q) return true;
      const bag = [
        car.vin, car.carName, car.statement, car.agent,
        car.interiorColor, car.exteriorColor, car.model,
        car.plate, car.batchName, car.location, car.status,
        car.noteLocation, car.noteMissing, car.trackingLink
      ].map(toKey).join(' | ');
      return bag.includes(q);
    }

    function isCarArchived(car){
      const st = norm(car?.status||'');
      const loc = norm(car?.location||car?.locationName||car?.locationId||'');
      return !!(car?.isArchived || st==='مؤرشف' || loc==='archives');
    }

    function renderInventory(){
      const table = $('inv_table');
      if(!table) return;
      let tbody = table.querySelector('tbody');
      if(!tbody){ tbody = document.createElement('tbody'); table.appendChild(tbody); }

      const { q, branch, status, model, archive } = getInvFilters();
      const filtered = invAll.filter(car=>{
        const archived = isCarArchived(car);
        if(archive==='active' && archived) return false;
        if(archive==='archived' && !archived) return false;
        if(branch && branch!=='الكل' && norm(car.location)!==branch) return false;
        if(status && status!=='الكل' && norm(car.status)!==status) return false;
        if(model  && model!=='الكل'  && norm(car.model)!==model) return false;
        return matchesSearch(car, q);
      });

      tbody.innerHTML = '';
      if(filtered.length===0){
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 18;
        td.style.textAlign = 'center';
        td.style.padding = '14px';
        td.textContent = 'لا توجد بيانات مطابقة.';
        tr.appendChild(td);
        tbody.appendChild(tr);
        $('inv_meta').textContent = 'إجمالي: 0';
        return;
      }

      filtered.forEach(car=>{
        const tr = document.createElement('tr');

        function tdText(v){
          const td=document.createElement('td');
          td.textContent = norm(v);
          return td;
        }

        tr.appendChild(tdText(car.vin));
        tr.appendChild(tdText(car.carName));
        tr.appendChild(tdText(car.statement));
        tr.appendChild(tdText(car.agent));
        tr.appendChild(tdText(car.interiorColor));
        tr.appendChild(tdText(car.exteriorColor));
        tr.appendChild(tdText(car.model));
        tr.appendChild(tdText(car.plate));
        tr.appendChild(tdText(car.batchName));
        tr.appendChild(tdText(car.location));
        tr.appendChild(tdText(car.noteLocation));
        tr.appendChild(tdText(car.noteMissing));
        tr.appendChild(tdText(car.status));

        // Tracking
        {
          const td=document.createElement('td');
          const link = (car.trackingLink || car.tracking || '').toString().trim();
          if(link){
            const b=document.createElement('button');
            b.className='btn btn-sm';
            b.textContent='عرض';
            b.addEventListener('click', ()=>{
              const safe = escapeHtml(link);
              openDetailsModal(`
                <div style="display:grid;gap:10px">
                  <div class="small"><b>رابط التتبع:</b></div>
                  <div class="pill" style="display:flex;gap:8px;align-items:center;justify-content:space-between">
                    <span style="word-break:break-all">${safe}</span>
                    <button class="btn secondary" id="trk_copy_btn">نسخ</button>
                  </div>
                  <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <a class="btn" href="${safe}" target="_blank" rel="noopener">فتح الرابط</a>
                  </div>
                </div>
              `, 'Tracking');
              // bind copy
              setTimeout(()=>{
                const cb = document.getElementById('trk_copy_btn');
                if(cb){
                  cb.addEventListener('click', async ()=>{
                    try{
                      await navigator.clipboard.writeText(link);
                      toast('تم نسخ رابط التتبع');
                    }catch(e){
                      console.error(e);
                      toast('تعذر النسخ');
                    }
                  });
                }
              }, 0);
            });
            td.appendChild(b);
          }else{
            td.textContent='—';
          }
          tr.appendChild(td);
        }

        // Approvals
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', ()=>{
            const fin = !!(car.approvals && car.approvals.financial);
            const adm = !!(car.approvals && car.approvals.admin);
            openDetailsModal(`
              <div style="display:grid;gap:10px">
                <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                  <span>الموافقة المالية</span><strong>${fin?'✅':'❌'}</strong>
                </div>
                <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                  <span>الموافقة الادارية</span><strong>${adm?'✅':'❌'}</strong>
                </div>
              </div>
            `, 'الموافقات');
          });
          td.appendChild(b);
          tr.appendChild(td);
        }

        // Checklist
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', ()=>{
            const c = car.checklist || {};
            const rows = [
              ['حساس', c.sensors],
              ['كاميرا', c.camera],
              ['مكيف', c.ac],
              ['مسجل', c.musajjal ?? c.recorder],
              ['شاشة', c.screen],
              ['ريموت', c.remote],
              ['فرشات', c.farshat],
              ['طفاية', c.tafaia],
              ['شنطة سلامة', c.shanta],
              ['اسبير', c.spare],
            ].map(([k,v])=>`
              <div class="pill" style="display:flex;justify-content:space-between;align-items:center">
                <span>${k}</span><strong>${v ? '✅' : '❌'}</strong>
              </div>
            `).join('');
            openDetailsModal(`<div style="display:grid;gap:10px">${rows}</div>`, 'التشيك');
          });
          td.appendChild(b);
          tr.appendChild(td);
        }
        // Transfers logs
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='عرض';
          b.addEventListener('click', async ()=>{
            b.disabled = true;
            b.textContent = '...';
            try{
              // ملاحظة: نتجنب orderBy هنا لتفادي متطلبات الـ index
              const snap = await db.collection('logs')
                .where('vin','==',car.vin)
                .limit(200)
                .get();

              if(snap.empty){
                openDetailsModal('<div class="small">لا توجد حركات مسجلة لهذه السيارة.</div>', 'طلبات النقل');
              }else{
                const items = [];
                snap.forEach(doc=>{
                  const d = doc.data()||{};
                  const act = (d.action||'').toString();
                  if(!act.includes('transfer')) return;

                  const dt = d.at && d.at.toDate ? d.at.toDate() : null;
                  const at = dt ? dt.toLocaleString('ar-SA') : (d.at||'');

                  const fromLoc = d.fromLocation ?? d.fromLoc ?? d.from ?? '—';
                  const toLoc   = d.toLocation   ?? d.toLoc   ?? d.to   ?? '—';
                  const fromSt  = d.fromStatus ?? '—';
                  const toSt    = d.toStatus   ?? '—';
                  const by      = d.by || '';
                  const note    = (d.note||'').toString();

                  items.push({
                    atMs: dt ? dt.getTime() : 0,
                    html: `
                      <div class="pill" style="display:grid;gap:6px">
                        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
                          <strong>${escapeHtml(at)}</strong>
                          <span class="small">${escapeHtml(by)}</span>
                        </div>
                        <div class="small">من: ${escapeHtml(fromLoc)} → إلى: ${escapeHtml(toLoc)}</div>
                        <div class="small">الحالة: ${escapeHtml(fromSt)} → ${escapeHtml(toSt)}</div>
                        ${note ? `<div class="small"><b>ملاحظة:</b> ${escapeHtml(note)}</div>` : ``}
                      </div>
                    `
                  });
                });

                items.sort((a,b)=> (b.atMs||0) - (a.atMs||0));
                const html = items.length
                  ? `<div style="display:grid;gap:10px">${items.map(x=>x.html).join('')}</div>`
                  : '<div class="small">لا توجد حركات نقل.</div>';

                openDetailsModal(html, 'طلبات النقل');
              }
            }catch(e){
              console.error(e);
              openDetailsModal('<div class="small">تعذر تحميل سجل النقل.</div>', 'طلبات النقل');
            }finally{
              b.disabled = false;
              b.textContent = 'عرض';
            }
          });
          td.appendChild(b);
          tr.appendChild(td);
        }

        // Archive
        {
          const td=document.createElement('td');
          const b=document.createElement('button');
          b.className='btn btn-sm';
          b.textContent='أرشيف';
          const canShow = norm(car.status)==='مباع تم التسليم';
          if(!canShow){
            b.style.display='none';
          }else{
            const fin = !!(car.approvals && car.approvals.financial);
            const adm = !!(car.approvals && car.approvals.admin);
            const hasTrack = !!car.trackingLink;
            // We require at least one transfer log (best-effort check: will be verified on click)
            b.disabled = !(fin && adm && hasTrack);
            b.title = b.disabled ? 'يجب اكتمال الموافقات + Tracking' : '';
            b.addEventListener('click', async ()=>{
              b.disabled = true;
              b.textContent='...';
              try{
                // verify transfer exists
                const trSnap = await db.collection('logs').where('vin','==',car.vin).limit(1).get();
                if(trSnap.empty) { toast('لا يمكن الأرشفة بدون طلبات نقل'); b.disabled=false; b.textContent='أرشيف'; return; }

                const archivedBy = (auth.currentUser && auth.currentUser.email) || '';
                const archivedAt = firebase.firestore.FieldValue.serverTimestamp();

                // 1) write to archives (اختياري — قد يكون ممنوع بالقواعد)
                try{
                  await db.collection('archives').doc(car.vin).set({
                    ...((car && car._raw)?car._raw:car),
                    archivedAt,
                    archivedBy
                  }, { merge:true });
                }catch(archErr){
                  console.warn('archive write blocked', archErr);
                }

                // 2) Mark archived داخل نفس مستند السيارة (بدون Delete لتفادي صلاحيات الحذف)
                await db.collection('cars').doc(car.vin).set({
                  isArchived: true,
                  archivedAt,
                  archivedBy,
                  status: 'مؤرشف'
                }, { merge:true });

                toast('تم أرشفة السيارة');
}catch(e){
                console.error(e);
                const msg = (e && (e.message || e.code)) ? (e.message || e.code) : '';
                toast('تعذر أرشفة السيارة' + (msg?(' — '+msg):''));
              }finally{
                b.textContent='أرشيف';
              }
            });
          }
          td.appendChild(b);
          tr.appendChild(td);
        }

        tbody.appendChild(tr);
      });

      $('inv_meta').textContent = `إجمالي: ${filtered.length}`;
    }

    
    // ===== Inventory Lists (Branches + Models) =====
    let INV_BRANCHES = [];
    let INV_MODELS = [];

    async function loadInvBranches(){
      // المطلوب: meta/list/branches
      try{
        const snap = await db.collection('meta').doc('list').collection('branches').get();
        const arr = [];
        snap.forEach(d=>{
          const data = d.data() || {};
          const name = (data.name || data.title || data.branch || data.value || d.id || '').toString().trim();
          if(name) arr.push(name);
        });
        // remove duplicates
        INV_BRANCHES = Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b,'ar'));
      }catch(e){
        console.warn('loadInvBranches failed', e);
        INV_BRANCHES = [];
      }
      fillInvLocationSelect();
    }

    function fillInvLocationSelect(){
      const sel = document.getElementById('inv_location');
      if(!sel) return;
      const cur = sel.value || '';
      const branches = (INV_BRANCHES && INV_BRANCHES.length) ? INV_BRANCHES : Array.from(new Set(invAll.map(c=>(c.location||'').toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ar'));
      sel.innerHTML = '<option value="">الكل</option>' + branches.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
      if(cur && branches.includes(cur)) sel.value = cur;
      else if(cur==='') sel.value = '';
    }

    function fillInvModelSelect(){
      const sel = document.getElementById('inv_model');
      if(!sel) return;
      const cur = sel.value || '';
      const models = Array.from(new Set(invAll.map(c=>(c.model||'').toString().trim()).filter(Boolean))).sort((a,b)=>a.localeCompare(b,'ar'));
      sel.innerHTML = '<option value="">الكل</option>' + models.map(m=>`<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');
      if(cur && models.includes(cur)) sel.value = cur;
      else if(cur==='') sel.value = '';
    }

function startInventoryLive(){
      // ✅ Inventory now loads ONCE (get) to reduce quota
      // Load branches list for inventory filter
      loadInvBranches();
      const metaEl = $('inv_meta');
      if(metaEl) metaEl.textContent = 'جاري التحميل...';
      db.collection('cars').get().then((snap)=>{
        invAll = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const car = {
            vin: doc.id,
            isArchived: !!(d.isArchived || d.archivedAt),
            carName: d.carName || d.car || d.name || d.vehicle || '',
            statement: d.statement || d.trim || d.desc || d.variant || '',
            agent: (d.agent || d.dealer || d.vendor || d.agency || d['الوكيل'] || ''),
            interiorColor: d.interiorColor || '',
            exteriorColor: d.exteriorColor || '',
            model: d.model || '',
            year: (d.year || d.modelYear || d.yearModel || d['السنة'] || ''),
            plate: d.plate || '',
            batchName: d.batchName || '',
            location: d.location || '',
            notesLocation: d.notesLocation || d.noteLocation || '',
            noteLocation: d.notesLocation || d.noteLocation || '',
            notesMissing: d.notesMissing || d.noteMissing || '',
            noteMissing: d.notesMissing || d.noteMissing || '',
            status: (d.status || d.state || d.statuses || d['الحالة'] || ''),
            trackingLink: d.trackingLink || '',
            approvals: d.approvals || {financial:false, admin:false, financialNote:'', adminNote:''},
            checklist: d.checklist || {},
            _raw: d
          };
          invAll.push(car);
        });
        fillInvLocationSelect();
        fillInvModelSelect();
        renderInventory();
      }).catch((err)=>{
        console.error(err);
        if($('inv_meta')) $('inv_meta').textContent = 'تعذر تحميل المخزون';
        toast(err?.message || 'تعذر تحميل المخزون');
      });
    }

    function stopInventoryLive(){
      // no-op (no live listener)
      invUnsub = null;
    }


    /****************************************************
     * Dashboard
     ****************************************************/
    let dashCarsUnsub = null;
    let dashCatalogUnsub = null;
    let dashCars = [];
    // Promise resolves once dashCars receives first snapshot (avoids empty modals on first click)
    let __dashCarsReadyResolve = null;
    let dashCarsReady = new Promise(res=>{ __dashCarsReadyResolve = res; });
    let dashCatalog = [];

    function normStatus(s){
      s = (s||'').toString().trim();
      // توحيد مسميات تحت/تم التسليم
      if(s === 'تحت التسليم') return 'مباع تحت التسليم';
      if(s === 'تم التسليم') return 'مباع تم التسليم';
      if(s === 'مباع تحت التسلم') return 'مباع تحت التسليم';
      if(s === 'مباع تحت التسليم') return 'مباع تحت التسليم';
      if(s === 'مباع تم التسليم') return 'مباع تم التسليم';
      if(s === 'محجوز') return 'حجز';
      return s;
    }

    function isActualStatus(st){
      const s = normStatus(st);
      return (s==='متاح للبيع' || s==='محجوز' || s==='حجز' || s==='بها ملاحظات');
    }

    function statusBucket(st){
      const s = normStatus(st);
      if(s==='متاح للبيع') return 'avail';
      if(s==='محجوز' || s==='حجز') return 'reserved';
      if(s==='بها ملاحظات') return 'notes';
      if(s==='مباع تحت التسليم') return 'under';
      if(s==='مباع تم التسليم') return 'delivered';
      return 'other';
    }

    function countAgg(cars){
      const out = {avail:0,reserved:0,notes:0,under:0,delivered:0,other:0};
      cars.forEach(c=>{ out[statusBucket(c.status)] += 1; });
      out.totalActual = out.avail + out.reserved + out.notes;
      out.keysTotal = out.totalActual + out.under;
      return out;
    }

    function setText(id, val){
      const el = document.getElementById(id);
      if(el) el.textContent = (val===null||val===undefined) ? '—' : String(val);
    }

    function applyAgg(prefix, agg){
      setText(prefix+'_totalActual', agg.totalActual);
      setText(prefix+'_keysTotal', agg.keysTotal);
      setText(prefix+'_avail', agg.avail);
      setText(prefix+'_reserved', agg.reserved);
      setText(prefix+'_notes', agg.notes);
      setText(prefix+'_under', agg.under);
      setText(prefix+'_delivered', agg.delivered);
    }

    
    
    async function loadDashLocationsIntoSelect(){
      const sel = document.getElementById('dash_filter_location');
      const statusesWrap = document.getElementById('dash_filter_statuses');
      if(!sel) return;

      const curLoc = (sel.value||'').toString();
      const checkedStatuses = new Set((statusesWrap ? Array.from(statusesWrap.querySelectorAll('input[type="checkbox"]:checked')).map(i=>i.value) : []));

      let branches = [];
      let statuses = [];

      // Read from meta/lists (fields: branches, statuses)
      try{
        const mDoc = await db.collection('meta').doc('lists').get();
        if(mDoc.exists){
          const d = mDoc.data() || {};
          branches = Array.isArray(d.branches) ? d.branches : [];
          statuses = Array.isArray(d.statuses) ? d.statuses : [];
        }
      }catch(e){
        console.warn('meta/lists read failed', e);
      }

      // Fallback branches from cars snapshot
      if(!branches.length){
        branches = Array.from(new Set(dashCars.map(c=>(c.location||'').toString().trim()).filter(Boolean)))
          .sort((a,b)=>a.localeCompare(b,'ar'));
      }

      // Final fallback safe
      if(!branches.length){
        branches = ['الملتقى','القادسية','الصالة','الوكالة','المستودع'];
      }

      sel.innerHTML = '<option value="">— اختر —</option>' + branches.map(b=>`<option value="${escapeHtml(b)}">${escapeHtml(b)}</option>`).join('');
      if(curLoc && branches.includes(curLoc)) sel.value = curLoc;

      // Rebuild statuses checkboxes from meta (if container exists)
      if(statusesWrap){
        if(!statuses.length){
          statuses = ['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم','مباع تم التسليم'];
        }
        statusesWrap.innerHTML = statuses.map((st)=>{
          const checked = checkedStatuses.has(st) ? 'checked' : '';
          return `<label class="dashChk"><input type="checkbox" value="${escapeHtml(st)}" ${checked}> ${escapeHtml(st)}</label>`;
        }).join('');
      }
    }

    function readSavedDashFilter(){
      try{
        const raw = localStorage.getItem('mzj_dash_filter');
        return raw ? JSON.parse(raw) : null;
      }catch(e){ return null; }
    }

    function writeSavedDashFilter(obj){
      try{ localStorage.setItem('mzj_dash_filter', JSON.stringify(obj||{})); }catch(e){}
    }

    function getDashFilterFromUI(){
      const loc = (document.getElementById('dash_filter_location')?.value || '').trim();
      const checks = Array.from(document.querySelectorAll('#dash_filter_statuses input[type="checkbox"]'));
      const statuses = checks.filter(c=>c.checked).map(c=>c.value);
      return {location: loc, statuses};
    }

    function applyDashFilterToUI(obj){
      obj = obj || {};
      const sel = document.getElementById('dash_filter_location');
      if(sel) sel.value = obj.location || '';
      const checks = Array.from(document.querySelectorAll('#dash_filter_statuses input[type="checkbox"]'));
      const set = new Set(obj.statuses || []);
      checks.forEach(c=> c.checked = set.has(c.value));
    }

    
    function markDashboardTotalsHighlight(){
      const ids = ['stk_totalActual','stk_keysTotal','ag_totalActual','ag_keysTotal','b1_totalActual','b1_keysTotal','b2_totalActual','b2_keysTotal','b3_totalActual','b3_keysTotal'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi');
        if(kpi) kpi.classList.add('kpiHighlight');
      });
    }

    function renderDashboard(){

      // global
      const allAgg = countAgg(dashCars);
      applyAgg('stk', allAgg);

      // agency + branches
      const byLoc = (loc)=> dashCars.filter(c=>(c.location||'').toString().trim()===loc);
      applyAgg('ag', countAgg(byLoc('الوكالة')));
      applyAgg('b1', countAgg(byLoc('الصالة')));
      applyAgg('b2', countAgg(byLoc('الملتقى')));
      applyAgg('b3', countAgg(byLoc('القادسية')));

      // approvals (status under delivery)
      const under = dashCars.filter(c=>normStatus(c.status)==='مباع تحت التسليم');
      const needFin = under.filter(c=>!(c.approvals && c.approvals.financial===true));
      const needAdm = under.filter(c=>!(c.approvals && c.approvals.admin===true));
      const ready   = under.filter(c=>(c.approvals && c.approvals.financial===true && c.approvals.admin===true));
      setText('ap_need_fin', needFin.length);
      setText('ap_need_adm', needAdm.length);
      setText('ap_ready', ready.length);

      // إجمالي كارت الموافقات = جميع سيارات (مباع تحت التسليم)
      const apTitle = document.getElementById('dash_ap_title');
      const apTot  = document.getElementById('dash_ap_total');
      if(apTitle) apTitle.textContent = 'كارت الموافقة المالية والإدارية';
      if(apTot) apTot.textContent = `${under.length}`;
      // Missing (catalog)
      const missMeta = document.getElementById('miss_meta');
      if(!dashCatalog.length){
        setText('miss_total', '—');
        if(missMeta) missMeta.textContent = 'لم يتم العثور على catalog. أنشئ catalog لتفعيل كارت النواقص.';
      }else{
        if(missMeta) missMeta.textContent = 'يُحسب من الإجمالي الفعلي (متاح للبيع + محجوز + بها ملاحظات) بالاعتماد على catalog.';
        let total=0;
        ['الوكالة','الصالة','الملتقى','القادسية'].forEach(loc=>{
          total += computeMissingForBranch(loc).length;
        });
        setText('miss_total', total);
      }

      // Render saved cards + highlight totals
      if(typeof renderSavedDashCards==='function') renderSavedDashCards();
      if(typeof markDashboardTotalsHighlight==='function') markDashboardTotalsHighlight();

      // Saved filter meta
      const fmeta = document.getElementById('dash_filter_meta');
      const saved = readSavedDashFilter();
      if(fmeta){
        if(saved && (saved.location || (saved.statuses||[]).length)){
          fmeta.textContent = `محفوظ: ${saved.location||'—'} | حالات: ${(saved.statuses||[]).join('، ')||'—'}`;
        }else{
          fmeta.textContent = '—';
        }
      }
    
      try{ renderMissingSavedCard(); }catch(e){}
      try{ renderTotalStockCard(); }catch(e){}
}


    function catKey(obj){
      const carName = (obj.carName||obj['السيارة']||'').toString().trim();
      const statement = (obj.statement||obj['البيان']||'').toString().trim();
      const interiorColor = (obj.interiorColor||obj.colorInside||obj['اللون الداخلي']||'').toString().trim();
      const exteriorColor = (obj.exteriorColor||obj.colorOutside||obj['اللون الخارجي']||'').toString().trim();
      const model = (obj.model||obj['موديل']||'').toString().trim();
      return '|' + [carName, statement, interiorColor, exteriorColor, model].join('|') + '|';
    }

    function carToCatKey(c){
      return '|' + [
        (c.carName||'').toString().trim(),
        (c.statement||'').toString().trim(),
        (c.interiorColor||'').toString().trim(),
        (c.exteriorColor||'').toString().trim(),
        (c.model||'').toString().trim()
      ].join('|') + '|';
    }

    function computeMissingForBranch(branch){
      if(!dashCatalog.length) return [];
      const actualCars = dashCars.filter(c=>(c.location||'').toString().trim()===branch && isActualStatus(c.status));
      const set = new Set(actualCars.map(carToCatKey));
      const missing = [];
      dashCatalog.forEach(item=>{
        const key = catKey(item);
        if(!set.has(key)) missing.push(item);
      });
      return missing;
    }

    
    function openMissingModalLegacy(branch){
      const arr = computeMissingForBranch(branch);
      const uid = 'miss_' + Date.now();
      const searchId = uid + '_q';
      const expId = uid + '_x';
      const tableId = uid + '_t';

      const rows = arr.map((it)=>{
        const d = it._raw || it;
        const carName = (d.carName||d['السيارة']||'—');
        const statement = (d.statement||d['البيان']||'—');
        const interiorColor = (d.interiorColor||d.colorInside||d['اللون الداخلي']||'—');
        const exteriorColor = (d.exteriorColor||d.colorOutside||d['اللون الخارجي']||'—');
        const model = (d.model||d['موديل']||'—');
        return `<tr><td>${escapeHtml(carName)}</td><td>${escapeHtml(statement)}</td><td>${escapeHtml(interiorColor)}</td><td>${escapeHtml(exteriorColor)}</td><td>${escapeHtml(model)}</td></tr>`;
      }).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث في النواقص" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${expId}">تصدير Excel</button>
          </div>
        </div>
        <div class="tableWrap" style="max-height:520px">
          <table id="${tableId}">
            <thead><tr><th>السيارة</th><th>البيان</th><th>اللون الداخلي</th><th>اللون الخارجي</th><th>موديل</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="5" class="small">لا توجد نواقص</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, `نواقص: ${branch}`);

      const qEl = document.getElementById(searchId);
      if(qEl){
        qEl.addEventListener('input', ()=>{
          const q = (qEl.value||'').trim().toLowerCase();
          document.querySelectorAll(`#${tableId} tbody tr`).forEach(tr=>{
            const t = (tr.textContent||'').toLowerCase();
            tr.style.display = (!q || t.includes(q)) ? '' : 'none';
          });
        });
      }
      const expBtn = document.getElementById(expId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const tbl = document.getElementById(tableId);
          if(!tbl) return;
          const wb = XLSX.utils.table_to_book(tbl, {sheet:'missing'});
          downloadWorkbook(wb, `missing_${branch}_${Date.now()}.xlsx`);
        });
      }
    }

    function goInventoryFilter(location, status){
      openView('view-inventory');
      const locSel = document.getElementById('inv_location');
      const stSel  = document.getElementById('inv_status');
      if(locSel && location){ locSel.value = location; }
      if(stSel && status){ stSel.value = status; }
      renderInventory();
    }

    
    function openApprovalsModal(mode){
      const under = dashCars.filter(c=>normStatus(c.status)==='مباع تحت التسليم');
      let arr = under;
      let title = 'الموافقات';
      if(mode==='fin') { arr = under.filter(c=>!(c.approvals && c.approvals.financial===true)); title='ناقص موافقة مالية'; }
      if(mode==='adm') { arr = under.filter(c=>!(c.approvals && c.approvals.admin===true)); title='ناقص موافقة إدارية'; }
      if(mode==='ready'){ arr = under.filter(c=>(c.approvals && c.approvals.financial===true && c.approvals.admin===true)); title='جاهزة للأرشيف'; }

      const uid = 'ap_' + Date.now();
      const searchId = uid + '_q';
      const btnExpId = uid + '_x';
      const tbodyId  = uid + '_b';

      const renderRows = (list)=> (list||[]).map(c=>{
        const admOk = (c.approvals && c.approvals.admin===true);
        const finOk = (c.approvals && c.approvals.financial===true);
        const a0 = (c.approvals||{});
        const notes = (c.approvalsNotes||{});
        const admNote = (((notes.admin!=null)?notes.admin:(a0.adminNote||''))||'').toString();
        const finNote = (((notes.financial!=null)?notes.financial:(a0.financialNote||''))||'').toString();
        return `
        <tr class="apRow" data-ap-vin="${escapeHtml(c.vin)}" title="فتح تفاصيل الموافقات">
          <td>${escapeHtml(c.vin)}</td>
          <td>${escapeHtml(c.carName||'')}</td>
          <td>${escapeHtml(c.statement||'')}</td>
          <td>${escapeHtml(c.location||'')}</td>
          <td>${escapeHtml(normStatus(c.status)||'')}</td>
          <td>${admOk ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</td>
          <td>${finOk ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</td>
          <td class="small">${escapeHtml(admNote)}</td>
          <td class="small">${escapeHtml(finNote)}</td>
        </tr>`;
      }).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث بـ VIN / اسم السيارة / البيان / المكان" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${btnExpId}">تصدير Excel</button>
          </div>
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>VIN</th><th>السيارة</th><th>البيان</th><th>المكان</th><th>الحالة</th><th>إداري</th><th>مالي</th><th>ملاحظة إدارية</th><th>ملاحظة مالية</th></tr></thead>
            <tbody id="${tbodyId}">${renderRows(arr) || '<tr><td colspan="9" class="small">لا توجد بيانات</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, title);

      const apply = ()=>{
        const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
        const filtered = !q ? arr : arr.filter(c=>{
          const hay = [c.vin,c.carName,c.statement,c.location,normStatus(c.status)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
          return hay.includes(q);
        });
        const tb = document.getElementById(tbodyId);
        if(tb) tb.innerHTML = renderRows(filtered) || '<tr><td colspan="9" class="small">لا توجد بيانات</td></tr>';
        document.querySelectorAll('tr.apRow[data-ap-vin]').forEach(b=>{
          b.addEventListener('click', ()=>{ const vin=b.getAttribute('data-ap-vin'); if(vin) openCarApprovalsModal(vin); });
        });
      };

      const qEl = document.getElementById(searchId);
      if(qEl){ qEl.addEventListener('input', apply); }
      document.querySelectorAll('tr.apRow[data-ap-vin]').forEach(b=>{
        b.addEventListener('click', ()=>{ const vin=b.getAttribute('data-ap-vin'); if(vin) openCarApprovalsModal(vin); });
      });

      const expBtn = document.getElementById(btnExpId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
          const filtered = !q ? arr : arr.filter(c=>{
            const hay = [c.vin,c.carName,c.statement,c.location,normStatus(c.status)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
            return hay.includes(q);
          });
          const headers = ['VIN','السيارة','البيان','المكان','الحالة','موافقة إدارية','موافقة مالية'];
          const rows = filtered.map(c=>[
            (c.vin||''),
            (c.carName||''),
            (c.statement||''),
            (c.location||''),
            (normStatus(c.status)||''),
            (c.approvals && c.approvals.admin===true) ? 'نعم' : 'لا',
            (c.approvals && c.approvals.financial===true) ? 'نعم' : 'لا',
          ]);
          exportRowsToExcel(headers, rows, `approvals_${mode||'all'}_${Date.now()}.xlsx`, 'approvals');
        });
      }
    }


    // ===== Approvals per car (Financial/Admin) =====
    async function openCarApprovalsModal(vin){
      const v = (vin||'').toString().trim();
      if(!v) return toast('VIN غير صحيح');
      try{
        const snap = await db.collection('cars').doc(v).get();
        if(!snap.exists) return toast('السيارة غير موجودة');
        const d = snap.data() || {};

        const carName = escapeHtml(d.carName||d.car||'');
        const statement = escapeHtml(d.statement||d.trim||'');
        const location = escapeHtml(d.location||'');
        const status = escapeHtml(normStatus(d.status||''));

        const a = d.approvals || {};
        const finOk = (a.financial===true);
        const admOk = (a.admin===true);

        const notes = d.approvalsNotes || {};
        const finNote = (((notes.financial!=null)?notes.financial:(a.financialNote||''))||'').toString();
        const admNote = (((notes.admin!=null)?notes.admin:(a.adminNote||''))||'').toString();

        const html = `
          <div class="muted" style="margin-bottom:10px">
            <b>VIN:</b> ${escapeHtml(v)} &nbsp; | &nbsp; <b>السيارة:</b> ${carName} &nbsp; | &nbsp; <b>البيان:</b> ${statement}<br/>
            <b>المكان:</b> ${location} &nbsp; | &nbsp; <b>الحالة:</b> ${status}
          </div>

          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div class="card" style="margin:0">
              <h3 style="margin:0 0 8px">الموافقة المالية</h3>
              <div class="body" style="padding:0">
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px">
                  <button class="btn" id="ap_fin_yes">موافقة مالية</button>
                  <button class="btn secondary" id="ap_fin_no">تراجع</button>
                  <span class="tag ${finOk?'ok':'no'}" id="ap_fin_state">${finOk?'✓ تم':'✗ لم يتم'}</span>
                </div>
                <div class="field">
                  <label>ملاحظة مالية</label>
                  <textarea id="ap_fin_note" rows="3" placeholder="اكتب ملاحظة...">${escapeHtml(finNote)}</textarea>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
                  <button class="btn secondary" id="ap_fin_save">حفظ الملاحظة</button>
                </div>
              </div>
            </div>

            <div class="card" style="margin:0">
              <h3 style="margin:0 0 8px">الموافقة الإدارية</h3>
              <div class="body" style="padding:0">
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-bottom:8px">
                  <button class="btn" id="ap_adm_yes">موافقة إدارية</button>
                  <button class="btn secondary" id="ap_adm_no">تراجع</button>
                  <span class="tag ${admOk?'ok':'no'}" id="ap_adm_state">${admOk?'✓ تم':'✗ لم يتم'}</span>
                </div>
                <div class="field">
                  <label>ملاحظة إدارية</label>
                  <textarea id="ap_adm_note" rows="3" placeholder="اكتب ملاحظة...">${escapeHtml(admNote)}</textarea>
                </div>
                <div class="row" style="gap:8px; flex-wrap:wrap; margin-top:8px">
                  <button class="btn secondary" id="ap_adm_save">حفظ الملاحظة</button>
                </div>
              </div>
            </div>
          </div>

          <div class="row" style="justify-content:flex-end; gap:8px; margin-top:12px">
            <button class="btn danger" id="ap_cancel_all">إلغاء الطلب (مسح الموافقات)</button>
          </div>
        `;

        openDetailsModal(html, 'موافقات السيارة');

        // Bind actions
        const finYes = document.getElementById('ap_fin_yes');
        const finNo  = document.getElementById('ap_fin_no');
        const finSave= document.getElementById('ap_fin_save');
        const admYes = document.getElementById('ap_adm_yes');
        const admNo  = document.getElementById('ap_adm_no');
        const admSave= document.getElementById('ap_adm_save');
        const cancel = document.getElementById('ap_cancel_all');

        const finNoteEl = document.getElementById('ap_fin_note');
        const admNoteEl = document.getElementById('ap_adm_note');

        const __canManageApprovals = canManageApprovals();

        // If user is not allowed to manage approvals, make modal read-only
        if(!__canManageApprovals){
          [finYes, finNo, finSave, admYes, admNo, admSave, cancel].forEach(b=>{
            if(b){ b.disabled = true; b.style.display = 'none'; }
          });
          if(finNoteEl) finNoteEl.readOnly = true;
          if(admNoteEl) admNoteEl.readOnly = true;
          const bodyEl = document.getElementById('detailsBody');
          if(bodyEl){
            const note = document.createElement('div');
            note.className = 'small';
            note.style.marginTop = '10px';
            note.innerHTML = 'صلاحية الموافقات (مالية/إدارية) متاحة فقط للمخولين.';
            bodyEl.appendChild(note);
          }
        }



        const getFinNote = ()=> (document.getElementById('ap_fin_note')?.value||'').toString();
        const getAdmNote = ()=> (document.getElementById('ap_adm_note')?.value||'').toString();

        const who = (auth.currentUser && (auth.currentUser.email||auth.currentUser.uid)) ? (auth.currentUser.email||auth.currentUser.uid) : '';

        async function applyPatch(patch, actionName){
          try{
            await db.collection('cars').doc(v).set(patch, {merge:true});
            if(typeof logAction==='function'){
              logAction('approvals', actionName, {vin:v, by: who});
            }
            // refresh dashCars view in memory
            if(Array.isArray(dashCars)){
              const i = dashCars.findIndex(x=>(x.vin||x.VIN||'')===v);
              if(i>=0){ dashCars[i] = Object.assign({}, dashCars[i], patch); }
            }
            if(typeof renderDashboard==='function') renderDashboard();
            if(typeof renderInventory==='function') renderInventory();
            toast('تم الحفظ');
          }catch(e){
            toast(e.message || 'فشل الحفظ');
          }
        }

        if(finYes) finYes.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {financial:true, financialNote:getFinNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_approve');
        });

        if(finNo) finNo.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {financial:false, financialNote:getFinNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_revert');
        });

        if(finSave) finSave.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {financialNote:getFinNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {financial:getFinNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {financial: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {financial: who})
          }, 'financial_note');
        });

        if(admYes) admYes.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {admin:true, adminNote:getAdmNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_approve');
        });

        if(admNo) admNo.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {admin:false, adminNote:getAdmNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_revert');
        });

        if(admSave) admSave.addEventListener('click', ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          applyPatch({
            approvals: Object.assign({}, (d.approvals||{}), {adminNote:getAdmNote()}),
            approvalsNotes: Object.assign({}, (d.approvalsNotes||{}), {admin:getAdmNote()}),
            approvalsAt: Object.assign({}, (d.approvalsAt||{}), {admin: firebase.firestore.FieldValue.serverTimestamp()}),
            approvalsBy: Object.assign({}, (d.approvalsBy||{}), {admin: who})
          }, 'admin_note');
        });

        if(cancel) cancel.addEventListener('click', async ()=>{
          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          if(!canManageApprovals()){ toast('لا تملك صلاحية تنفيذ الموافقات'); return; }

          if(!confirm('متأكد؟ سيتم مسح الموافقات المالية والإدارية')) return;
          try{
            await db.collection('cars').doc(v).set({
              approvals: {financial:false, admin:false, financialNote:'', adminNote:''},
              approvalsNotes: {financial:'', admin:''}
            }, {merge:true});
            // Attempt to delete optional fields if exist (best effort)
            try{
              await db.collection('cars').doc(v).update({
                'approvalsAt.financial': firebase.firestore.FieldValue.delete(),
                'approvalsAt.admin': firebase.firestore.FieldValue.delete(),
                'approvalsBy.financial': firebase.firestore.FieldValue.delete(),
                'approvalsBy.admin': firebase.firestore.FieldValue.delete(),
                'approvalsNotes.financial': firebase.firestore.FieldValue.delete(),
                'approvalsNotes.admin': firebase.firestore.FieldValue.delete()
              });
            }catch(_e){}
            if(typeof logAction==='function') logAction('approvals','cancel_all',{vin:v, by: who});
            if(typeof renderDashboard==='function') renderDashboard();
            if(typeof renderInventory==='function') renderInventory();
            toast('تم إلغاء الموافقات');
            hideModal('detailsModal');
          }catch(e){
            toast(e.message || 'فشل الإلغاء');
          }
        });

      }catch(e){
        toast(e.message || 'فشل فتح الموافقات');
      }
    }

    // Requests (light summary)
    let dashReqUnsub = null;
    let dashReq = [];

    function reqStage(r){
      const s1 = !!r.step1At;
      const s2 = !!r.step2At;
      const s3 = !!r.step3At;
      const s4 = !!r.step4At;
      if(s4) return 4;
      if(s3) return 3;
      if(s2) return 2;
      if(s1) return 1;
      return 0;
    }

    function renderRequestsCounts(){
      const s1 = dashReq.filter(r=>reqStage(r)==1).length;
      const s2 = dashReq.filter(r=>reqStage(r)==2).length;
      const s3 = dashReq.filter(r=>reqStage(r)==3).length;
      const s4 = dashReq.filter(r=>reqStage(r)==4).length;
      setText('rq_s1', s1);
      setText('rq_s2', s2);
      setText('rq_s3', s3);
      setText('rq_s4', s4);

      // إجمالي كارت طلبات النقل = (تم استلام الطلب + تم ارسال السيارة + تم استلام السيارة)
      const ttl = (s1 + s2 + s3);
      const tEl = document.getElementById('dash_req_title');
      const tTot = document.getElementById('dash_req_total');
      if(tEl) tEl.textContent = 'طلبات النقل';
      if(tTot) tTot.textContent = `${ttl}`;
    }

    
    function openRequestDetails(id){
      const r = dashReq.find(x=>(x.id||x._id||'')===id) || null;
      if(!r){ toast('الطلب غير موجود'); return; }
      const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
      const target = (r.targetLocation||r.toLocation||r.to||'');
      const status = (reqStage(r)===1?'تم استلام الطلب':reqStage(r)===2?'تم ارسال السيارة':reqStage(r)===3?'تم استلام السيارة':reqStage(r)===4?'تم الانتهاء':'-');
      const createdAt = fmtDate(r.createdAt)||'';
      const createdBy = (r.createdBy||r.userEmail||r.user||'')||'';

      const items = Array.isArray(r.items)? r.items : [];
      const rows = items.map(it=>{
        const vin = escapeHtml(it.vin||it.VIN||'');
        const car = escapeHtml(it.car||it.name||'');
        const trim = escapeHtml(it.trim||it.desc||'');
        return `<tr><td>${vin}</td><td>${car}</td><td>${trim}</td></tr>`;
      }).join('');

      const html = `
        <div class="muted" style="margin-bottom:10px">
          <b>نوع الطلب:</b> ${escapeHtml(type)} &nbsp; | &nbsp;
          <b>المكان المستهدف:</b> ${escapeHtml(target)} &nbsp; | &nbsp;
          <b>الحالة:</b> ${escapeHtml(status)} <br/>
          <b>تاريخ الطلب:</b> ${escapeHtml(createdAt)} &nbsp; | &nbsp;
          <b>المنشئ:</b> ${escapeHtml(createdBy)}
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>رقم الهيكل</th><th>السيارة</th><th>البيان</th></tr></thead>
            <tbody>${rows || '<tr><td colspan="3" class="small">لا توجد سيارات داخل الطلب</td></tr>'}</tbody>
          </table>
        </div>
      `;
      openDetailsModal(html, 'تفاصيل الطلب');
    }


    
    function openReqStageModal(stage){
      const arr0 = (stage===0) ? (dashReq.slice()) : dashReq.filter(r=>reqStage(r)==stage);
      const titles = {1:'تم استلام الطلب',2:'تم ارسال السيارة',3:'تم استلام السيارة',4:'تم الانتهاء'};
      const title = (stage===0) ? 'كل طلبات النقل' : (titles[stage] || 'طلبات');

      const uid = 'req_' + Date.now();
      const searchId = uid + '_q';
      const expId = uid + '_x';
      const tbodyId = uid + '_b';

      const render = (list)=> (list||[]).map(r=>{
        const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
        const itemsCount = (r.items||[]).length;
        return `<tr><td>${escapeHtml(type)}</td><td>${escapeHtml(r.targetLocation||r.toLocation||r.to||'')}</td><td>${escapeHtml(itemsCount.toString())}</td><td>${escapeHtml((r.createdBy||r.userEmail||r.user||'')||'')}</td><td>${escapeHtml(fmtDate(r.createdAt)||'')}</td><td><button class="btn secondary" data-req-details="${escapeHtml(r.id||r._id||'')}">تفاصيل</button></td></tr>`;
      }).join('');

      const html = `
        <div class="toolbar" style="gap:10px;align-items:flex-end;margin-bottom:10px">
          <div class="field" style="flex:1;min-width:220px">
            <label>بحث</label>
            <input id="${searchId}" placeholder="ابحث بالنوع / المكان / المنشئ / التاريخ" autocomplete="off" />
          </div>
          <div class="field" style="min-width:180px">
            <label>&nbsp;</label>
            <button class="btn" id="${expId}">تصدير Excel</button>
          </div>
        </div>

        <div class="tableWrap" style="max-height:520px">
          <table>
            <thead><tr><th>نوع الطلب</th><th>المكان المستهدف</th><th>عدد السيارات</th><th>المنشئ</th><th>تاريخ الطلب</th><th>الإجراء</th></tr></thead>
            <tbody id="${tbodyId}">${render(arr0) || '<tr><td colspan="6" class="small">لا توجد طلبات</td></tr>'}</tbody>
          </table>
        </div>`;

      openDetailsModal(html, title);

      const bindDetails = ()=>{
        document.querySelectorAll('[data-req-details]').forEach(b=>{
          b.addEventListener('click', ()=>{ const id=b.getAttribute('data-req-details'); if(id) openRequestDetails(id); });
        });
      };

      const apply = ()=>{
        const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
        const filtered = !q ? arr0 : arr0.filter(r=>{
          const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
          const hay = [type, r.targetLocation||r.toLocation||r.to||'', r.createdBy||r.userEmail||r.user||'', fmtDate(r.createdAt)||'', String((r.items||[]).length)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
          return hay.includes(q);
        });
        const tb = document.getElementById(tbodyId);
        if(tb) tb.innerHTML = render(filtered) || '<tr><td colspan="6" class="small">لا توجد طلبات</td></tr>';
        bindDetails();
      };

      const qEl = document.getElementById(searchId);
      if(qEl) qEl.addEventListener('input', apply);
      bindDetails();

      const expBtn = document.getElementById(expId);
      if(expBtn){
        expBtn.addEventListener('click', ()=>{
          const q = (document.getElementById(searchId)?.value||'').trim().toLowerCase();
          const filtered = !q ? arr0 : arr0.filter(r=>{
            const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
            const hay = [type, r.targetLocation||r.toLocation||r.to||'', r.createdBy||r.userEmail||r.user||'', fmtDate(r.createdAt)||'', String((r.items||[]).length)].map(x=>(x||'').toString().toLowerCase()).join(' | ');
            return hay.includes(q);
          });
          const headers = ['نوع الطلب','المكان المستهدف','عدد السيارات','المنشئ','تاريخ الطلب'];
          const rows = filtered.map(r=>{
            const type = (r.type==='transfer') ? 'نقل' : (r.type==='photo' ? 'تصوير' : (r.type||''));
            return [
              type,
              (r.targetLocation||r.toLocation||r.to||''),
              String((r.items||[]).length),
              (r.createdBy||r.userEmail||r.user||''),
              (fmtDate(r.createdAt)||'')
            ];
          });
          exportRowsToExcel(headers, rows, `requests_stage${stage}_${Date.now()}.xlsx`, 'requests');
        });
      }
    }

    
    
    // ===== Dashboard Cards: Saved cards + Data modal =====
    // ✅ لا LocalStorage: الحفظ/المشاركة تتم في Firestore لتظهر عند كل المستخدمين

    // 📌 ملاحظة مهمة:
    // عند بعض البيئات المسار يكون meta/list/... وعند بيئات أخرى meta/lists/...
    // عشان ما تتكرر مشكلة الصلاحيات/القراءة بين اليوزرات، بنستخدم مسارين (Primary + Fallback)

    const DASH_CFG_REFS = [
      db.collection('meta').doc('lists').collection('dashboard').doc('config'),  // primary
      db.collection('meta').doc('list').collection('dashboard').doc('config')    // fallback
    ];

    function getDashCfgRef(){
      return DASH_CFG_REFS[0];
    }

    // subscribe with fallback if primary fails (permissions / not found / etc)
    function subscribeDashCfg(onData, onErr){
      let unsub = null;
      let triedFallback = false;

      const startWith = (ref)=>{
        try{
          unsub = ref.onSnapshot((snap)=>{
            onData && onData(snap);
          }, async (err)=>{
            // permission-denied / not-found -> try fallback once
            const code = (err && (err.code || err.message || '')).toString();
            if(!triedFallback && (code.includes('permission') || code.includes('PERMISSION') || code.includes('missing') || code.includes('not-found'))){
              triedFallback = true;
              try{ if(unsub) unsub(); }catch(_){}
              return startWith(DASH_CFG_REFS[1]);
            }
            onErr && onErr(err);
          });
        }catch(e){
          if(!triedFallback){
            triedFallback = true;
            return startWith(DASH_CFG_REFS[1]);
          }
          onErr && onErr(e);
        }
      };

      startWith(DASH_CFG_REFS[0]);
      return ()=>{ try{ if(unsub) unsub(); }catch(_){} };
    }

    async function setDashCfg(patch){
      // best-effort write to both (so أي يوزر يقرأ من أي مسار يلاقي نفس الداتا)
      patch = patch || {};
      const ops = DASH_CFG_REFS.map(async (ref)=>{
        try{ await ref.set(patch, { merge:true }); }catch(e){ /* ignore */ }
      });
      await Promise.all(ops);
    }

    async function getDashCfgOnce(){
      // try primary then fallback
      for(const ref of DASH_CFG_REFS){
        try{
          const s = await ref.get();
          if(s && (s.exists===true || s.exists)) return (s.data()||{});
        }catch(e){}
      }
      return {};
    }

    let __dashCardsShared = []; // synced from Firestore

    function readSavedDashCards(){
      return Array.isArray(__dashCardsShared) ? __dashCardsShared.slice() : [];
    }
    async function writeSavedDashCards(arr){
      try{
        __dashCardsShared = Array.isArray(arr) ? arr.slice() : [];
        await setDashCfg({ savedCards: __dashCardsShared });
      }catch(e){
        console.warn('writeSavedDashCards error', e);
        toast('تعذر حفظ الكروت');
      }
    }
        function makeCardTitle(loc){
      return (loc && loc.trim()) ? loc.trim() : 'كل الأماكن';
    }
    function normalizeStatuses(arr){
      return Array.from(new Set((arr||[]).map(s=>(s||'').toString().trim()).filter(Boolean)));
    }

    function showModal(id){
      const b = document.getElementById(id);
      if(b) b.classList.add('show');
    }
    function hideModal(id){
      const b = document.getElementById(id);
      if(b) b.classList.remove('show');
    }

    
    // ===== Dashboard Data Modal (Search + Excel + Approvals per car) =====
    let dashDataLast = [];

    function dashDataRowMatches(c, q){
      const s = (q||'').toString().trim().toLowerCase();
      if(!s) return true;
      const blob = [
        c.vin, c.carName, c.statement, c.model, c.agent,
        c.interiorColor, c.exteriorColor, c.location, c.status
      ].map(x=>(x||'').toString().toLowerCase()).join(' | ');
      return blob.includes(s);
    }

    function dashDataFiltered(){
      const q = (document.getElementById('dashDataSearch')?.value||'').trim();
      return dashDataLast.filter(c=>dashDataRowMatches(c,q));
    }

    function exportRowsToExcel(headers, rows, filename, sheetName){
      try{
        if(typeof XLSX==='undefined' || !XLSX?.utils) throw new Error('XLSX not found');
        const aoa = [headers].concat(rows);
        const ws = XLSX.utils.aoa_to_sheet(aoa);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, sheetName || 'data');
        if(typeof downloadWorkbook==='function'){
          downloadWorkbook(wb, filename);
        }else{
          const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
          const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = filename;
          a.click();
          setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
        }
      }catch(e){
        console.error(e);
        toast('تعذر تصدير Excel');
      }
    }

    
    function getCarNotes(c){
      try{
        if(!c) return '';
        if(c.__note!=null && (c.__note+'').toString().trim()!=='') return (c.__note+'').toString().trim();

        const keys = [
          // ✅ حقول الملاحظات المستخدمة فعليًا في قاعدة البيانات
          'notesLocation','noteLocation','notesMissing','noteMissing',
          'notes','note','carNotes','notesText','generalNote','statusNote',
          'ملاحظات','ملاحظة',
          'ملاحظات_السيارة','ملاحظة_السيارة',
          'ملاحظات في السيارة','ملاحظات_في_السيارة'
        ];

        // direct fields
        for(const k of keys){
          if(c[k]!==undefined && c[k]!==null && (c[k]+'').toString().trim()!=='') return (c[k]+'').toString().trim();
        }

        // sometimes notes are nested
        if(c.data && typeof c.data==='object'){
          for(const k of keys){
            if(c.data[k]!==undefined && c.data[k]!==null && (c.data[k]+'').toString().trim()!=='') return (c.data[k]+'').toString().trim();
          }
        }
      }catch(_){}
      return '';
    }

    // Enrich dashboard modal rows with notes from cars/{VIN} if missing
    async function enrichDashCarsNotes(arr){
      try{
        if(!arr || !arr.length) return;
        if(typeof db==='undefined' || !db || !db.collection) return;

        const pickVin = (c)=>{
          try{
            const v = (c && (
              c.vin || c.VIN || c.id ||
              c['رقم الهيكل (VIN)'] || c['الهيكل (VIN)'] || c['رقم الهيكل'] || c['VIN#']
            )) || '';
            return (v+'').toString().trim();
          }catch(_){ return ''; }
        };

        const tryFetchFrom = async (colName, vin)=>{
          // 1) direct doc id = vin
          try{
            const snap = await db.collection(colName).doc(vin).get();
            if(snap && snap.exists){
              const d = snap.data() || {};
              const note = getCarNotes(d);
              if(note) return note;
            }
          }catch(_){}

          // 2) fallback queries (in case docId isn't VIN)
          const fields = ['vin','VIN','رقم الهيكل (VIN)','الهيكل (VIN)','رقم الهيكل'];
          for(const f of fields){
            try{
              const q = await db.collection(colName).where(f,'==',vin).limit(1).get();
              if(q && !q.empty){
                const d = (q.docs[0] && q.docs[0].data()) || {};
                const note = getCarNotes(d);
                if(note) return note;
              }
            }catch(_){}
          }
          return '';
        };

        const tasks = [];
        arr.forEach(c=>{
          const vin = pickVin(c);
          if(!vin) return;
          if(getCarNotes(c)) return; // already has notes

          tasks.push((async ()=>{
            try{
              // جرّب cars ثم erp_vins
              let note = await tryFetchFrom('cars', vin);
              if(!note) note = await tryFetchFrom('erp_vins', vin);
              if(note) c.__note = note;
            }catch(_){}
          })());
        });

        if(tasks.length) await Promise.all(tasks);
      }catch(_){}
    }

function openDashDataModal(title, cars, opts){
      opts = opts || {};
      const showNotes = !!opts.showNotes || (title||'').toString().includes('ملاحظات') || (title||'').toString().includes('بها ملاحظات');
      const dashModal = document.getElementById('dashDataModal');
      if(dashModal) dashModal.classList.toggle('showNotes', showNotes);

      dashDataLast = Array.isArray(cars)? cars.slice() : [];
      const t = document.getElementById('dashDataTitle');
      const meta = document.getElementById('dashDataMeta');
      const body = document.getElementById('dashDataBody');
      const search = document.getElementById('dashDataSearch');
      const exportBtn = document.getElementById('dashDataExport');

      if(t) t.textContent = title || 'عرض البيانات';
      if(search){ search.value=''; }

      function renderRows(list){
        if(meta) meta.textContent = `عدد النتائج: ${list.length}`;
        if(!body) return;
        body.innerHTML = list.map(c=>{
          const vin = escapeHtml(c.vin||c.VIN||'');
          const car = escapeHtml(c.carName||c.car||c.makeModel||c.name||'');
          const trim = escapeHtml(c.statement||c.trim||c.variant||c.desc||'');
          const year = escapeHtml((c.model||c.year||'').toString());
          const agent = escapeHtml(c.agent||c.dealer||c.agency||c.agentName||c.vendor||c.salesAgent||c['الوكيل']||c['وكيل']||'');
          const inC = escapeHtml(c.interiorColor||c.interior||'');
          const outC = escapeHtml(c.exteriorColor||c.exterior||'');
          const loc = escapeHtml(c.location||'');
          const stN = normStatus(c.status||'');
          const st = escapeHtml(stN||c.status||'');

          const canApprove = (stN==='مباع تحت التسليم');
          let apprCell = `<span class="muted">—</span>`;
          if(canApprove){
            const a = c.approvals || {};
            const n = c.approvalsNotes || {};
            const finOk = (a.financial===true);
            const admOk = (a.admin===true);
            const finNote = ((n.financial!=null?n.financial:(a.financialNote||''))||'').toString();
            const admNote = ((n.admin!=null?n.admin:(a.adminNote||''))||'').toString();
            apprCell = `
              <div style="display:flex;flex-direction:column;gap:6px">
                <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center">
                  <span class="tag ${admOk?'ok':'no'}">إداري: ${admOk?'✓':'✗'}</span>
                  <span class="tag ${finOk?'ok':'no'}">مالي: ${finOk?'✓':'✗'}</span>
</div>
                <div class="small" style="line-height:1.4"><b>ملاحظة إدارية:</b> ${escapeHtml(admNote)||'—'}</div>
                <div class="small" style="line-height:1.4"><b>ملاحظة مالية:</b> ${escapeHtml(finNote)||'—'}</div>
              </div>`;
          }

          return `<tr>
            <td>${vin}</td>
            <td>${car}</td>
            <td>${trim}</td>
            <td>${year}</td>
            <td>${agent}</td>
            <td>${inC}</td>
            <td>${outC}</td>
            <td>${loc}</td>
            <td>${st}</td>
            <td class="dashNotesCol">${escapeHtml(getCarNotes(c))||'—'}</td>
            <td>${apprCell}</td>
          </tr>`;
        }).join('');

        // bind approvals buttons
        body.querySelectorAll('[data-approve-vin]').forEach(b=>{
          b.addEventListener('click', ()=>{
            const vin = b.getAttribute('data-approve-vin');
            if(vin) openCarApprovalsModal(vin);
          });
        });
      }

      // initial
      renderRows(dashDataLast);

      // if notes missing, fetch them from cars/{VIN} then rerender
      (async ()=>{
        try{
          if(showNotes){
            await enrichDashCarsNotes(dashDataLast);
            renderRows(dashDataFiltered());
          }
        }catch(_){}
      })();


      // wire search
      if(search){
        const onSearch = ()=> renderRows(dashDataFiltered());
        search.oninput = onSearch;
      }

      // wire export
      if(exportBtn){
        exportBtn.onclick = ()=>{
          const list = dashDataFiltered();
          const headers = ['VIN','السيارة','البيان','موديل','الوكيل','الداخلي','الخارجي','المكان','الحالة']
            .concat((document.getElementById('dashDataModal')?.classList.contains('showNotes')) ? ['ملاحظات'] : []);
          const rows = list.map(c=>{
            const base = [
              c.vin||'', c.carName||'', c.statement||'', c.model||'', c.agent||'',
              c.interiorColor||'', c.exteriorColor||'', c.location||'', (normStatus(c.status)||c.status||'')
            ];
            if(document.getElementById('dashDataModal')?.classList.contains('showNotes')) base.push(getCarNotes(c)||'');
            return base;
          });
          exportRowsToExcel(headers, rows, 'dashboard_cars.xlsx', 'cars');
        };
      }

      showModal('dashDataModal');
    }


    
    function filterCars(location, statuses){
      const locWanted = norm(location||'');
      // statuses قد تأتي String من الـ KPI
      if(typeof statuses === 'string' && statuses.trim()) statuses = [statuses.trim()];
      if(!Array.isArray(statuses)) statuses = (statuses ? [statuses] : []);
      const setWanted = new Set((statuses||[]).map(s=>normStatus(s)));
      return dashCars.filter(c=>{
        const locOk = !locWanted || norm(c.location||'')===locWanted;
        if(!locOk) return false;
        if(!setWanted.size) return true;
        const st = normStatus(c.status||'');
        return setWanted.has(st);
      });
    }


    function openCarsModalByFilter(location, statuses){
      // statuses قد تأتي String من الـ KPI
      if(typeof statuses === 'string' && statuses.trim()) statuses = [statuses.trim()];
      if(!Array.isArray(statuses)) statuses = (statuses ? [statuses] : []);
      const cars = filterCars(location, statuses);
      const showNotes = statuses.map(s=>normStatus(s)).includes('بها ملاحظات');
      openDashDataModal(makeCardTitle(location), cars, { showNotes });
    }

    function renderSavedDashCards(){
      const host = document.getElementById('dash_saved_cards');
      if(!host) return;
      const cards = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
      const __delAllow = ['ceo@mzjcars.com','mr.ahmed_rashed@outlook.sa'];
      const __curEmail = ((auth && auth.currentUser && auth.currentUser.email) ? auth.currentUser.email : '').toString().trim().toLowerCase();
      const __canDeleteSaved = __delAllow.includes(__curEmail);

      host.innerHTML = (cards||[]).map(card=>{
        const loc = (card.location||'').toString().trim();
        const title = escapeHtml(makeCardTitle(loc)); // اسم المكان فقط
        const statuses = (card.statuses||[]);
        const all = filterCars(loc, statuses);
        const countBy = (st)=> filterCars(loc, [st]).length;

        const totalActual = all.filter(x=>['متاح للبيع','حجز','بها ملاحظات'].includes(normStatus((x.status||'').toString().trim()))).length; 
const list = statuses.length ? statuses : ['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم','مباع تم التسليم'];

        const kpis = [];
        kpis.push(`<div class="dashKpi kpiHighlight" data-card="${escapeHtml(card.id)}" data-kpi="totalActual"><div>الإجمالي الفعلي</div><b>${totalActual}</b></div>`); 
list.forEach(st=>{
          kpis.push(`<div class="dashKpi" data-card="${escapeHtml(card.id)}" data-status="${escapeHtml(st)}"><div>${escapeHtml(st)}</div><b>${countBy(st)}</b></div>`);
        });

        return `
          <div class="card dashCard">
            <h3>${title}</h3>
            <div class="body">
              <div class="dashKpis">${kpis.join('')}</div>
              <div class="dashBtns">
                <button class="btn secondary" data-saved-open="${escapeHtml(card.id)}">عرض</button>
                <button class="btn danger" data-saved-del="${escapeHtml(card.id)}" ${__canDeleteSaved ? "" : "disabled style=\"opacity:.55;cursor:not-allowed\" title=\"صلاحية للحسابات: ceo@mzjcars.com / mr.ahmed_rashed@outlook.sa\""}>حذف</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      // bind open
      host.querySelectorAll('[data-saved-open]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-saved-open');
          const cards2 = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
          const c = (cards2||[]).find(x=>x.id===id);
          if(!c) return;
          openCarsModalByFilter((c.location||''), (c.statuses||[]));
        });
      });

      // bind delete
      host.querySelectorAll('[data-saved-del]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-saved-del');
          if(!id) return;
          if(!__canDeleteSaved){ toast('غير مصرح بحذف الكروت'); return; }
          if(!confirm('حذف هذا الكارت؟')) return;
          if(typeof deleteDashCard === 'function'){
            await deleteDashCard(id);
          }else{
            const cards3 = (readSavedDashCards ? readSavedDashCards() : []).filter(c=>c.id!==id);
            if(typeof writeSavedDashCards === 'function') writeSavedDashCards(cards3);
          }
          renderSavedDashCards();
          toast('تم الحذف');
        });

      // KPI clicks داخل الكروت المحفوظة (الإجمالي الفعلي)
      host.querySelectorAll('[data-kpi="totalActual"]').forEach(kpi=>{
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=>{
          const cardId = kpi.getAttribute('data-card') || '';
          const cards2 = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
          const c = (cards2||[]).find(x=>x.id===cardId);
          if(!c) return;
          const cars = filterCars((c.location||''), (c.statuses||[]))
            .filter(x=>!['مباع تحت التسليم','مباع تم التسليم'].includes(normStatus(x.status||'')));
          openDashDataModal('الإجمالي الفعلي', cars);
        });
      });

      });

      // KPI clicks
      host.querySelectorAll('.dashKpi[data-status]').forEach(k=>{
        k.style.cursor='pointer';
        k.addEventListener('click', ()=>{
          const id = k.getAttribute('data-card');
          const st = k.getAttribute('data-status');
          const cards4 = (typeof getDashCardsFromCache === 'function') ? getDashCardsFromCache() : (readSavedDashCards ? readSavedDashCards() : []);
          const c = (cards4||[]).find(x=>x.id===id);
          if(!c) return;
          openCarsModalByFilter((c.location||''), [st]);
        });
      });
    }


    
    // ===== Dashboard: Missing branches cards =====
    // ✅ لا LocalStorage: اختيار الفروع يتم حفظه في Firestore ليظهر عند كل المستخدمين.

    let __missingCard = null; // { branches: [] }
    let __missingRowsLast = [];
    let __missingBranchesList = []; // loaded from Firestore: meta/lists/branches

    let __missingLastRows = [];
    let __missingLastTitle = 'نواقص الفروع';

    async function loadMissingBranchesList(){
      try{
        const arr = [];

        // 1) المسار المعتمد: meta/lists/branches (collection)
        let snap = null;
        try{ snap = await db.collection('meta').doc('lists').collection('branches').get(); }catch(e){}
        // 1.1) fallback: meta/list/branches
        if(!snap){ try{ snap = await db.collection('meta').doc('list').collection('branches').get(); }catch(e){} }
        (snap||{forEach:()=>{}}).forEach(d=>{
          const data = d.data() || {};
          const name = (data.name || data.title || data.branch || data.value || d.id || '').toString().trim();
          if(name) arr.push(name);
        });

        // 2) fallback: لو القائمة فاضية (فيه أنظمة بتخزنها Array داخل doc meta/lists)
        if(!arr.length){
          const docSnap = await db.collection('meta').doc('lists').get();
          if((docSnap && (docSnap.exists === true || docSnap.exists)) || (docSnap && typeof docSnap.exists==='function' && docSnap.exists())){
            const data = docSnap.data() || {};
            const listArr =
              (Array.isArray(data.branches) ? data.branches :
               Array.isArray(data.locations) ? data.locations :
               Array.isArray(data.places) ? data.places : []);
            (listArr||[]).forEach(x=>{
              const name = (x && (x.name||x.title||x.value)) ? (x.name||x.title||x.value) : x;
              const n = (name||'').toString().trim();
              if(n) arr.push(n);
            });
          }
        }

        __missingBranchesList = Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b,'ar'));
        try{ window.__missingBranchesList = __missingBranchesList; }catch(e){}
      }catch(e){
        console.warn('loadMissingBranchesList error', e);
        __missingBranchesList = [];
        try{ window.__missingBranchesList = __missingBranchesList; }catch(e){}
      }
    }
        try{ window.__missingBranchesList = __missingBranchesList; }catch(e){}

    function renderMissingBranchesChecks(){
      const host = document.getElementById('dash_missing_branches');
      if(!host) return;
      host.innerHTML = '';
      const selected = new Set((__missingCard?.branches)||[]);
      (__missingBranchesList||[]).forEach(name=>{
        const v = (name||'').toString().trim();
        if(!v) return;
        const lab = document.createElement('label');
        lab.className = 'dashChk';
        lab.innerHTML = `<input type="checkbox" value="${escapeHtml(v)}" ${selected.has(v)?'checked':''}/> ${escapeHtml(v)}`;
        host.appendChild(lab);
      });
    }

    function getSelectedMissingBranchesFromUI(){
      const host = document.getElementById('dash_missing_branches');
      if(!host) return [];
      const arr = [];
      host.querySelectorAll('input[type="checkbox"]')?.forEach(ch=>{
        if(ch.checked){
          const v = (ch.value||'').toString().trim();
          if(v) arr.push(v);
        }
      });
      // unique
      return Array.from(new Set(arr));
    }

    function openMissingModal(title, rows){
      __missingLastTitle = title || 'نواقص الفروع';
      __missingLastRows = Array.isArray(rows) ? rows.slice() : [];
      const t = document.getElementById('missingTitle');
      const s = document.getElementById('missingSearch');
      if(t) t.textContent = __missingLastTitle;
      if(s) s.value = '';
      renderMissingModalRows(__missingLastRows);
      showModal('missingModal');
    }

    
    // ===== Missing Branches: compute rows by تركيبـة (السيارة+البيان+ألوان+موديل+سنة) =====
    function __mb_norm(v){ return (v||'').toString().trim(); }
    function __mb_key(c){
      // التركيبة: (السيارة + البيان + اللون الداخلي + اللون الخارجي + الموديل)
      return [
        __mb_norm(c.carName),
        __mb_norm(c.statement),
        __mb_norm(c.interiorColor),
        __mb_norm(c.exteriorColor),
        __mb_norm(c.model)
      ].join('||');
    }

    function __mb_isActual(st){
      const s = __mb_norm(st);
      return (s==='متاح للبيع' || s==='محجوز' || s==='حجز' || s==='بها ملاحظات');
    }

    function buildMissingRowsForBranch(branch){
      const br = __mb_norm(branch);
      if(!br) return [];

      // المصدر: مجموع "الإجمالي الفعلي" للمستودع + الفروع (بدون الوكالة)
      // نعتمد على قائمة الفروع المحمّلة، ولو فاضية نستخدم fallback
      let allowed = Array.isArray(__missingBranchesList) ? __missingBranchesList.slice() : [];
      if(!allowed.length){
        allowed = ['الملتقى','القادسية','الصالة','المستودع'];
      }
      const allowedSet = new Set(allowed.map(__mb_norm).filter(x=>x && x!=='الوكالة'));

      const totals = new Map();        // key -> total count across (المستودع + الفروع)
      const branchCounts = new Map();  // key -> count in this branch

      (dashCars||[]).forEach(c=>{
        // الإجمالي الفعلي = نفس حالات الـ KPI: متاح للبيع/محجوز/بها ملاحظات
        if(!__mb_isActual(c.status)) return;

        const loc = __mb_norm(c.location);
        if(!allowedSet.has(loc)) return;

        const key = __mb_key(c);
        if(!key) return;

        // total across allowed locations
        totals.set(key, (totals.get(key)||0) + 1);

        // count in branch only
        if(loc===br) branchCounts.set(key, (branchCounts.get(key)||0) + 1);
      });

      const rows = [];
      totals.forEach((totalCount, key)=>{
        const bCount = branchCounts.get(key) || 0;
        // النقص: لو كمية الفرع = 0 مع وجود نفس التركيبة في الإجمالي العام
        if(bCount===0 && totalCount>0){
          const parts = key.split('||');
          rows.push({
            carName: parts[0]||'',
            statement: parts[1]||'',
            interiorColor: parts[2]||'',
            exteriorColor: parts[3]||'',
            model: parts[4]||'',
            branchCount: 0,
            totalCount: totalCount
          });
        }
      });

      // sort for stable view
      rows.sort((a,b)=>{
        const A = (a.carName+a.model+a.exteriorColor+a.interiorColor+a.statement).toString();
        const B = (b.carName+b.model+b.exteriorColor+b.interiorColor+b.statement).toString();
        return A.localeCompare(B,'ar');
      });

      return rows;
    }

    
    async function __ensureDashCarsReady(){
      try{
        // if already has data, no need to wait
        if(Array.isArray(dashCars) && dashCars.length) return true;
        // wait up to 4 seconds for first snapshot
        const t = new Promise((_,rej)=>setTimeout(()=>rej(new Error('timeout')), 4000));
        await Promise.race([dashCarsReady, t]);
        return true;
      }catch(e){
        return false;
      }
    }

    // expose readiness helper for other scripts (e.g. نواقص السيارات)
    try{ window.__ensureDashCarsReady = __ensureDashCarsReady; }catch(e){}

    async function openMissingBranchesForBranch(branchName){
      const br = (branchName||'').toString();
      // open modal immediately with loading to give instant feedback
      __missingRowsLast = [];
      const t = document.getElementById('missingTitle'); if(t) t.textContent = 'نواقص: ' + br;
      const q = document.getElementById('missingSearch'); if(q) q.value = '';
      const tbody = document.getElementById('missingBody'); if(tbody) tbody.innerHTML = '<tr><td colspan="7" class="muted">جاري تحميل البيانات…</td></tr>';
      const cntEl = document.getElementById('missingCount'); if(cntEl) cntEl.textContent = '—';
      const meta = document.getElementById('missingMeta'); if(meta) meta.textContent = 'جاري تحميل بيانات المخزون…';
      showModal('missingModal');

      // ensure dashCars snapshot arrived
      await __ensureDashCarsReady();

      const rows = buildMissingRowsForBranch(br);
      openMissingBranchesModal('نواقص: ' + br, rows);
    }

function openMissingBranchesModal(title, rows){
      // استخدم المودال الثابت (missingModal) علشان يفتح في نص الصفحة زي باقي الكروت
      __missingRowsLast = Array.isArray(rows) ? rows : [];
      const t = document.getElementById('missingTitle');
      if(t) t.textContent = title || 'نواقص الفروع';

      // reset search
      const q = document.getElementById('missingSearch');
      if(q) q.value = '';

      // render rows
      renderMissingModalRows(__missingRowsLast);

      // meta
      const cntEl = document.getElementById('missingCount');
      if(cntEl) cntEl.innerHTML = `الإجمالي: <b>${__missingRowsLast.length}</b>`; 
      const sub = document.getElementById('missingSubMeta');
      if(sub) sub.textContent = 'اضغط على تصدير Excel لتحميل النواقص';

      const meta = document.getElementById('missingMeta');
      if(meta) meta.textContent = __missingRowsLast.length ? 'التركيبات المعروضة هي التركيبات المتوفرة في الإجمالي العام وكميتها = 0 داخل الفرع.' : 'لا توجد نواقص لهذا الفرع.';

      showModal('missingModal');
    }

    function renderMissingModalRows(rows){
      const tbody = document.getElementById('missingBody');
      if(!tbody) return;
      const arr = Array.isArray(rows) ? rows : [];
      tbody.innerHTML = arr.length ? arr.map(r=>`
        <tr>
          <td>${escapeHtml(r.carName||'')}</td>
          <td>${escapeHtml(r.statement||'')}</td>
          <td>${escapeHtml(r.interiorColor||'')}</td>
          <td>${escapeHtml(r.exteriorColor||'')}</td>
          <td>${escapeHtml(r.model||'')}</td>
          <td>${escapeHtml(String(r.branchCount??0))}</td>
          <td>${escapeHtml(String(r.totalCount??r.totalAll??0))}</td>
        </tr>
      `).join('') : `<tr><td colspan="7" class="muted" style="text-align:center">لا توجد نواقص</td></tr>`;
    }

    // ===== Dashboard Card: اجمالي المخزون =====
    function renderTotalStockCard(){
      const host = document.getElementById('dash_total_stock_card');
      if(!host) return;

      // الفلاتر الأساسية
      const underCars     = dashCars.filter(c=>normStatus(c.status)==='مباع تحت التسليم');
      const deliveredCars = dashCars.filter(c=>normStatus(c.status)==='مباع تم التسليم');
      const notesCars     = dashCars.filter(c=>normStatus(c.status)==='بها ملاحظات');
      const agencyAll     = dashCars.filter(c=>((c.location||'').toString().trim()==='الوكالة'));

      // ✅ الإجمالي الفعلي = إجمالي السيارات بدون (مباع تحت التسليم) - (مباع تم التسليم)
      const totalActualCars = dashCars.filter(c=>!['مباع تحت التسليم','مباع تم التسليم'].includes(normStatus(c.status)) && !isCarArchived(c));
      const totalActual = totalActualCars.length;

      // ✅ المتاح للبيع (حسب تعريفك): الإجمالي الفعلي لكل الفروع بدون الوكالة
      const availCars  = totalActualCars.filter(c=>((c.location||'').toString().trim()!=='الوكالة') && !isCarArchived(c));

      // ✅ الوكالة (ضمن الإجمالي الفعلي)
      const agencyCars = totalActualCars.filter(c=>((c.location||'').toString().trim()==='الوكالة'));


      host.innerHTML = `
        <div class="card dashCard" id="dash_total_stock_one" style="min-height:260px">
          <div class="cardHead">
            <h3 style="margin:0">اجمالي المخزون</h3>
          </div>
          <div class="body">
            <div class="dashKpis" style="margin-bottom:10px">
              <div class="dashKpi kpiHighlight" data-totalstock="totalActual" style="cursor:pointer"><span>الإجمالي الفعلي</span><b>${totalActual}</b></div>
            </div>

            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn secondary" type="button" data-totalstock="agency">الوكالة (${agencyCars.length})</button>
              <button class="btn secondary" type="button" data-totalstock="avail">المتاح للبيع (${availCars.length})</button>
              <button class="btn secondary" type="button" data-totalstock="notes">بها ملاحظات (${notesCars.length})</button>
              <button class="btn secondary" type="button" data-totalstock="under">مباع تحت التسليم (${underCars.length})</button>
            </div>

            <div class="muted" style="margin-top:10px">الإجمالي الفعلي = إجمالي السيارات بدون (مباع تحت التسليم) - (مباع تم التسليم)</div>
          </div>
        </div>
      `;

      host.querySelectorAll('[data-totalstock]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const k = btn.getAttribute('data-totalstock') || '';
          if(k==='totalActual') return openDashDataModal('الإجمالي الفعلي', totalActualCars);
          if(k==='agency') return openDashDataModal('الوكالة (ضمن الإجمالي الفعلي)', agencyCars);
          if(k==='avail')  return openDashDataModal('المتاح للبيع', availCars);
          if(k==='notes')  return openDashDataModal('بها ملاحظات', notesCars);
          if(k==='under')  return openDashDataModal('مباع تحت التسليم', underCars);
        });
      });
    }



function renderMissingSavedCard(){
      const host = document.getElementById('dash_missing_saved_cards');
      if(!host) return;

      if(!__missingCard || !Array.isArray(__missingCard.branches) || !__missingCard.branches.length){
        host.innerHTML = '';
        const meta = document.getElementById('dash_missing_meta');
        if(meta) meta.textContent = '—';
        return;
      }

      const branches = __missingCard.branches.slice();
      const items = branches.map(br=>{
        const rows = buildMissingRowsForBranch(br);
        const cnt = rows.length;
        return `
          <button class="linkBtn" type="button"
            data-missing-branch="${escapeHtml(br)}"
            style="border-radius:999px">
            ${escapeHtml(br)} <span class="tag ${cnt? 'no':'ok'}" style="margin-right:8px">${cnt}</span>
          </button>`;
      }).join('');

      host.innerHTML = `
        <div class="card dashCard" id="dash_missing_card_one" style="min-height:260px">
          <div class="cardHead" style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <h3 style="margin:0">نواقص الفروع</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn secondary" type="button" id="dash_missing_edit">تعديل</button>
              <button class="btn danger" type="button" id="dash_missing_delete">حذف</button>
            </div>
          </div>
          <div class="body">
            <div class="small" style="margin-bottom:10px">اضغط على اسم الفرع لعرض النواقص</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap">${items || '<span class="muted">—</span>'}</div>
          </div>
        </div>
      `;

      // تقييد زر حذف كارت نواقص الفروع ليوزرات محددة
      try{
        const delBtn = document.getElementById('dash_missing_delete');
        if(delBtn) delBtn.style.display = canUseDashDanger() ? '' : 'none';
      }catch(_e){}

      // bind branch click
      host.querySelectorAll('[data-missing-branch]')?.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const br = (btn.getAttribute('data-missing-branch')||'').toString();
          openMissingBranchesForBranch(br);
        });
      });

      // edit/delete
      document.getElementById('dash_missing_edit')?.addEventListener('click', ()=>{
        // open config modal
        renderMissingBranchesChecks();
        const meta = document.getElementById('dash_missing_meta');
        if(meta) meta.textContent = 'وضع التعديل: اختر/احذف فروع ثم اضغط حفظ';
        const m = document.getElementById('dashMissingCfgModal');
        if(m) m.classList.add('show');
      });

document.getElementById('dash_missing_delete')?.addEventListener('click', async ()=>{
        if(!canUseDashDanger()) return toast('غير مصرح لك باستخدام زر الحذف');
        try{
          await setDashCfg({ missingBranches: [] });
          toast('تم حذف كارت النواقص للجميع');
        }catch(e){
          console.warn(e);
          toast('تعذر حذف الكارت');
        }
      });

      const meta = document.getElementById('dash_missing_meta');
      if(meta) meta.textContent = `عدد الفروع داخل الكارت: ${branches.length}`;
    }

    function bindMissingBranchesUI(){
      // Config modal close
      const cfgModal = document.getElementById('dashMissingCfgModal');
      const cfgClose = document.getElementById('dashMissingCfgClose');
      if(cfgClose) cfgClose.addEventListener('click', ()=>{ if(cfgModal) cfgModal.classList.remove('show'); });
      if(cfgModal) cfgModal.addEventListener('click', (e)=>{ if(e.target===cfgModal) cfgModal.classList.remove('show'); });


      // ✅ ضمان فتح مودال النواقص عند الضغط على زر الفرع دائمًا
      // بعض الكروت بتُعاد رندرها، فبنستخدم تفويض حدث عالمي مرة واحدة
      if(!window.__missingBranchGlobalClickBound){
        window.__missingBranchGlobalClickBound = true;
        document.addEventListener('click', (ev)=>{
          const btn = ev.target?.closest ? ev.target.closest('[data-missing-branch]') : null;
          if(!btn) return;
          ev.preventDefault();
          ev.stopPropagation();
          const br = (btn.getAttribute('data-missing-branch')||'').toString();
          const rows = buildMissingRowsForBranch(br);
          openMissingBranchesModal('نواقص: ' + br, rows);
        }, true); // capture
      }
      // close modal
      document.getElementById('missingClose')?.addEventListener('click', ()=>hideModal('missingModal'));
      document.getElementById('missingModal')?.addEventListener('click', (e)=>{
        if(e.target && e.target.id==='missingModal') hideModal('missingModal');
      });

      // فتح مودال النواقص عند الضغط على أي فرع داخل كارت نواقص الفروع (تفويض event delegation)
      const __mbHost = document.getElementById('dash_missing_saved_cards');
      __mbHost?.addEventListener('click', (ev)=>{
        const btn = ev.target?.closest ? ev.target.closest('[data-missing-branch]') : null;
        if(!btn) return;
        const br = (btn.getAttribute('data-missing-branch')||'').toString();
        const rows = buildMissingRowsForBranch(br);
        openMissingBranchesModal('نواقص: ' + br, rows);
      });


      // بحث داخل مودال النواقص
      document.getElementById('missingSearch')?.addEventListener('input', (e)=>{
        const term = ((e.target && e.target.value) || '').toString().trim().toLowerCase();
        const arr = Array.isArray(__missingRowsLast) ? __missingRowsLast : [];
        const filtered = !term ? arr : arr.filter(r=>{
          const hay = [
            r.carName, r.statement, r.interiorColor, r.exteriorColor, r.model,
            String(r.branchCount ?? 0), String(r.totalCount ?? 0)
          ].join(' ').toLowerCase();
          return hay.includes(term);
        });

        renderMissingModalRows(filtered);
        const meta = document.getElementById('missingMeta');
        if(meta) meta.textContent = `عدد النتائج: ${filtered.length}`;
        const cc = document.getElementById('missingCount');
        if(cc) cc.innerHTML = `الإجمالي: <b>${filtered.length}</b>`;       });

      // تصدير Excel
      document.getElementById('missingExport')?.addEventListener('click', ()=>{
        try{
          const headers = ['السيارة','البيان','اللون الداخلي','اللون الخارجي','الموديل','عدد الفرع','الإجمالي العام'];
          const rows = (Array.isArray(__missingRowsLast) ? __missingRowsLast : []).map(r=>[
            r.carName||'',
            r.statement||'',
            r.interiorColor||'',
            r.exteriorColor||'',
            r.model||'',
            String(r.branchCount ?? 0),
            String(r.totalCount ?? 0),
          ]);
          exportRowsToExcel(headers, rows, `missing_branches_${Date.now()}.xlsx`, 'missing');
        }catch(err){
          console.warn(err);
          toast('تعذر التصدير');
        }
      });

      // save selection (no local storage)
      document.getElementById('dash_missing_save')?.addEventListener('click', async ()=>{
        const sel = getSelectedMissingBranchesFromUI();
        if(!sel.length){
          toast('اختر فرع واحد على الأقل');
          return;
        }
        try{
          await setDashCfg({ missingBranches: sel });
          toast('تم حفظ كارت النواقص للجميع');
        }catch(e){
          console.warn(e);
          toast('تعذر حفظ كارت النواقص');
        }
      });

      // clear selection (UI only)
      document.getElementById('dash_missing_clear')?.addEventListener('click', ()=>{
        const host = document.getElementById('dash_missing_branches');
        host?.querySelectorAll('input[type="checkbox"]')?.forEach(ch=>ch.checked=false);
        toast('تم تفريغ الاختيار');
      });
    }

    async function initMissingBranchesFeature(){
      await loadMissingBranchesList();

      // 🔴 sync selection from Firestore (shared for all users)
      try{
        subscribeDashCfg((snap)=>{
          const d = snap.exists ? (snap.data()||{}) : {};
          const sel = Array.isArray(d.missingBranches) ? d.missingBranches : [];
          __missingCard = sel.length ? { branches: sel.slice() } : null;
          renderMissingBranchesChecks();
          renderMissingSavedCard();
        }, (err)=>{
          console.warn('missingBranches onSnapshot', err);
        });
      }catch(e){
        console.warn('missingBranches live init error', e);
      }

      renderMissingBranchesChecks();
      renderMissingSavedCard();
      bindMissingBranchesUI();
    }

function bindDashboardActions(){
      // Dashboard data modal close (no refresh needed)
      const dashDataModal = document.getElementById('dashDataModal');
      const dashDataClose = document.getElementById('dashDataClose');
      if(dashDataClose) dashDataClose.addEventListener('click', ()=>{ if(dashDataModal) dashDataModal.classList.remove('show'); });
      if(dashDataModal) dashDataModal.addEventListener('click', (e)=>{ if(e.target===dashDataModal) dashDataModal.classList.remove('show'); });

      // Missing Branches Feature (نواقص الفروع)
      try{ initMissingBranchesFeature(); }catch(e){}

      // 🔴 Sync shared dashboard cards from Firestore (no localStorage)
      try{
        subscribeDashCfg((snap)=>{
          const d = snap.exists ? (snap.data()||{}) : {};
          __dashCardsShared = Array.isArray(d.savedCards) ? d.savedCards : [];
          // re-render cards if dashboard is visible
          try{ renderSavedDashCards(); }catch(_){}
        }, (err)=>console.warn('dashboard cards onSnapshot', err));
      }catch(e){
        console.warn('dashboard cards live init error', e);
      }

      // Inventory quick buttons -> OPEN MODAL (not navigate)
      const openBy = (loc, statuses)=> openCarsModalByFilter((loc||'').toString(), Array.isArray(statuses)? statuses: []);
      const btnAgency = document.getElementById('btn_go_agency');
      if(btnAgency) btnAgency.addEventListener('click', ()=> openBy('الوكالة', []));
      document.querySelectorAll('[data-go-status]').forEach(btn=>{
        btn.addEventListener('click', ()=> openBy('', [btn.getAttribute('data-go-status')]));
      });
      document.querySelectorAll('[data-go-location]').forEach(btn=>{
        btn.addEventListener('click', ()=> openBy(btn.getAttribute('data-go-location')||'', []));
      });

      // Requests stages buttons
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=> openReqStageModal(parseInt(btn.getAttribute('data-req-stage')||'0',10)));
      });

      // KPI clicks (totals + statuses) -> OPEN MODAL
      const kpiMap = {
        // Stock (all)
        'stk_totalActual': {loc:'', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'stk_keysTotal' : {loc:'', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'stk_avail'     : {loc:'', statuses:['متاح للبيع']},
        'stk_reserved'  : {loc:'', statuses:['حجز']},
        'stk_notes'     : {loc:'', statuses:['بها ملاحظات']},
        'stk_under'     : {loc:'', statuses:['مباع تحت التسليم']},
        'stk_delivered' : {loc:'', statuses:['مباع تم التسليم']},

        // Agency
        'ag_totalActual': {loc:'الوكالة', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'ag_keysTotal' : {loc:'الوكالة', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'ag_avail'     : {loc:'الوكالة', statuses:['متاح للبيع']},
        'ag_reserved'  : {loc:'الوكالة', statuses:['حجز']},
        'ag_notes'     : {loc:'الوكالة', statuses:['بها ملاحظات']},
        'ag_under'     : {loc:'الوكالة', statuses:['مباع تحت التسليم']},
        'ag_delivered' : {loc:'الوكالة', statuses:['مباع تم التسليم']},

        // Branch 1: الصالة
        'b1_totalActual': {loc:'الصالة', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b1_keysTotal' : {loc:'الصالة', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b1_avail'     : {loc:'الصالة', statuses:['متاح للبيع']},
        'b1_reserved'  : {loc:'الصالة', statuses:['حجز']},
        'b1_notes'     : {loc:'الصالة', statuses:['بها ملاحظات']},
        'b1_under'     : {loc:'الصالة', statuses:['مباع تحت التسليم']},
        'b1_delivered' : {loc:'الصالة', statuses:['مباع تم التسليم']},

        // Branch 2: الملتقى
        'b2_totalActual': {loc:'الملتقى', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b2_keysTotal' : {loc:'الملتقى', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b2_avail'     : {loc:'الملتقى', statuses:['متاح للبيع']},
        'b2_reserved'  : {loc:'الملتقى', statuses:['حجز']},
        'b2_notes'     : {loc:'الملتقى', statuses:['بها ملاحظات']},
        'b2_under'     : {loc:'الملتقى', statuses:['مباع تحت التسليم']},
        'b2_delivered' : {loc:'الملتقى', statuses:['مباع تم التسليم']},

        // Branch 3: القادسية
        'b3_totalActual': {loc:'القادسية', statuses:['متاح للبيع','محجوز','بها ملاحظات']},
        'b3_keysTotal' : {loc:'القادسية', statuses:['متاح للبيع','محجوز','بها ملاحظات','مباع تحت التسليم']},
        'b3_avail'     : {loc:'القادسية', statuses:['متاح للبيع']},
        'b3_reserved'  : {loc:'القادسية', statuses:['حجز']},
        'b3_notes'     : {loc:'القادسية', statuses:['بها ملاحظات']},
        'b3_under'     : {loc:'القادسية', statuses:['مباع تحت التسليم']},
        'b3_delivered' : {loc:'القادسية', statuses:['مباع تم التسليم']},
      };

      Object.keys(kpiMap).forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi') || el;
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=>{
          const cfg = kpiMap[id];
          openBy(cfg.loc, cfg.statuses);
        });
      });

      // Requests KPI numbers clickable too
      const rqIds = { 'rq_s1':1, 'rq_s2':2, 'rq_s3':3, 'rq_s4':4 };
      Object.keys(rqIds).forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const kpi = el.closest('.dashKpi') || el;
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=> openReqStageModal(rqIds[id]));
      });

      // go inventory by status/location
      document.querySelectorAll('[data-go-status]').forEach(btn=>{
        btn.addEventListener('click', ()=> openCarsModalByFilter('', [btn.getAttribute('data-go-status')]));
      });
      document.querySelectorAll('[data-go-location]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const loc = btn.getAttribute('data-go-location')||'';
          openCarsModalByFilter(loc, []);
        });
      });
      const goAgency = document.getElementById('btn_go_agency');
      if(goAgency) goAgency.addEventListener('click', ()=> openCarsModalByFilter('الوكالة', []));

      // approvals (فتح المودال بالضغط على الأرقام)
      const apNeedFin = document.getElementById('ap_need_fin');
      const apNeedAdm = document.getElementById('ap_need_adm');
      const apReady   = document.getElementById('ap_ready');
      const apTitle   = document.getElementById('dash_ap_title');

      if(apNeedFin){ apNeedFin.style.cursor='pointer'; apNeedFin.title=''; apNeedFin.addEventListener('click', ()=>openApprovalsModal('fin')); }
      if(apNeedAdm){ apNeedAdm.style.cursor='pointer'; apNeedAdm.title=''; apNeedAdm.addEventListener('click', ()=>openApprovalsModal('adm')); }
      if(apReady){   apReady.style.cursor='pointer';   apReady.title=''; apReady.addEventListener('click', ()=>openApprovalsModal('ready')); }
      if(apTitle){   apTitle.style.cursor='pointer';   apTitle.title=''; apTitle.addEventListener('click', ()=>openApprovalsModal('all')); }


      // tracking card (placeholder)
      // ===== Tracking (mzj-tracking) =====
      const trackingBaseUrl = 'https://mzj-tracking.vercel.app/Test-Track.html?vin=';

      const trackingFirebaseConfig = {
        apiKey: "AIzaSyCorGtT5_Z68jCtLODvqnv0Fb7QW5eR6MQ",
        authDomain: "mzj-tracking.firebaseapp.com",
        projectId: "mzj-tracking",
        storageBucket: "mzj-tracking.firebasestorage.app",
        messagingSenderId: "655452217491",
        appId: "1:655452217491:web:9348d172c47bdd411fad66"
      };

      let trackingDb = null;
      function getTrackingDb(){
        if(trackingDb) return trackingDb;
        try{
          const app = firebase.app('mzj-tracking');
          trackingDb = app.firestore();
        }catch(e){
          const app = firebase.initializeApp(trackingFirebaseConfig, 'mzj-tracking');
          trackingDb = app.firestore();
        }
        return trackingDb;
      }

      function guessField(d, keys){
        for(const k of keys){
          if(d && d[k] !== undefined && d[k] !== null && (d[k]+'').toString().trim() !== '') return d[k];
        }
        return '';
      }

      function normalizePhone(p){
        const s = (p||'').toString().trim();
        return s;
      }

      function pickFirstNonEmpty(arr){
        if(!Array.isArray(arr)) return '';
        for(const x of arr){
          const v = (x||'').toString().trim();
          if(v) return v;
        }
        return '';
      }

      function extractVinFromOrder(d){
        try{
          // direct common fields
          let v = (guessField(d, ['VIN','vin','vehicleVin','vehicle_vin','carVin','car_vin','chassis','chassisNo','chassis_no','رقم_الهيكل','رقم الهيكل','الهيكل','هيكل']) || '').toString().trim();
          if(v) return v;

          // common arrays
          v = pickFirstNonEmpty(d.vins);
          if(v) return v;

          // items arrays (requests-like)
          if(Array.isArray(d.items)){
            for(const it of d.items){
              const vv = it && (it.VIN ?? it.vin ?? it.vehicleVin ?? it.chassis ?? it.chassisNo ?? it['رقم الهيكل'] ?? it['الهيكل']);
              const s = (vv??'').toString().trim();
              if(s) return s;
            }
          }

          // cars/vehicles arrays
          const fromArr = (arr)=> pickFirstNonEmpty((arr||[]).map(x=> x && (x.VIN ?? x.vin ?? x.vehicleVin ?? x.chassis ?? x.chassisNo) ? (x.VIN ?? x.vin ?? x.vehicleVin ?? x.chassis ?? x.chassisNo) : ''));
          v = fromArr(d.cars);
          if(v) return v;
          v = fromArr(d.vehicles);
          if(v) return v;

          // nested objects with common names
          const nested = ['vehicle','car','order','data','payload','meta'];
          for(const key of nested){
            if(d && d[key] && typeof d[key]==='object'){
              v = (d[key].VIN ?? d[key].vin ?? d[key].vehicleVin ?? d[key].chassis ?? d[key].chassisNo ?? '')+'';
              v = v.toString().trim();
              if(v) return v;
            }
          }

          // deep search for any key named VIN/vin (up to a safe depth to avoid cycles)
          const seen = new Set();
          function deepFind(obj, depth){
            if(!obj || typeof obj!=='object') return '';
            if(seen.has(obj)) return '';
            seen.add(obj);
            if(depth<=0) return '';
            if(obj.VIN!==undefined && obj.VIN!==null && (obj.VIN+'').toString().trim()!=='') return (obj.VIN+'').toString().trim();
            if(obj.vin!==undefined && obj.vin!==null && (obj.vin+'').toString().trim()!=='') return (obj.vin+'').toString().trim();
            // arrays
            if(Array.isArray(obj)){
              for(const it of obj){
                const r = deepFind(it, depth-1);
                if(r) return r;
              }
              return '';
            }
            // objects
            for(const k in obj){
              if(!Object.prototype.hasOwnProperty.call(obj,k)) continue;
              const r = deepFind(obj[k], depth-1);
              if(r) return r;
            }
            return '';
          }
          v = deepFind(d, 4);
          if(v) return v;

          return '';
        }catch(_){ return ''; }
      }

      function deriveOrderStatus(d){
        try{
          // direct fields first
          const direct = (guessField(d, ['status','state','orderStatus','order_status','trackingStatus','tracking_status','الحالة','حالة','stage','مرحلة']) || '').toString().trim();
          if(direct) return direct;

          // step timestamps style
          const s1 = !!d.step1At || !!d.step1_at;
          const s2 = !!d.step2At || !!d.step2_at;
          const s3 = !!d.step3At || !!d.step3_at;
          const s4 = !!d.step4At || !!d.step4_at;

          if(s4) return 'مكتمل';
          if(s3) return 'تحت الإجراء';
          if(s2) return 'تحت الإجراء';
          if(s1) return 'جديد';

          // archived flag
          if(d.isArchived || d.archived === true || d.archivedAt || d.archived_at) return 'مؤرشف';

          return 'جديد';
        }catch(_){ return '—'; }
      }

      function getCarTrackingLinkByVin(vin){
        const v = (vin||'').toString().trim();
        if(!v) return '';
        const car = (invAll||[]).find(x=> (x.vin||'').toString().trim()===v);
        const link = (car && (car.trackingLink||car.tracking||car.f_tracking)) ? (car.trackingLink||car.tracking||car.f_tracking) : '';
        return (link||'').toString().trim() || (trackingBaseUrl + encodeURIComponent(v));
      }

      async function fetchTrackingOrders(limit=400){
        const tdb = getTrackingDb();
        let snap = null;

        // try best ordering (may require index/field)
        try{
          snap = await tdb.collection('orders').orderBy('createdAt','desc').limit(limit).get();
        }catch(e1){
          try{
            snap = await tdb.collection('orders').orderBy('created_at','desc').limit(limit).get();
          }catch(e2){
            try{
              snap = await tdb.collection('orders').orderBy('date','desc').limit(limit).get();
            }catch(e3){
              snap = await tdb.collection('orders').limit(limit).get();
            }
          }
        }

        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const vin = extractVinFromOrder(d);
          const status = deriveOrderStatus(d);
          const isArchived = !!(
            d.isArchived ||
            d.archivedAt || d.archived_at ||
            d.archived === true ||
            (status && /مؤرشف|مكتمل|منتهي|تم الانتهاء|closed|done|completed|archiv/i.test(status))
          );

          rows.push({
            id: doc.id,
            orderNo: (guessField(d, ['orderNo','order_number','orderId','رقم الطلب']) || '').toString().trim() || doc.id,
            customer: guessField(d, ['customerName','customer_name','name','clientName','client_name','الاسم']),
            phone: normalizePhone(guessField(d, ['phone','mobile','whatsapp','الجوال','رقم الجوال'])),
            branch: guessField(d, ['branch','branchName','branch_name','الفرع','المعرض']),
            vin,
            currentStage: parseInt((guessField(d, ['currentStage','current_stage','stage','مرحلة','CurrentStage'])||0),10) || 0,
            status: status || '—',
            isArchived,
          });
        });

        // غير المؤرشف فقط
        return rows.filter(r=>!r.isArchived);
      }

      function classifyTrackingRow(r){
        const cs = (typeof r.currentStage === 'number') ? r.currentStage : parseInt((r.currentStage||0),10);
        if(!isNaN(cs)){
          if(cs === 10) return 'done';
          if(cs >= 1 && cs <= 9) return 'inprog';
          if(cs === 0) return 'new';
        }

        const s = (r.status||'').toString();
        // جديد
        if(!s || /جديد|new/i.test(s)) return 'new';
        // تم الانتهاء
        if(/تم\s*الانتهاء|مكتمل|منتهي|done|completed|closed/i.test(s)) return 'done';
        // تحت الإجراء
        if(/تحت|إجراء|قيد|in\s*progress|processing|under/i.test(s)) return 'inprog';
        // افتراضي نخليه تحت الإجراء
        return 'inprog';
      }

      function buildTrackLink(vin){
        const v = (vin||'').toString().trim();
        if(!v) return '';
        // لو موجود في المخزون Tracking يدوي نستخدمه
        return getCarTrackingLinkByVin(v) || (trackingBaseUrl + encodeURIComponent(v));
      }

      

      // حفظ رابط التتبع داخل cars عند نسخ الرابط من كارت Tracking
      async function saveTrackingLinkToCar(vin, link){
        const v = (vin||'').toString().trim();
        const l = (link||'').toString().trim();
        if(!v || !l) return false;
        try{
          await db.collection('cars').doc(v).set({
            Tracking: l,          // المطلوب (بحرف T كبير)
            tracking: l,          // توافق مع استخدامات قديمة
            trackingLink: l,      // توافق مع عرض "Tracking" في تبويب قاعدة البيانات
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: (auth?.currentUser?.email || '')
          }, { merge: true });
          return true;
        }catch(e){
          console.warn('saveTrackingLinkToCar error', e);
          return false;
        }
      }
async function refreshTrackingKpis(){
        try{
          const rows = await fetchTrackingOrders(600);
          let nNew=0, nIn=0, nDone=0;
          rows.forEach(r=>{
            const c = classifyTrackingRow(r);
            if(c==='new') nNew++;
            else if(c==='done') nDone++;
            else nIn++;
          });

          const bNew = document.getElementById('dash_trk_new');
          const bIn  = document.getElementById('dash_trk_inprog');
          const bDone= document.getElementById('dash_trk_done');

          if(bNew)  bNew.textContent  = `طلبات لم تبدأ (${nNew})`;
          if(bIn)   bIn.textContent   = `طلبات تحت الإجراء (${nIn})`;
          if(bDone) bDone.textContent = `طلبات مكتملة (${nDone})`;

          // إجمالي كارت تتبع إجراءات البيع = (لم تبدأ + تحت الإجراء + مكتملة)
          const tEl = document.getElementById('dash_trk_title');
          const tTot = document.getElementById('dash_trk_total');
          if(tEl) tEl.textContent = 'تتبع إجراءات البيع (Tracking)';
          // ✅ الـ <span> يحتوي "الإجمالي:" بالفعل، لذلك نكتب الرقم فقط داخل الـ <b>
          if(tTot) tTot.textContent = `${(nNew+nIn+nDone)}`;
        }catch(e){
          console.warn('tracking kpi error', e);
          const bNew = document.getElementById('dash_trk_new');
          const bIn  = document.getElementById('dash_trk_inprog');
          const bDone= document.getElementById('dash_trk_done');

          if(bNew)  bNew.textContent  = 'طلبات لم تبدأ (—)';
          if(bIn)   bIn.textContent   = 'طلبات تحت الإجراء (—)';
          if(bDone) bDone.textContent = 'طلبات مكتملة (—)';

          const tEl = document.getElementById('dash_trk_title');
          if(tEl) tEl.textContent = 'تتبع إجراءات البيع (Tracking)';
        }
      }

      async function openTrackingModal(type, presetQuery){
        try{
          const rowsAll = await fetchTrackingOrders(600);

          // type: new | inprog | done | all
          let rows = rowsAll.slice();
          if(type && type!=='all'){
            rows = rows.filter(r=> classifyTrackingRow(r)===type);
          }

          const title =
            (!type || type==='all') ? 'كل طلبات التتبع' :
            (type==='new') ? 'طلبات لم تبدأ' :
            (type==='done') ? 'طلبات مكتملة' :
            'طلبات تحت الإجراء';

          const uid = 'trk_' + Date.now();
          const qId = uid + '_q';
          const bId = uid + '_b';

          function rowBag(r){
            return [
              r.orderNo, r.customer, r.phone, r.branch, r.vin, r.status, r.id
            ].map(x=>((x??'')+'').toLowerCase()).join(' | ');
          }

          function render(list, q){
            q = ((q||'')+'').toLowerCase().trim();
            const filtered = !q ? list : list.filter(r=> rowBag(r).includes(q));
            const tbody = document.getElementById(bId);
            const meta = document.getElementById(uid+'_m');
            if(meta) meta.textContent = `عدد النتائج: ${filtered.length}`;
            if(!tbody) return;

            tbody.innerHTML = filtered.length ? filtered.map(r=>{
              const trackLink = r.vin ? buildTrackLink(r.vin) : '';
              const safeLink = escapeHtml(trackLink||'');
              return `
                <tr>
                  <td>${escapeHtml(r.orderNo||r.id||'')}</td>
                  <td>${escapeHtml(r.customer||'')}</td>
                  <td>${escapeHtml(r.phone||'')}</td>
                  <td>${escapeHtml(r.branch||'')}</td>
                  <td>${escapeHtml(r.vin||'')}</td>
                  <td>${escapeHtml(r.status||'—')}</td>
                  <td>${safeLink ? `<a href="${safeLink}" target="_blank" rel="noopener">فتح</a>` : '—'}</td>
                  <td><button class="linkBtn" type="button" data-copy="${safeLink}" data-vin="${escapeHtml(r.vin||'')}">نسخ</button></td>
                </tr>`;
            }).join('') : `<tr><td colspan="8" style="text-align:center;padding:12px">لا توجد بيانات مطابقة.</td></tr>`;

            // copy handlers (copy + save into cars.Tracking)
            tbody.querySelectorAll('[data-copy]')?.forEach(btn=>{
              btn.addEventListener('click', async ()=>{
                const v = (btn.getAttribute('data-copy') || '').toString().trim();
                const vin = (btn.getAttribute('data-vin') || '').toString().trim();
                if(!v){ toast('لا يوجد رابط'); return; }
                try{
                  await navigator.clipboard.writeText(v);
                  // احفظه داخل قاعدة البيانات (cars) في حقل Tracking
                  if(vin){
                    const ok = await saveTrackingLinkToCar(vin, v);
                    toast(ok ? 'تم النسخ ✅ وتم الحفظ في قاعدة البيانات' : 'تم النسخ ✅ (تعذر الحفظ)');
                  }else{
                    toast('تم النسخ ✅');
                  }
                }catch(e){
                  console.error(e);
                  toast('تعذر النسخ');
                }
              });
            });
          }

          const html = `
            <div class="small" style="margin-bottom:10px">المصدر: <b>orders</b> — ${escapeHtml(title)} <span class="small" id="${uid+'_m'}" style="margin-right:10px;color:#6b6b6b"></span></div>

            <div class="toolbar" style="margin-bottom:10px">
              <div class="field" style="flex:1;min-width:240px">
                <label>بحث</label>
                <input id="${qId}" placeholder="رقم الطلب / اسم العميل / VIN / الجوال"/>
              </div>
              <button class="btn secondary" type="button" id="${uid+'_clear'}">تفريغ</button>
            </div>

            <div style="overflow:auto">
              <table class="table stickyHead">
                <thead>
                  <tr>
                    <th>رقم الطلب</th>
                    <th>اسم العميل</th>
                    <th>الجوال</th>
                    <th>الفرع</th>
                    <th>VIN</th>
                    <th>الحالة</th>
                    <th>تتبع</th>
                    <th>نسخ</th>
                  </tr>
                </thead>
                <tbody id="${bId}"></tbody>
              </table>
            </div>
          `;

          openDetailsModal(html, 'Tracking');

          // initial render
          const qEl = document.getElementById(qId);
          if(qEl){
            qEl.value = (presetQuery||'').toString();
            qEl.addEventListener('input', ()=> render(rows, qEl.value));
            qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') render(rows, qEl.value); });
          }
          document.getElementById(uid+'_clear')?.addEventListener('click', ()=>{
            if(qEl){ qEl.value=''; }
            render(rows, '');
          });

          render(rows, presetQuery||'');

        }catch(e){
          console.error(e);
          const msg = (e && (e.message || e.code)) ? (e.message || e.code) : '';
          openDetailsModal('<div class="small">تعذر تحميل طلبات التتبع'+(msg?(' — '+escapeHtml(msg)):'')+'</div>', 'Tracking');
        }
      }

      document.getElementById('dash_trk_new')?.addEventListener('click', ()=> openTrackingModal('new'));
      document.getElementById('dash_trk_inprog')?.addEventListener('click', ()=> openTrackingModal('inprog'));

      document.getElementById('dash_trk_done')?.addEventListener('click', ()=> openTrackingModal('done'));

      // Click on card title/total opens ALL
      document.getElementById('dash_trk_title')?.addEventListener('click', ()=> openTrackingModal('all'));
      document.getElementById('dash_trk_total')?.addEventListener('click', ()=> openTrackingModal('all'));

      // Search box inside the Tracking card (Dashboard)
      const dashTrkSearch = document.getElementById('dash_trk_search');
      const dashTrkSearchBtn = document.getElementById('dash_trk_search_btn');
      document.getElementById('dash_trk_show_all')?.addEventListener('click', ()=> openTrackingModal('all', dashTrkSearch?.value||''));
      if(dashTrkSearchBtn){
        dashTrkSearchBtn.addEventListener('click', ()=> openTrackingModal('all', dashTrkSearch?.value||''));
      }
      if(dashTrkSearch){
        dashTrkSearch.addEventListener('keydown', (e)=>{
          if(e.key==='Enter') openTrackingModal('all', dashTrkSearch.value||'');
        });
      }

      // Requests card click -> show ALL requests
      document.getElementById('dash_req_title')?.addEventListener('click', ()=> openReqStageModal(0));
      document.getElementById('dash_req_total')?.addEventListener('click', ()=> openReqStageModal(0));
      

      // refresh KPIs after inventory loaded
      setTimeout(()=>{ refreshTrackingKpis(); }, 1200);
      // requests stages
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=> openReqStageModal(parseInt(btn.getAttribute('data-req-stage')||'0',10)));
      });

      // saved filter buttons
      document.getElementById('dash_filter_save')?.addEventListener('click', async ()=>{
        const obj = getDashFilterFromUI();
        // keep old behavior (remember last filter)
        writeSavedDashFilter(obj);

        // create a new saved card
        const cards = readSavedDashCards();
        const location = (obj.location||'').trim();
        const statuses = normalizeStatuses(obj.statuses||[]);
        const title = makeCardTitle(location);

        // avoid duplicates by same location+statuses
        const key = JSON.stringify({location, statuses});
        const exists = cards.some(c=> (c.key===key));
        if(!exists){
          cards.unshift({id: 'c_'+Date.now().toString(36), key, title, location, statuses, createdAt: Date.now()});
          await writeSavedDashCards(cards);
        }

        renderDashboard();
        // سيتم التحديث تلقائيًا عبر onSnapshot
        renderSavedDashCards();
      markDashboardTotalsHighlight();
        toast(exists ? 'الكارت موجود بالفعل' : 'تم إنشاء كارت جديد');
      });
      document.getElementById('dash_filter_show')?.addEventListener('click', ()=>{
        const obj = getDashFilterFromUI();
        const cars = dashCars.filter(c=>{
          if(obj.location && (c.location||'').toString().trim() != obj.location) return false;
          if(obj.statuses && obj.statuses.length){
            return obj.statuses.map(normStatus).includes(normStatus(c.status));
          }
          return true;
        });
        const agg = countAgg(cars);
        const rows = `
          <div class="dashKpis" style="margin-bottom:10px">
            <div class="dashKpi"><span>الإجمالي الفعلي</span><b>${agg.totalActual}</b></div>
            <div class="dashKpi"><span></span><b>${agg.keysTotal}</b></div>
          </div>
          <div class="dashKpis">
            <div class="dashKpi"><span>متاح</span><b>${agg.avail}</b></div>
            <div class="dashKpi"><span>محجوز</span><b>${agg.reserved}</b></div>
            <div class="dashKpi"><span>بها ملاحظات</span><b>${agg.notes}</b></div>
            <div class="dashKpi"><span>مباع تحت التسليم</span><b>${agg.under}</b></div>
            <div class="dashKpi"><span>مباع تم التسليم</span><b>${agg.delivered}</b></div>
          </div>`;
        openDetailsModal(rows, 'عرض مخصص');
      });
      document.getElementById('dash_filter_clear')?.addEventListener('click', ()=>{
        if(!canUseDashDanger()) return toast('غير مصرح لك باستخدام زر التفريغ');
        applyDashFilterToUI({location:'', statuses:[]});
        writeSavedDashFilter({});
        renderDashboard();
        toast('تم التفريغ');
      });

      // KPI clicks (الكروت نفسها)
      document.querySelectorAll('#view-dashboard .dashKpi').forEach(kpi=>{
        kpi.style.cursor = 'pointer';
        kpi.addEventListener('click', ()=>{
          const b = kpi.querySelector('b[id]');
          if(!b) return;
          const id = b.id || '';

          // Stock / branches KPIs
          const map = {
            'stk_avail': {location:'', status:'متاح للبيع'},
            'stk_reserved': {location:'', status:'محجوز'},
            'stk_notes': {location:'', status:'بها ملاحظات'},
            'stk_under': {location:'', status:'مباع تحت التسليم'},
            'stk_delivered': {location:'', status:'مباع تم التسليم'},

            'ag_avail': {location:'الوكالة', status:'متاح للبيع'},
            'ag_reserved': {location:'الوكالة', status:'محجوز'},
            'ag_notes': {location:'الوكالة', status:'بها ملاحظات'},
            'ag_under': {location:'الوكالة', status:'مباع تحت التسليم'},
            'ag_delivered': {location:'الوكالة', status:'مباع تم التسليم'},

            'b1_avail': {location:'الصالة', status:'متاح للبيع'},
            'b1_reserved': {location:'الصالة', status:'محجوز'},
            'b1_notes': {location:'الصالة', status:'بها ملاحظات'},
            'b1_under': {location:'الصالة', status:'مباع تحت التسليم'},
            'b1_delivered': {location:'الصالة', status:'مباع تم التسليم'},

            'b2_avail': {location:'الملتقى', status:'متاح للبيع'},
            'b2_reserved': {location:'الملتقى', status:'محجوز'},
            'b2_notes': {location:'الملتقى', status:'بها ملاحظات'},
            'b2_under': {location:'الملتقى', status:'مباع تحت التسليم'},
            'b2_delivered': {location:'الملتقى', status:'مباع تم التسليم'},

            'b3_avail': {location:'القادسية', status:'متاح للبيع'},
            'b3_reserved': {location:'القادسية', status:'محجوز'},
            'b3_notes': {location:'القادسية', status:'بها ملاحظات'},
            'b3_under': {location:'القادسية', status:'مباع تحت التسليم'},
            'b3_delivered': {location:'القادسية', status:'مباع تم التسليم'},
          };

          if(map[id]){
            openCarsModalByFilter(map[id].location, [map[id].status]);
            return;
          }

          // Approvals KPIs
          if(id === 'ap_need_fin') return openApprovalsModal('fin');
          if(id === 'ap_need_adm') return openApprovalsModal('adm');
          if(id === 'ap_ready') return openApprovalsModal('ready');

          // Requests KPIs
          if(id === 'rq_s1') return openReqStageModal(1);
          if(id === 'rq_s2') return openReqStageModal(2);
          if(id === 'rq_s3') return openReqStageModal(3);
          if(id === 'rq_s4') return openReqStageModal(4);
        });

      // Requests stage buttons
      document.querySelectorAll('[data-req-stage]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const st = parseInt(btn.getAttribute('data-req-stage')||'0',10);
          if(st>=1 && st<=4) openReqStageModal(st);
        });
      });

      });

    

      // ---- Missing branches UI bindings ----
      try{
        initMissingBranchesFeature();

        document.getElementById('missingClose')?.addEventListener('click', ()=>hideModal('missingModal'));
        document.getElementById('missingModal')?.addEventListener('click', (e)=>{
          if(e.target && e.target.id==='missingModal') hideModal('missingModal');
        });

        document.getElementById('missingSearch')?.addEventListener('input', ()=>{
          renderMissingModalRows(__missingLastRows);
        });

        document.getElementById('missingExport')?.addEventListener('click', ()=>{
          const headers = ['السيارة','البيان','اللون الداخلي','اللون الخارجي','الموديل','عدد الفرع','الإجمالي العام'];
          const rows = (__missingLastRows||[]).filter(r=>missingRowMatches(r, (document.getElementById('missingSearch')?.value||'').trim()))
            .map(r=>[
              r.carName||'',
              r.statement||'',
              r.interiorColor||'',
              r.exteriorColor||'',
              r.model||'',
              (r.branchCount??0),
              (r.totalCount??r.totalAll??0)
            ]);
          exportRowsToExcel(headers, rows, `missing_${Date.now()}.xlsx`, 'missing');
        });

      }catch(e){ /* ignore */ }

}

    function startDashboardLive(){
      if(dashCarsUnsub) return;
      bindDashboardActions();

      // load saved filter into UI
      const saved = readSavedDashFilter();
      if(saved) applyDashFilterToUI(saved);
      loadDashLocationsIntoSelect();

      dashCarsUnsub = db.collection('cars').onSnapshot((snap)=>{
        dashCars = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashCars.push({
            vin: doc.id,
            carName: d.carName || d.car || d.name || d.vehicle || '',
            statement: d.statement || d.trim || d.desc || d.variant || '',
            interiorColor: d.interiorColor || '',
            exteriorColor: d.exteriorColor || '',
            model: d.model || '',
            agent: (d.agent || d.dealer || d.vendor || d.agency || d['الوكيل'] || ''),
            location: d.location || '',
            status: (d.status || d.state || d.statuses || d['الحالة'] || ''),
            approvals: d.approvals || {financial:false, admin:false}
          });
        });

        // resolve dashCarsReady once

        // expose dashCars for other dashboard cards (e.g. نواقص السيارات)
        try{ window.dashCars = dashCars; }catch(e){}

        if(__dashCarsReadyResolve){ __dashCarsReadyResolve(true); __dashCarsReadyResolve = null; }
        loadDashLocationsIntoSelect();
        renderDashboard();
      });

      // catalog
      dashCatalogUnsub = db.collection('catalog').where('active','==',true).onSnapshot((snap)=>{
        dashCatalog = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashCatalog.push({...d, _raw:d, id:doc.id});
        });
        renderDashboard();
      }, (err)=>{
        console.error(err);
      });

      // requests summary
      dashReqUnsub = db.collection('requests').limit(300).onSnapshot((snap)=>{
        dashReq = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          dashReq.push({id:doc.id, ...d});
        });
        renderRequestsCounts();
      }, (err)=>{ console.error(err); });
    }

    function stopDashboardLive(){
      if(dashCarsUnsub){ dashCarsUnsub(); dashCarsUnsub=null; }
      if(dashCatalogUnsub){ dashCatalogUnsub(); dashCatalogUnsub=null; }
      if(dashReqUnsub){ dashReqUnsub(); dashReqUnsub=null; }
    }

    // Inventory filters
    ['inv_search','inv_location','inv_status','inv_model','inv_archive'].forEach(id=>{
      const el=$(id);
      if(el){
        el.addEventListener('input', renderInventory);
        el.addEventListener('change', renderInventory);
      }
    });

    // Export (CSV opens in Excel)
    const invExport = $('inv_export');
    if(invExport){
      invExport.addEventListener('click', ()=>{
        const { q, branch, status, model, archive } = getInvFilters();
        const rows = invAll.filter(car=>{
          const archived = isCarArchived(car);
          if(archive==='active' && archived) return false;
          if(archive==='archived' && !archived) return false;
          if(branch && branch!=='الكل' && norm(car.location)!==branch) return false;
          if(status && status!=='الكل' && norm(car.status)!==status) return false;
          if(model  && model!=='الكل'  && norm(car.model)!==model) return false;
          return matchesSearch(car, q);
        });

        const headers = ['VIN','السيارة','البيان','الوكيل','اللون الداخلي','اللون الخارجي','الموديل','اللوحة','الدفعة','المكان','ملاحظة المكان','ملاحظة النواقص','الحالة','Tracking'];
        const csv = '\ufeff' + [headers.join(',')].concat(rows.map(c=>[
          c.vin, c.carName, c.statement, c.agent, c.interiorColor, c.exteriorColor, c.model, c.plate, c.batchName, c.location, c.noteLocation, c.noteMissing, c.status, c.trackingLink
        ].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(','))).join('\n');

        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download='inventory.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      });
    }

    function openDetailsModal(htmlContent, title){
      // reuse existing details modal
      const modal = $('detailsModal');
      const body = $('detailsBody');
      if(!modal || !body) return;
      const h = modal.querySelector('.modal-title');
      if(h && title) h.textContent = title;
      body.innerHTML = htmlContent;
      modal.classList.add('show');
    }


    
    const toastEl = $('toast');
    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), 2400);
    }


    function escapeHtml(s){
      s = (s===null || s===undefined) ? '' : String(s);
      return s.replace(/[&<>"']/g, (c)=>({
        '&':'&amp;',
        '<':'&lt;',
        '>':'&gt;',
        '"':'&quot;',
        "'":'&#39;'
      }[c]));
    }

    // ===== UI: Tabs =====
    const tabs = Array.from(document.querySelectorAll('.tab'));

    // ===== Tracking iframe =====
    let __trackingLoaded = false;
    function ensureTrackingLoaded(){
      if(__trackingLoaded) return;
      const frame = document.getElementById('trackingFrame');
      const tpl = document.getElementById('trackingSrc');
      if(!frame || !tpl) return;
      // ✅ حمل صفحة التراكينج من الدومين الحقيقي (عشان تسجيل الدخول يشتغل طبيعي)
      // ملاحظة: نترك <template id="trackingSrc"> كما هو بدون تغيير لتفادي أي تأثير جانبي.
      frame.src = 'https://mzj-workflow.vercel.app/sales3.html';
      __trackingLoaded = true;
    }

    // ===== Media iframe =====
    let __mediaLoaded = false;

    function __injectMediaEmbedCSS(frame){
      try{
        const doc = frame.contentDocument || (frame.contentWindow && frame.contentWindow.document);
        if(!doc || !doc.head) return;
        if(doc.getElementById('mzj_embed_hide_sidebar')) return;
        const st = doc.createElement('style');
        st.id = 'mzj_embed_hide_sidebar';
        st.textContent = `
          /* Embedded in Workflow Dashboard (Media Tab) */
          .sidebar, .mzj-sidebar, #sidebar, .sideBar, .mzj-side, .rightbar, .mzj-rightbar{display:none !important;}
          body{padding:0 !important; background:transparent !important;}
          .wrap, .container, main, .content, .mzj-content{max-width:none !important; margin:0 !important; width:100% !important;}
          body{overflow-x:hidden !important;}
        `;
        doc.head.appendChild(st);
      }catch(e){
        // cross-origin: ignore
      }
    }

    function ensureMediaLoaded(){
      if(__mediaLoaded) return;
      const frame = document.getElementById('mediaFrame');
      if(!frame) return;
      // ✅ حمل صفحة الميديا من الدومين الحقيقي
      frame.addEventListener('load', ()=>__injectMediaEmbedCSS(frame));
      frame.src = 'https://mzj-workflow.vercel.app/media.html?embed=1';
      __mediaLoaded = true;
    }

    function openView(viewId){
      tabs.forEach(t=>t.classList.toggle('active', t.dataset.view===viewId));
      document.querySelectorAll('.view').forEach(v=>v.classList.toggle('active', v.id===viewId));
      if(viewId==='view-inventory') startInventoryLive();
      else stopInventoryLive();
      if(viewId==='view-dashboard'){ startDashboardLive(); startDashCardsLive(); } else stopDashboardLive();
      if(viewId==='view-tracking') ensureTrackingLoaded();
      if(viewId==='view-media') ensureMediaLoaded();
    }
    tabs.forEach(t=>t.addEventListener('click', ()=>openView(t.dataset.view)));

    // ===== Auth =====
    const authBox = $('authBox');
    const app = $('app');
    const authPill = $('authPill');
    const btnLogout = $('btnLogout');

    $('btnLogin').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      const pass = $('loginPass').value;
      if(!email || !pass) return toast('اكتب البريد وكلمة المرور');
      try{
        await auth.signInWithEmailAndPassword(email, pass);
      }catch(e){
        toast(e.message || 'فشل تسجيل الدخول');
      }
    });

    $('btnReset').addEventListener('click', async ()=>{
      const email = $('loginEmail').value.trim();
      if(!email) return toast('اكتب البريد أولاً');
      try{
        await auth.sendPasswordResetEmail(email);
        toast('تم إرسال رابط إعادة تعيين كلمة المرور');
      }catch(e){
        toast(e.message || 'فشل الإرسال');
      }
    });

    btnLogout.addEventListener('click', ()=>auth.signOut());

    auth.onAuthStateChanged((user)=>{
      if(user){
        authPill.textContent = user.email;
        btnLogout.classList.remove('hidden');
        authBox.classList.add('hidden');
        app.classList.remove('hidden');
        // تحميل صلاحيات المستخدم (tabs + permissions) من users/{uid}
        loadCurrentUserDoc(user).then((ud)=>{
          CURRENT_USER_DOC = ud;
          applyAccessControl(user, ud || {});

          // تحميل صلاحية النقل (مبنية على role داخل userDoc أو الأدمن الثابت)
          const role = (ud && (ud.role || ud.type || ud.permission)) ? (ud.role || ud.type || ud.permission) : '';
          const tabAllowsTransfer = !!(ud && ud.tabs && ud.tabs.car_transfer);
          canTransfer = true; // ✅ السماح لأي يوزر مسجل بتنفيذ الحركة
          const hint = document.getElementById('tr_hint');
          if(hint){
            hint.innerHTML = canTransfer
              ? 'المسموح بالحركة: ✅ (حسب التابات المفعّلة لك). سيتم تسجيل آخر الحركات مع البريد المنفذ.'
              : 'غير مصرح لك بالحركة — اطلب من الإدارة تفعيل <b>الحركة</b> لك من إدارة المستخدمين.';
          }
        });
        toast('تم تسجيل الدخول');
        loadMetaLists().catch(e=>console.warn('lists',e));
        bindListsEvents();
        bindAdminSubTabs();
        const fs=document.getElementById('f_status');
        if(fs) fs.addEventListener('change', uiStatusNotesToggle);
        const ns=document.getElementById('n_status');
        if(ns) ns.addEventListener('change', uiNewStatusNotesToggle);
        const ts=document.getElementById('tr_status');
        if(ts) ts.addEventListener('change', uiTransferNoteToggle);
        uiStatusNotesToggle();
        uiNewStatusNotesToggle();
        uiTransferNoteToggle();
      }else{
        authPill.textContent = 'غير مسجل';
        btnLogout.classList.add('hidden');
        authBox.classList.remove('hidden');
        app.classList.add('hidden');
        canTransfer = false;
        stopInventoryLive();
      }
    });

    // ===== Data Helpers =====
    const HEADERS = [
      'الهيكل (VIN)','السيارة','البيان','الوكيل','اللون الداخلي','اللون الخارجي','موديل','اللوحة','اسم الدفعة بالتاريخ','المكان',
      'ملاحظات في السيارة','حجز - نواقص - تحديد مكان','الحالة','ملاحظات السيارات (تُفتح عند الحالة: بها ملاحظات)',
      'فرشات','طفاية','شنطة','اسبير','ريموت','شاشة','مسجل','مكيف','كاميرا','حساس','الموافقة المالية','الموافقة الادارية','التتبع Tracking'
    ];

    function normBool(v){
      if(v===true) return true;
      if(v===false) return false;
      const s = (v??'').toString().trim().toLowerCase();
      if(!s) return false;
      return ['1','true','yes','y','نعم','صح','√','✅','ok','تم'].includes(s);
    }

    function carFromForm(){
      const vin = $('f_vin').value.trim();
      return {
        vin,
        carName: $('f_car').value.trim(),
        statement: $('f_statement').value.trim(),
        agent: $('f_agent').value.trim(),
        interiorColor: $('f_int').value.trim(),
        exteriorColor: $('f_ext').value.trim(),
        model: $('f_model').value.trim(),
        plate: $('f_plate').value.trim(),
        batchName: $('f_batch').value.trim(),
        location: $('f_location').value.trim(),
        status: $('f_status').value.trim(),
        notesLocation: $('f_notesLoc').value.trim(),
        noteLocation: $('f_notesLoc').value.trim(),
        notesMissing: $('f_notesMissing').value.trim(),
        noteMissing: $('f_notesMissing').value.trim(),
        carNotes: $('f_carNotes').value.trim(),
        trackingLink: $('f_tracking').value.trim(),
        tracking: $('f_tracking').value.trim(),
        checklist: {
          farshat: $('c_farshat').checked,
          tafaia: $('c_tafaia').checked,
          shanta: $('c_shanta').checked,
          spare: $('c_spare').checked,
          remote: $('c_remote').checked,
          screen: $('c_screen').checked,
          recorder: $('c_recorder').checked,
          ac: $('c_ac').checked,
          camera: $('c_camera').checked,
          sensors: $('c_sensors').checked,
        },
        approvals: {
          financial: $('a_financial').value===''? null : $('a_financial').value==='true',
          admin: $('a_admin').value===''? null : $('a_admin').value==='true'
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
    }

    function fillForm(d){
      $('f_vin').value = d.vin || '';
      $('f_car').value = d.carName || '';
      $('f_statement').value = d.statement || '';
      $('f_agent').value = d.agent || '';
      $('f_int').value = d.interiorColor || '';
      $('f_ext').value = d.exteriorColor || '';
      $('f_model').value = d.model || '';
      $('f_plate').value = d.plate || '';
      $('f_batch').value = d.batchName || '';
      $('f_location').value = d.location || '';
      $('f_status').value = d.status || '';
      $('f_notesLoc').value = (d.notesLocation || d.noteLocation || '');
      $('f_notesMissing').value = (d.notesMissing || d.noteMissing || '');
      $('f_carNotes').value = d.carNotes || '';
            $('f_tracking').value = d.tracking || '';

      const c = d.checklist || {};
      $('c_farshat').checked = !!c.farshat;
      $('c_tafaia').checked = !!c.tafaia;
      $('c_shanta').checked = !!c.shanta;
      $('c_spare').checked = !!c.spare;
      $('c_remote').checked = !!c.remote;
      $('c_screen').checked = !!c.screen;
      $('c_recorder').checked = !!c.recorder;
      $('c_ac').checked = !!c.ac;
      $('c_camera').checked = !!c.camera;
      $('c_sensors').checked = !!c.sensors;

      const a = d.approvals || {};
      $('a_financial').value = (a.financial===true)?'true':(a.financial===false?'false':'');
      $('a_admin').value = (a.admin===true)?'true':(a.admin===false?'false':'');
    }

    function clearForm(){
      ['f_vin','f_car','f_statement','f_agent','f_int','f_ext','f_model','f_plate','f_batch','f_location','f_status','f_notesLoc','f_notesMissing','f_carNotes','f_tracking'].forEach(id=>$(id).value='');
      ['c_farshat','c_tafaia','c_shanta','c_spare','c_remote','c_screen','c_recorder','c_ac','c_camera','c_sensors'].forEach(id=>$(id).checked=false);
      $('a_financial').value='';
      $('a_admin').value='';
    }

    // ===== Admin actions =====
    const btnClear = $('btnClear');
    const btnSave  = $('btnSave');
    const vinInput = $('f_vin');

    if(btnClear) btnClear.addEventListener('click', clearForm);

    if(btnSave) btnSave.addEventListener('click', async ()=>{
      const data = carFromForm();
      if(!data.vin) return toast('رقم الهيكل (VIN) مطلوب');
      try{
        const ref = db.collection('cars').doc(data.vin);
        const snap = await ref.get();
        const prev = snap.exists ? (snap.data()||{}) : {};
        if(!snap.exists) data.createdAt = firebase.firestore.FieldValue.serverTimestamp();

        // ✅ لو كانت السيارة "مباع تحت التسليم" وتم تغيير حالتها لأي حالة أخرى من تبويب الإدارة => امسح الموافقات
        try{
          const prevSt = normStatus(prev.status || prev.state || '');
          const nextSt = normStatus(data.status || data.state || '');
          if(prevSt === 'مباع تحت التسليم' && nextSt !== 'مباع تحت التسليم'){
            data.approvals = firebase.firestore.FieldValue.delete();
            data.approvalsNotes = firebase.firestore.FieldValue.delete();
            data.approvalsAt = firebase.firestore.FieldValue.delete();
            data.approvalsBy = firebase.firestore.FieldValue.delete();
            data.approvalsStatus = firebase.firestore.FieldValue.delete();
          }
        }catch(_){}

        await ref.set(data, {merge:true});
        toast('تم الحفظ');
        logAction('admin','car_save',{vin:data.vin, carName:data.carName||data.car||'', model:data.model||'', location:data.location||'', status:data.status||''});
      }catch(e){
        toast(e.message || 'فشل الحفظ');
      }
    });

    // Auto load by VIN (Edit tab only)
    let __admVinTimer = null;
    async function adminAutoLoadByVin(vin){
      const v = (vin||'').trim();
      if(!v) return;
      try{
        const snap = await db.collection('cars').doc(v).get();
        if(!snap.exists) return; // لا نزعج المستخدم بتوست عند عدم وجوده
        fillForm(snap.data());
        uiStatusNotesToggle();
      }catch(e){
        console.warn(e);
      }
    }

    function isAdminEditVisible(){
      const v = document.getElementById('adm_view_edit');
      if(!v) return true;
      return !v.classList.contains('hidden');
    }

    if(vinInput){
      vinInput.addEventListener('input', ()=>{
        if(!isAdminEditVisible()) return;
        const v = vinInput.value.trim();
        if(__admVinTimer) clearTimeout(__admVinTimer);
        __admVinTimer = setTimeout(()=>adminAutoLoadByVin(v), 250);
      });
      vinInput.addEventListener('blur', ()=>{
        if(!isAdminEditVisible()) return;
        adminAutoLoadByVin(vinInput.value.trim());
      });
    }

    // --- Add New Car form ---
    function carFromNewForm(){
      const vin = $('n_vin')?.value.trim() || '';
      return {
        vin,
        carName: $('n_car')?.value.trim() || '',
        statement: $('n_statement')?.value.trim() || '',
        agent: $('n_agent')?.value.trim() || '',
        interiorColor: $('n_int')?.value.trim() || '',
        exteriorColor: $('n_ext')?.value.trim() || '',
        model: $('n_model')?.value.trim() || '',
        plate: $('n_plate')?.value.trim() || '',
        batchName: $('n_batch')?.value.trim() || '',
        location: $('n_location')?.value.trim() || '',
        status: $('n_status')?.value.trim() || '',
        notesLocation: $('n_notesLoc')?.value.trim() || '',
        noteLocation: $('n_notesLoc')?.value.trim() || '',
        notesMissing: $('n_notesMissing')?.value.trim() || '',
        noteMissing: $('n_notesMissing')?.value.trim() || '',
        carNotes: $('n_carNotes')?.value.trim() || '',
        trackingLink: $('n_tracking')?.value.trim() || '',
        tracking: $('n_tracking')?.value.trim() || '',
        checklist: {
          farshat: !!$('n_farshat')?.checked,
          tafaia:  !!$('n_tafaia')?.checked,
          shanta:  !!$('n_shanta')?.checked,
          spare:   !!$('n_spare')?.checked,
          remote:  !!$('n_remote')?.checked,
          screen:  !!$('n_screen')?.checked,
          recorder:!!$('n_recorder')?.checked,
          ac:      !!$('n_ac')?.checked,
          camera:  !!$('n_camera')?.checked,
          sensors: !!$('n_sensors')?.checked,
        },
        approvals: {
          financial: $('n_financial')?.value==='' ? null : ($('n_financial')?.value==='true'),
          admin:     $('n_admin')?.value==='' ? null : ($('n_admin')?.value==='true')
        },
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
    }

    function clearNewForm(){
      ['n_vin','n_car','n_statement','n_agent','n_int','n_ext','n_model','n_plate','n_batch','n_location','n_status','n_notesLoc','n_notesMissing','n_carNotes','n_tracking']
        .forEach(id=>{ const el=$(id); if(el) el.value=''; });
      ['n_farshat','n_tafaia','n_shanta','n_spare','n_remote','n_screen','n_recorder','n_ac','n_camera','n_sensors']
        .forEach(id=>{ const el=$(id); if(el) el.checked=false; });
      const f1=$('n_financial'); if(f1) f1.value='';
      const f2=$('n_admin'); if(f2) f2.value='';
      const box=document.getElementById('n_carNotes_box'); if(box) box.classList.add('hidden');
    }

    const btnClearNew = $('btnClearNew');
    const btnSaveNew  = $('btnSaveNew');

    if(btnClearNew) btnClearNew.addEventListener('click', clearNewForm);

    if(btnSaveNew) btnSaveNew.addEventListener('click', async ()=>{
      const data = carFromNewForm();
      if(!data.vin) return toast('رقم الهيكل (VIN) مطلوب');
      try{
        const ref = db.collection('cars').doc(data.vin);
        const snap = await ref.get();
        if(snap.exists){
          // لو موجود بالفعل، نعاملها كتعديل عادي (merge)
          await ref.set(data, {merge:true});
          toast('تم الحفظ (تحديث)');
        }else{
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await ref.set(data, {merge:true});
          toast('تمت الإضافة');
        }
        logAction('admin','car_save',{vin:data.vin, carName:data.carName||data.car||'', model:data.model||'', location:data.location||'', status:data.status||''});
      }catch(e){
        toast(e.message || 'فشل الحفظ');
      }
    });

    // ===== Excel Export Helpers =====
    function downloadWorkbook(wb, filename){
      const out = XLSX.write(wb, {bookType:'xlsx', type:'array'});
      const blob = new Blob([out], {type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    function exportTemplate(){
      const ws = XLSX.utils.aoa_to_sheet([HEADERS]);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'template');
      downloadWorkbook(wb, 'cars_template.xlsx');
    }

    $('btnTemplate').addEventListener('click', exportTemplate);

    async function exportAllCars(){
      try{
        const qs = await db.collection('cars').get();
        const rows = [HEADERS];
        qs.forEach(doc=>rows.push(rowFromCar(doc.data())));
        const ws = XLSX.utils.aoa_to_sheet(rows);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'cars');
        downloadWorkbook(wb, 'cars_export.xlsx');
      }catch(e){
        toast(e.message || 'فشل التصدير');
      }
    }
    $('btnExportAll').addEventListener('click', exportAllCars);

    // ===== Import =====
    const importModal = $('importModal');
    const importFile = $('importFile');
    const importMode = $('importMode');
    const importPreview = $('importPreview');
    const runImportBtn = $('runImport');

    $('btnImport').addEventListener('click', ()=>{importModal.classList.add('show')});
    $('closeImport').addEventListener('click', ()=>{importModal.classList.remove('show')});
    $('clearImport').addEventListener('click', ()=>{
      importFile.value='';
      importPreview.textContent='—';
      runImportBtn.disabled=true;
    });

    let parsedRows = [];

    function readExcel(file){
      return new Promise((resolve,reject)=>{
        const reader = new FileReader();
        reader.onload = (e)=>{
          try{
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, {type:'array'});
            const sheetName = wb.SheetNames[0];
            const ws = wb.Sheets[sheetName];
            const aoa = XLSX.utils.sheet_to_json(ws, {header:1, blankrows:false});
            resolve(aoa);
          }catch(err){reject(err)}
        };
        reader.onerror = reject;
        reader.readAsArrayBuffer(file);
      });
    }

    function mapHeaderIndexes(headerRow){
      const map = {};
      headerRow.forEach((h, idx)=>{
        const key = (h||'').toString().trim();
        if(!key) return;
        if(map[key]===undefined) map[key]=idx;
        else {
          // duplicate header
          map[key+'__dup'+idx]=idx;
        }
      });
      return map;
    }

    function getCell(row, headerMap, name, fallbackDupContains=null){
      if(headerMap[name]!==undefined) return row[headerMap[name]];
      if(fallbackDupContains){
        const k = Object.keys(headerMap).find(x=>x.startsWith(fallbackDupContains));
        if(k) return row[headerMap[k]];
      }
      return '';
    }

    // === Excel Import: Stage3 fix (wire Execute Import) ===
    let __importCarsBuffer = [];

    function normalizeStatus(s){
      s = (s||'').toString().trim();
      // accept common variants
      if(s==='مباع تحت التسلم') s='مباع تحت التسليم';
      return s;
    }

    function parseYesNoBool(v){
      const raw = (v===null || v===undefined) ? '' : v;
      const s = raw.toString().trim().toLowerCase();
      if(!s) return null;
      // yes
      if(['نعم','صح','true','1','yes','y','✓','✔','✅'].includes(s)) return true;
      // no
      if(['لا','غلط','false','0','no','n','✗','✕','x','❌'].includes(s)) return false;
      // Arabic variants
      if(s.includes('نعم')) return true;
      if(s.includes('لا')) return false;
      return null;
    }

    function excelRowToCar(row, headerMap){
      const vin = (getCell(row, headerMap, 'الهيكل') || getCell(row, headerMap, 'الهيكل (VIN)') || getCell(row, headerMap, '(VIN)') || '').toString().trim();
      if(!vin) return null;

      const carName = (getCell(row, headerMap, 'السيارة') || getCell(row, headerMap, 'اسم السيارة') || '').toString().trim();
      const statement = (getCell(row, headerMap, 'البيان') || '').toString().trim();
      const agent = (getCell(row, headerMap, 'الوكيل') || getCell(row, headerMap, 'وكيل') || getCell(row, headerMap, 'Agency') || '').toString().trim();
      const interiorColor = (getCell(row, headerMap, 'اللون الداخلي') || getCell(row, headerMap, 'داخلي') || '').toString().trim();
      const exteriorColor = (getCell(row, headerMap, 'اللون الخارجي') || getCell(row, headerMap, 'خارجي') || '').toString().trim();
      const model = (getCell(row, headerMap, 'الموديل') || getCell(row, headerMap, 'موديل') || '').toString().trim();
      const plate = (getCell(row, headerMap, 'اللوحة') || '').toString().trim();
      const batchName = (getCell(row, headerMap, 'اسم الدفعة بالتاريخ') || getCell(row, headerMap, 'اسم الدفعة') || getCell(row, headerMap, 'اسم الدفعة بالتاريخ ') || '').toString().trim();
      const location = (getCell(row, headerMap, 'المكان الحالي') || getCell(row, headerMap, 'المكان') || '').toString().trim();
      const status = normalizeStatus(getCell(row, headerMap, 'الحالة') || getCell(row, headerMap, 'Status') || '');
      // Export sheet uses these names:
      // - "ملاحظات في السيارة" -> notesLocation
      // - "حجز - نواقص - تحديد مكان" -> notesMissing
      const notesLocation = (getCell(row, headerMap, 'ملاحظات في السيارة') || getCell(row, headerMap, 'ملاحظات المكان') || '').toString().trim();
      const notesMissing = (getCell(row, headerMap, 'حجز - نواقص - تحديد مكان') || getCell(row, headerMap, 'نواقص') || getCell(row, headerMap, 'النواقص') || '').toString().trim();
      const carNotes = (getCell(row, headerMap, 'ملاحظات السيارات (تُفتح عند الحالة: بها ملاحظات)') || getCell(row, headerMap, 'ملاحظات السيارات') || '').toString().trim();
      const tracking = (getCell(row, headerMap, 'التتبع Tracking') || getCell(row, headerMap, 'Tracking') || getCell(row, headerMap, 'التتبع') || '').toString().trim();

      // Checklist (Agency)
      const checklist = {};
      let hasChecklist = false;
      const ckMap = [
        {key:'sensors', names:['حساس','حساسات']},
        {key:'camera',  names:['كاميرا']},
        {key:'ac',      names:['مكيف']},
        {key:'recorder',names:['مسجل']},
        {key:'screen',  names:['شاشة']},
        {key:'remote',  names:['ريموت']},
        {key:'farshat', names:['فرشات']},
        {key:'tafaia',  names:['طفاية']},
        {key:'shanta',  names:['شنطة سلامة','شنطة']},
        {key:'spare',   names:['اسبير','إسبير','اسبـير']}
      ];
      ckMap.forEach(it=>{
        let foundName = null;
        for(const nm of it.names){
          if(headerMap[nm]!==undefined){ foundName = nm; break; }
        }
        if(!foundName) return;
        hasChecklist = true;
        const val = parseYesNoBool(getCell(row, headerMap, foundName));
        checklist[it.key] = (val===null) ? true : !!val; // default: نعم
      });

      // Approvals
      const approvals = {};
      let hasApprovals = false;
      if(headerMap['الموافقة المالية']!==undefined){
        hasApprovals = true;
        approvals.financial = !!(parseYesNoBool(getCell(row, headerMap, 'الموافقة المالية')));
      }
      if(headerMap['الموافقة الادارية']!==undefined){
        hasApprovals = true;
        approvals.admin = !!(parseYesNoBool(getCell(row, headerMap, 'الموافقة الادارية')));
      }

      return {
        vin,
        carName,
        statement,
        agent,
        interiorColor,
        exteriorColor,
        model,
        plate,
        batchName,
        location,
        status,
        notesLocation,
        notesMissing,
        carNotes,
        tracking,
        ...(hasChecklist ? { checklist } : {}),
        ...(hasApprovals ? { approvals } : {}),
        updatedAt: new Date(),
        updatedBy: (auth?.currentUser?.email || '')
      };
    }

    async function deleteAllCars(dbi){
      const snap = await dbi.collection('cars').get();
      let batch = dbi.batch();
      let n=0;
      for(const doc of snap.docs){
        batch.delete(doc.ref);
        n+=1;
        if(n % 400 == 0){
          await batch.commit();
          batch = dbi.batch();
        }
      }
      if(n % 400 != 0) await batch.commit();
      return n;
    }

    async function upsertCars(dbi, cars, merge=true){
      let batch = dbi.batch();
      let n=0;
      for(const c of cars){
        const ref = dbi.collection('cars').doc(String(c.vin));
        batch.set(ref, c, { merge });
        n+=1;
        if(n % 400 == 0){
          await batch.commit();
          batch = dbi.batch();
        }
      }
      if(n % 400 != 0) await batch.commit();
      return n;
    }

    // Wire file input + execute button
    (function bindExcelImportUI(){
      if(!importFile) return;

      importFile.addEventListener('change', async (e)=>{
        try{
          const file = e.target.files?.[0];
          __importCarsBuffer = [];
          if(!file){
            importPreview.textContent = '';
            runImportBtn.disabled = true;
            return;
          }
          const data = await file.arrayBuffer();
          const wb = XLSX.read(data, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
          if(!aoa || aoa.length < 2){
            importPreview.textContent = 'ملف غير صالح أو فارغ.';
            runImportBtn.disabled = true;
            return;
          }
          const headers = aoa[0];
          const headerMap = mapHeaderIndexes(headers);
          for(const row of aoa.slice(1)) {
            const c = excelRowToCar(row, headerMap);
            if(c) __importCarsBuffer.append ? __importCarsBuffer.append(c) : __importCarsBuffer.push(c);
          }
          importPreview.textContent = `تم قراءة ${__importCarsBuffer.length} سيارة من الملف.`;
          runImportBtn.disabled = (__importCarsBuffer.length===0);
        }catch(err){
          console.error(err);
          importPreview.textContent = 'فشل قراءة ملف Excel.';
          runImportBtn.disabled = true;
        }
      });

      runImportBtn.addEventListener('click', async ()=>{
        try{
          if(runImportBtn.disabled) return;
          if(!__importCarsBuffer || __importCarsBuffer.length===0){
            alert('لا توجد بيانات للاستيراد. اختر ملف Excel أولاً.');
            return;
          }
          runImportBtn.disabled = true;
          runImportBtn.textContent = 'جاري الاستيراد...';

          const dbi = firebase.firestore();
          const mode = importMode.value;
          if(mode === 'replace'){
            await deleteAllCars(dbi);
            await upsertCars(dbi, __importCarsBuffer, false);
          } else {
            await upsertCars(dbi, __importCarsBuffer, true);
          }

          importPreview.textContent = `تم الاستيراد بنجاح: ${__importCarsBuffer.length} سيارة.`;
          runImportBtn.textContent = 'تم';
          setTimeout(()=>{ runImportBtn.textContent = 'تنفيذ الاستيراد'; runImportBtn.disabled = false; }, 900);
          // refresh inventory/dashboard counts if helpers exist
          if(typeof loadCarsToMemory === 'function') { try{ await loadCarsToMemory(); }catch(_){} }
          if(typeof refreshDashboardCards === 'function') { try{ refreshDashboardCards(); }catch(_){} }
        }catch(err){
          console.error(err);
          alert('فشل تنفيذ الاستيراد. راجع الكونسول.');
          runImportBtn.textContent = 'تنفيذ الاستيراد';
          runImportBtn.disabled = false;
        }
      });
    })();

    // === End Excel Import fix ===


    function carFromExcelRow(row, headerMap){
      const vin = (getCell(row, headerMap, 'الهيكل') || getCell(row, headerMap, 'الهيكل (VIN)') || '').toString().trim();
      const cells = [
          d.vin||'', d.carName||'', d.statement||'', d.agent||'',
          d.interiorColor||'', d.exteriorColor||'', d.model||'', d.plate||'',
          d.batchName||'', d.location||'', d.notesLocation||'', d.notesMissing||'', d.status||'',
          (d.tracking||''),
          '__APPROVALS__',
          '__CHECK__',
          '__TRANSFERS__',
          '__ARCHIVE__'
        ];
        cells.forEach(txt=>{
          const td = document.createElement('td');
          if(txt === '__APPROVALS__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'الموافقات';
            b.addEventListener('click', ()=> openInvModal('approvals', d));
            td.appendChild(b);
          } else if(txt === '__CHECK__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'التشيك';
            b.addEventListener('click', ()=> openInvModal('checklist', d));
            td.appendChild(b);
          } else if(txt === '__TRANSFERS__'){
            const b = document.createElement('button');
            b.className = 'linkBtn';
            b.type = 'button';
            b.textContent = 'طلبات النقل';
            b.addEventListener('click', ()=> openInvModal('transfers', d));
            td.appendChild(b);
          } else if(txt === '__ARCHIVE__'){
            const b = document.createElement('button');
            b.className = 'linkBtn danger';
            b.type = 'button';
            b.textContent = 'أرشيف';
            const ok = canArchiveCar(d);
            if(!ok){
              b.disabled = true;
              b.title = 'لا يمكن الأرشفة إلا عند اكتمال: مباع تم التسليم + موافقات مالية/إدارية + Tracking + طلبات نقل مكتملة';
            }
            b.addEventListener('click', ()=> archiveCar(d));
            td.appendChild(b);
          } else {
            td.textContent = txt;
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      $('inv_meta').textContent = `الإجمالي: ${invFiltered.length} من ${invAll.length}`;
    }

    // ===== مخزون: (الموافقات / التشيك / طلبات النقل / الأرشيف) =====
    const detailsModal = document.getElementById('detailsModal');
    const detailsBody = document.getElementById('detailsBody');
    const detailsClose = document.getElementById('detailsClose');

    function closeInvModal(){
      detailsModal.classList.remove('show');
      detailsBody.innerHTML = '';
    }
    if(detailsClose){
      detailsClose.addEventListener('click', closeInvModal);
    }
    if(detailsModal){
      detailsModal.addEventListener('click', (e)=>{
        if(e.target === detailsModal) closeInvModal();
      });
    }

    function yn(v){ return v ? '✅' : '❌'; }

    async function openInvModal(type, d){
      detailsBody.innerHTML = '';
      let title = '';
      if(type === 'approvals'){
        title = 'الموافقات';
        const a = (d && d.approvals) ? d.approvals : {};
        const n = (d && d.approvalsNotes) ? d.approvalsNotes : {};
        const finNote = ((n.financial!=null?n.financial:(a.financialNote||''))||'').toString();
        const admNote = ((n.admin!=null?n.admin:(a.adminNote||''))||'').toString();
        detailsBody.innerHTML = `
          <div class="modalHead"><h3>${title}</h3></div>
          <div class="grid2" style="gap:10px">
            <div class="miniCard"><div class="miniTitle">الموافقة المالية</div><div class="miniVal">${yn(!!a.financial)}</div></div>
            <div class="miniCard"><div class="miniTitle">الموافقة الإدارية</div><div class="miniVal">${yn(!!a.admin)}</div></div>
          </div>
          <div class="grid2" style="gap:10px;margin-top:10px">
            <div class="miniCard"><div class="miniTitle">ملاحظة مالية</div><div class="miniVal" style="font-size:13px;line-height:1.5;white-space:pre-wrap">${escapeHtml(finNote)||'—'}</div></div>
            <div class="miniCard"><div class="miniTitle">ملاحظة إدارية</div><div class="miniVal" style="font-size:13px;line-height:1.5;white-space:pre-wrap">${escapeHtml(admNote)||'—'}</div></div>
          </div>
          <div class="row" style="justify-content:flex-end;gap:8px;margin-top:10px">
            <button class="btn primary" id="inv_open_approvals">تعديل الموافقات</button>
          </div>
        `;
        setTimeout(()=>{
          const b = document.getElementById('inv_open_approvals');
          if(b) b.addEventListener('click', ()=>{ if(d && d.vin) openCarApprovalsModal(d.vin); });
        }, 0);
      } else if(type === 'checklist'){
        title = 'التشيك';
        const c = (d && d.checklist) ? d.checklist : {};
        const items = [
          ['حساس', !!c.sensor || !!c.sensors],
          ['كاميرا', !!c.camera],
          ['مكيف', !!c.ac],
          ['مسجل', !!c.recorder || !!c.musajjal],
          ['شاشة', !!c.screen],
          ['ريموت', !!c.remote],
          ['فرشات', !!c.farshat],
          ['طفاية', !!c.tafaia],
          ['شنطة سلامة', !!c.shanta],
          ['اسبير', !!c.spare]
        ];
        detailsBody.innerHTML = `
          <div class="modalHead"><h3>${title}</h3></div>
          <div class="grid2" style="gap:10px">
            ${items.map(i=>`<div class="miniCard"><div class="miniTitle">${i[0]}</div><div class="miniVal">${yn(i[1])}</div></div>`).join('')}
          </div>
        `;
      }
      else if(type === 'transfers'){
        title = 'حركات النقل';
        detailsBody.innerHTML = `<div class="modalHead"><h3>${title}</h3></div><div class="small">جاري التحميل...</div>`;
        const logs = await fetchTransferLogs(d && d.vin);
        if(!logs.length){
          detailsBody.innerHTML = `<div class="modalHead"><h3>${title}</h3></div><div class="small">لا توجد حركات نقل مسجلة لهذه السيارة.</div>`;
        } else {
          const rows = logs.map((x,idx)=>{
            const dt = x.at ? formatTs(x.at) : '';
            const from = x.fromLocation || x.from || '';
            const to = x.toLocation || x.to || '';
            const by = x.by || '';
            const act = x.action || '';
            return `<tr>
              <td>${idx+1}</td>
              <td>${escapeHtml(dt)}</td>
              <td>${escapeHtml(from)}</td>
              <td>${escapeHtml(to)}</td>
              <td>${escapeHtml(by)}</td>
              <td>${escapeHtml(act)}</td>
            </tr>`;
          }).join('');
          detailsBody.innerHTML = `
            <div class="modalHead"><h3>${title}</h3></div>
            <div class="tableWrap" style="padding:0">
              <table>
                <thead><tr>
                  <th>#</th><th>التاريخ</th><th>من</th><th>إلى</th><th>المنفذ</th><th>النوع</th>
                </tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          `;
        }
      }
      detailsModal.classList.add('show');
    }

    async function fetchTransferLogs(vin){
      try{
        if(!vin) return [];
        const q = query(collection(db,'logs'), where('vin','==',vin), orderBy('at','desc'), limit(50));
        const snap = await getDocs(q);
        return snap.docs.map(d=>d.data());
      }catch(e){
        console.warn('fetchTransferLogs', e);
        return [];
      }
    }

    function canArchiveCar(d){
      try{
        if(!d) return false;
        if((d.status||'') !== 'مباع تم التسليم') return false;
        const a = d.approvals || {};
        if(!a.financial || !a.admin) return false;
        if(!(d.tracking||'').toString().trim()) return false;
        return true;
      }catch(_){ return false; }
    }

    async function archiveCar(d){
      try{
        if(!d || !d.vin) return;
        if(!canArchiveCar(d)) return;
        const logs = await fetchTransferLogs(d.vin);
        if(!logs.length){
          alert('لا يمكن الأرشفة: لا توجد حركات نقل مسجلة لهذه السيارة.');
          return;
        }

        const user = auth.currentUser;
        if(!user){ alert('يجب تسجيل الدخول'); return; }

        const vin = d.vin;
        const carRef = doc(db,'cars',vin);
        const archRef = doc(db,'archives',vin);

        const payload = Object.assign({}, d, {
          archivedAt: serverTimestamp(),
          archivedBy: user.email || ''
        });

        await setDoc(archRef, payload, {merge:false});
        await deleteDoc(carRef);

        logAction('inventory','car_archive',{vin: vin, carName: d.carName||'', fromLocation: d.location||'', toLocation: 'archives'});
        invAll = invAll.filter(x=>x.vin!==vin);
        applyInvFilters();
        alert('تمت الأرشفة بنجاح ✅');
      } catch(e){
        console.error(e);
        alert('تعذر أرشفة السيارة.');
      }
    }

  
    // ===== Transfer Tab =====
    let canTransfer = false;



// --- Auto-save (حجز/نواقص/تحديد مكان) ملاحظات Tab الحركة إلى cars/{VIN} ---
let __trActiveVin = '';
let __trActiveRow = null;
let __trSaveTimer = null;

// ✅ Agency inputs per VIN (التشييك + اللون الداخلي) داخل Tab الحركة
let __trAgencyByVin = {}; // { [vin]: { interiorColor: string, checklist: { [key]: boolean } } }

function __trIsAgencyBoxVisible(){
  const box = document.getElementById('tr_agency_box');
  return !!(box && !box.classList.contains('hidden'));
}

function __captureAgencyUIToVin(vin){
  try{
    vin = (vin||'').toString().trim();
    if(!vin) return;
    if(!__trIsAgencyBoxVisible()) return;

    const interiorColor = (document.getElementById('tr_int_color')?.value || '').toString().trim();
    const checklist = {};
    document.querySelectorAll('#tr_checklist_grid [data-tr-check]').forEach(seg=>{
      const k = (seg.getAttribute('data-tr-check')||'').toString().trim();
      if(!k) return;
      const v = (seg.getAttribute('data-value')||seg.dataset.value||'true') === 'true';
      checklist[k] = v;
    });

    __trAgencyByVin[vin] = { interiorColor, checklist };
  }catch(_e){}
}

function __applyAgencyUIFromData(data){
  try{
    if(!data) return;

    const sel = document.getElementById('tr_int_color');
    if(sel){
      const v = (data.interiorColor||'').toString().trim();
      if(v){
        // لو اللون مش موجود بالقائمة نضيفه مؤقتاً حتى يظهر للعميل
        const exists = Array.from(sel.options||[]).some(o=>(o.value||'')===v);
        if(!exists){
          const o = document.createElement('option');
          o.value = v; o.textContent = v;
          sel.appendChild(o);
        }
        sel.value = v;
      }else{
        sel.value = '';
      }
    }

    const ck = data.checklist || {};
    document.querySelectorAll('#tr_checklist_grid [data-tr-check]').forEach(seg=>{
      const k = (seg.getAttribute('data-tr-check')||'').toString().trim();
      if(!k) return;
      const want = (ck[k]===false) ? false : true; // default نعم
      seg.setAttribute('data-value', want ? 'true' : 'false');
      seg.dataset.value = want ? 'true' : 'false';
      const yes = seg.querySelector('[data-val="true"]');
      const no  = seg.querySelector('[data-val="false"]');
      if(yes) yes.classList.toggle('active', want===true);
      if(no)  no.classList.toggle('active', want===false);
    });
  }catch(_e){}
}

function __loadAgencyUIFromVin(vin){
  try{
    vin = (vin||'').toString().trim();
    if(!vin) return;
    if(!__trIsAgencyBoxVisible()) return;
    const data = __trAgencyByVin[vin];
    if(!data) return;
    __applyAgencyUIFromData(data);
  }catch(_e){}
}

function setTransferActiveVin(v, rowEl){
  // احفظ بيانات الوكالة للهيكل السابق قبل التبديل
  __captureAgencyUIToVin(__trActiveVin);

  __trActiveVin = (v||'').toString().trim();
  __trActiveRow = rowEl || null;

  // لو بيانات هذا الهيكل موجودة بالفعل اعرضها
  __loadAgencyUIFromVin(__trActiveVin);
  try{ __syncAgencySelectorWithActiveVin(); }catch(_e){}
}


// ===== Agency VIN selector (تحديد الهيكل للتشييك) =====
function __getAgencyVinsFromTable(){
  const tb = document.querySelector('#tr_vinTable tbody');
  if(!tb) return [];
  const vins = [];
  tb.querySelectorAll('tr').forEach(tr=>{
    const vin = (tr.querySelector('input[data-vin-input]')?.value || '').toString().trim();
    const loc = (tr.querySelector('[data-cell="loc"]')?.textContent || '').toString().trim();
    if(vin && loc === 'الوكالة') vins.push(vin);
  });
  return Array.from(new Set(vins));
}

function refreshTransferAgencyVinSelector(){
  const sel = document.getElementById('tr_agency_vin_select');
  if(!sel) return;

  const vins = __getAgencyVinsFromTable();
  const current = (sel.value || '').toString().trim();

  // rebuild options
  sel.innerHTML = '<option value="">اختر رقم الهيكل</option>';
  for(const v of vins){
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    sel.appendChild(opt);
  }

  // keep selection
  const target = (__trActiveVin && vins.includes(__trActiveVin)) ? __trActiveVin : (vins.includes(current) ? current : (vins[0] || ''));
  if(target){
    sel.value = target;
  }else{
    sel.value = '';
  }
}

function __syncAgencySelectorWithActiveVin(){
  const sel = document.getElementById('tr_agency_vin_select');
  if(!sel) return;
  if(__trActiveVin && sel.value !== __trActiveVin){
    // ensure option exists
    if(!Array.from(sel.options||[]).some(o=>o.value===__trActiveVin)){
      refreshTransferAgencyVinSelector();
    }
    sel.value = __trActiveVin;
  }
}

// change handler (once)
document.addEventListener('change', (e)=>{
  const t = e.target;
  if(!t || t.id !== 'tr_agency_vin_select') return;
  const vin = (t.value || '').toString().trim();
  if(!vin) return;

  // احفظ الهيكل السابق قبل التبديل
  __captureAgencyUIToVin(__trActiveVin);

  // فعل السطر المقابل لو موجود
  const tb = document.querySelector('#tr_vinTable tbody');
  let row = null;
  if(tb){
    tb.querySelectorAll('tr').forEach(tr=>{
      const v = (tr.querySelector('input[data-vin-input]')?.value || '').toString().trim();
      if(v === vin) row = tr;
    });
  }
  setTransferActiveVin(vin, row);

  // اعرض بوكس الوكالة + حمّل بيانات الهيكل المختار
  setTransferAgencyBoxVisible(true);
  try{ fillTransferInteriorColors(); }catch(_e){}
  __loadAgencyUIFromVin(vin);
});


async function saveTransferNotesToCar(vin){
  try{
    const user = auth.currentUser;
    if(!user) return; // لا نزعج المستخدم أثناء عدم تسجيل الدخول
    vin = (vin||__trActiveVin||'').toString().trim();
    if(!vin) return;

    const noteEl = document.getElementById('tr_note');
    const missEl = document.getElementById('tr_notesMissing');

    const note = (noteEl?.value || '').toString().trim();
    const missing = (missEl?.value || '').toString().trim();

    const patch = {
      notesMissing: missing ? missing : firebase.firestore.FieldValue.delete(),
      noteMissing : missing ? missing : firebase.firestore.FieldValue.delete(),
      notesLocation: note ? note : firebase.firestore.FieldValue.delete(),
      noteLocation : note ? note : firebase.firestore.FieldValue.delete(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: user.email || ''
    };

    await db.collection('cars').doc(vin).set(patch, { merge:true });

    // best-effort update local inventory cache
    try{
      const i = (invAll||[]).findIndex(x=>String(x.vin||'').trim()===vin);
      if(i>=0){
        invAll[i].notesMissing = missing;
        invAll[i].noteMissing  = missing;
        invAll[i].notesLocation = note;
        invAll[i].noteLocation  = note;
      }
    }catch(_){}
  }catch(e){
    console.warn('saveTransferNotesToCar', e);
  }
}

function scheduleSaveTransferNotes(){
  if(__trSaveTimer) clearTimeout(__trSaveTimer);
  __trSaveTimer = setTimeout(()=> saveTransferNotesToCar(__trActiveVin), 500);
}

    async function loadUserRole(email){
      try{
        const doc = await db.collection('users').doc(email).get();
        if(!doc.exists) return null;
        const d = doc.data() || {};
        return (d.role || d.type || d.permission || '').toString().trim();
      }catch(e){ return null; }
    }

    function roleAllows(role){
      if(!role) return false;
      const r = role.toString().toLowerCase();
      return ['admin','administrator','administration','ادارة','الإدارة','اداري','إداري'].some(x=>r.includes(x.toLowerCase()));
    }

    function parseVins(text){
      return Array.from(new Set(
        (text||'').split(/\r?\n/).map(x=>x.trim()).filter(Boolean)
      ));
    }

    // ===== Transfer VIN Table (multiple cars) =====
    function getTransferVinsFromTable(){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return [];
      const vins = [];
      tb.querySelectorAll('input[data-vin-input]').forEach(inp=>{
        const v = (inp.value||'').trim();
        if(v) vins.push(v);
      });
      // unique
      return Array.from(new Set(vins));
    }

    function clearTransferRows(){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return;
      tb.innerHTML = '';
      // add 3 empty rows by default
      addTransferRow();
    }

    function approvalsTextLocal(a){
      a = a || {};
      const f = a.financial===true ? '✓ مالية' : '✗ مالية';
      const ad = a.admin===true ? '✓ إدارية' : '✗ إدارية';
      return `${f} | ${ad}`;
    }

    function setRowLoading(tr, on){
      tr.dataset.loading = on ? '1' : '0';
      tr.style.opacity = on ? '.65' : '1';
    }

    async function fillRowFromVin(tr, vin){
      const cells = {
        car: tr.querySelector('[data-cell=car]'),
        loc: tr.querySelector('[data-cell=loc]'),
        st:  tr.querySelector('[data-cell=st]'),
        ap:  tr.querySelector('[data-cell=ap]')
      };

      if(!vin){
        cells.car.textContent = '';
        cells.loc.textContent = '';
        cells.st.textContent  = '';
        cells.ap.textContent  = '';
        tr.dataset.vin = '';
        try{ setTransferAgencyBoxVisible(false);
        try{ refreshTransferAgencyVinSelector(); }catch(_e){} }catch(_){ }
        return;
      }

      setRowLoading(tr, true);
      try{
        const snap = await db.collection('cars').doc(vin).get();
        if(!snap.exists){
          cells.car.textContent = 'غير موجود';
          cells.loc.textContent = '—';
          cells.st.textContent  = '—';
          cells.ap.textContent  = '—';
          tr.dataset.vin = vin;
          tr.dataset.missing = '1';
          try{ setTransferAgencyBoxVisible(false);
        try{ refreshTransferAgencyVinSelector(); }catch(_e){} }catch(_){ }
        }else{
          const d = snap.data()||{};
          cells.car.textContent = d.carName || '';
          cells.loc.textContent = d.location || '';
          cells.st.textContent  = d.status || '';
          cells.ap.textContent  = approvalsTextLocal(d.approvals);
          tr.dataset.vin = d.vin || vin;
          tr.dataset.missing = '0';

          // ✅ Auto-fill الحركة fields from DB by VIN (status + notes)
          try{
            const stNorm = normStatus(d.status || '');
            const stSel = document.getElementById('tr_status');
            if(stSel && stNorm){
              // ensure option exists
              if(!Array.from(stSel.options||[]).some(o=>o.value===stNorm)){
                const o=document.createElement('option');
                o.value = stNorm;
                o.textContent = stNorm;
                stSel.appendChild(o);
              }
              stSel.value = stNorm;
            }

            const nLoc = (d.notesLocation || d.noteLocation || '').toString();
            const nMis = (d.notesMissing || d.noteMissing || '').toString();

            const noteEl = document.getElementById('tr_note');
            const missEl = document.getElementById('tr_notesMissing');
            if(noteEl) noteEl.value = nLoc;
            if(missEl) missEl.value = nMis;

            const vinKey = (tr.dataset.vin || vin);

            setTransferActiveVin(vinKey, tr);

            // ✅ Agency-only UI: show checklist + interior color when current location is الوكالة
            const isAgency = (norm(d.location||'') === 'الوكالة');
            setTransferAgencyBoxVisible(isAgency);
        try{ refreshTransferAgencyVinSelector(); __syncAgencySelectorWithActiveVin(); }catch(_e){}
            try{ refreshTransferAgencyVinSelector(); __syncAgencySelectorWithActiveVin(); }catch(_e){}
            if(isAgency){
              fillTransferInteriorColors();
              // لكل هيكل لوحده: لو فيه بيانات محفوظة رجّعها، وإلا حمّل من السيارة وخزّن
              if(__trAgencyByVin && __trAgencyByVin[vinKey]){
                __loadAgencyUIFromVin(vinKey);
              }else{
                hydrateTransferAgencyFromCar(d);
                try{ __captureAgencyUIToVin(vinKey); }catch(_e){}
              }
            }
// show notes box if needed (status notes OR location notes OR note exists)
            const box = document.getElementById('tr_note_box');
            if(box){
              const need = (stNorm === 'بها ملاحظات') || isNotesLocation(d.location || '') || !!nLoc;
              if(need) box.classList.remove('hidden');
              else box.classList.add('hidden');
            }
          }catch(e){ /* ignore */ }
        }
      }finally{
        setRowLoading(tr, false);
      }
    }

    function addTransferRow(vin=''){
      const tb = document.querySelector('#tr_vinTable tbody');
      if(!tb) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-vin-input placeholder="اكتب VIN" value="${(vin||'').replace(/"/g,'&quot;')}" style="min-width:210px" /></td>
        <td data-cell="car"></td>
        <td data-cell="loc"></td>
        <td data-cell="st"></td>
        <td data-cell="ap"></td>
        <td><button class="btn danger" type="button" data-del-row style="padding:7px 10px;border-radius:10px">حذف</button></td>
      `;
      tb.appendChild(tr);

      const inp = tr.querySelector('input[data-vin-input]');

      // ✅ اختيار صف نشط لتعديل (التشييك + اللون الداخلي) لكل هيكل لوحده
      tr.addEventListener('click', (e)=>{
        if(e.target && e.target.closest && e.target.closest('[data-del-row]')) return;
        const v = (inp?.value || '').toString().trim();
        if(!v) return;
        setTransferActiveVin(v, tr);

        const locTxt = (tr.querySelector('[data-cell="loc"]')?.textContent || '').toString().trim();
        const isAgency = (locTxt === 'الوكالة');
        setTransferAgencyBoxVisible(isAgency);
        if(isAgency){
          fillTransferInteriorColors();
          __loadAgencyUIFromVin(v);
        }
      });

      let t=null;
      inp.addEventListener('input', ()=>{
        const v = inp.value.trim();
        if(t) clearTimeout(t);
        t = setTimeout(()=>fillRowFromVin(tr, v), 250);
      });
      inp.addEventListener('blur', ()=>fillRowFromVin(tr, inp.value.trim()));

      tr.querySelector('[data-del-row]').addEventListener('click', ()=>{
        tr.remove();
      });

      // initial fill if vin provided
      if(vin) fillRowFromVin(tr, vin);
    }

    function isNotesLocation(loc){
      return (loc||'').includes('سيارات بها ملاحظات');
    }

    function isUnderDelivery(loc){
      return (loc||'').includes('مباع تحت التسليم');
    }

    function isDelivered(loc){
      return (loc||'').includes('مباع تم التسليم');
    }

    async function fetchCarsByVins(vins){
      const res = [];
      for(const vin of vins){
        const snap = await db.collection('cars').doc(vin).get();
        if(snap.exists) res.push(snap.data());
        else res.push({ vin, _missing:true });
      }
      return res;
    }
    async function submitTransfer(){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const toLoc = $('tr_to').value;
      if(!toLoc) return toast('اختر المكان المستهدف');

      const selectedStatus = ($('tr_status')?.value || '').trim();
      if(!selectedStatus) return toast('اختر الحالة');

      // الحالة الفعلية: لو المكان المستهدف "مباع تحت التسليم" أو "مباع تم التسليم" نثبتها حتى لا يحصل تعارض
      let toStatus = selectedStatus;
      if(isUnderDelivery(toLoc)) toStatus = 'مباع تحت التسليم';
      if(isDelivered(toLoc))     toStatus = 'مباع تم التسليم';

      const noteRequired = (toStatus === 'بها ملاحظات') || isNotesLocation(toLoc);
      const note = $('tr_note').value.trim();

      const notesMissing = (document.getElementById('tr_notesMissing')?.value || '').trim();
      if(noteRequired && !note) return toast('اكتب الملاحظة (مطلوبة)');

      const vins = getTransferVinsFromTable();
      if(vins.length===0) return toast('اكتب VIN واحد على الأقل');

      const cars = await fetchCarsByVins(vins);
      const missing = cars.filter(x=>x._missing);
      if(missing.length){
        toast('في هياكل غير موجودة — راجع المعاينة');
        renderTransferPreview(cars);
        return;
      }

      // ممنوع "مباع تم التسليم" بدون موافقات (مالية + إدارية)
      const blocked = [];
      cars.forEach(d=>{
        if(isDelivered(toStatus)){
          const a = d.approvals || {};
          if(!(a.financial===true && a.admin===true)) blocked.push(d.vin);
        }
      });
      if(blocked.length){
        return toast('ممنوع نقل تم التسليم بدون موافقات: ' + blocked.slice(0,5).join(', ') + (blocked.length>5?'...':''));
      }

      const agencyData = readTransferAgencyInputs();

      // إنشاء طلب
      const req = {
        type: 'transfer',
        vins,
        toLocation: toLoc,
        toStatus: toStatus,
        selectedStatus: selectedStatus,
        note: noteRequired ? note : '',
        notesMissing: notesMissing || '',
        createdBy: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        status: 'created'
      };

      // لو الحالة: مباع تحت التسليم
      if(isUnderDelivery(toStatus)){
        req.requiresApprovals = true;
        req.approvalsStatus = { financial:false, admin:false };
      }

      const ref = await db.collection('transfers').add(req);

      // تحديث السيارات + تسجيل لوج لكل سيارة
      const batch = db.batch();
      cars.forEach(d=>{
        const carRef = db.collection('cars').doc(d.vin);
        const fromLoc = d.location || '';

        const update = {
          location: toLoc,
          status: toStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        // ✅ لو المكان الحالي كان الوكالة: احفظ (التشييك + اللون الداخلي) على نفس السيارة
        if(norm(fromLoc) === 'الوكالة' && agencyData){
          const vinKey = (d.vin || d.VIN || '').toString().trim();
          const a = (vinKey && agencyData[vinKey]) ? agencyData[vinKey] : null;
          if(a && a.interiorColor){
            update.interiorColor = a.interiorColor;
          }
          if(a && a.checklist){
            update.checklist = a.checklist;
          }
        }

        // لو الحالة: مباع تحت التسليم => جهّز الموافقات (وتظهر في كارت الموافقة المالية والإدارية)
        if(isUnderDelivery(toStatus)){
          const cur = d.approvals || {};
          update.approvals = {
            financial: (cur.financial===true),
            admin: (cur.admin===true)
          };
        }else{
          // ✅ الموافقات تفضل موجودة لو الحالة الجديدة "مباع تم التسليم"
          // وأي حالة ثانية => امسح الموافقات (حتى لو كانت موجودة قبل كده)
          const nextSt = normStatus(toStatus);
          if(nextSt !== 'مباع تم التسليم'){
            update.approvals = firebase.firestore.FieldValue.delete();
            update.approvalsNotes = firebase.firestore.FieldValue.delete();
            update.approvalsAt = firebase.firestore.FieldValue.delete();
            update.approvalsBy = firebase.firestore.FieldValue.delete();
            update.approvalsStatus = firebase.firestore.FieldValue.delete();
          }
        }


        // في حالة الحالة: بها ملاحظات (أو مكان سيارات بها ملاحظات): خزّن الملاحظة
        if(noteRequired){
          update.notesLocation = note;
          update.noteLocation = note;
        }else{
          // ✅ لو المستخدم اختار حالة غير (بها ملاحظات) نمسح الملاحظة من قاعدة البيانات
          update.notesLocation = firebase.firestore.FieldValue.delete();
          update.noteLocation  = firebase.firestore.FieldValue.delete();
        }

        // حجز - نواقص - تحديد مكان (تُحفظ فقط لو المستخدم كتب قيمة)
        if(notesMissing){ update.notesMissing = notesMissing; update.noteMissing = notesMissing; }

        batch.set(carRef, update, {merge:true});

        const logRef = db.collection('logs').doc();
        batch.set(logRef, {
          action: 'transfer',
          vin: d.vin,
          carName: d.carName || '',
          fromLocation: fromLoc,
          toLocation: toLoc,
          fromStatus: d.status || '',
          toStatus: toStatus,
          note: noteRequired ? note : '',
          notesMissing: notesMissing || '',
          by: user.email,
          requestId: ref.id,
          at: firebase.firestore.FieldValue.serverTimestamp()
        });
      });

      await batch.commit();

      clearTransferRows();
      $('tr_to').value = '';
      $('tr_status').value = '';
      $('tr_note').value = '';
      const tnm = document.getElementById('tr_notesMissing'); if(tnm) tnm.value = '';
      const icSel = document.getElementById('tr_int_color'); if(icSel) icSel.value='';
      TR_CHECK_ITEMS.forEach(it=>{ setTransferChecklistValue(it.key, true); });
      setTransferAgencyBoxVisible(false);
        try{ refreshTransferAgencyVinSelector(); }catch(_e){}
      $('tr_note_box').classList.add('hidden');
      toast('تم إنشاء طلب النقل وتحديث السيارات');

      // تحديث السجل فوراً
      startLogsLive();
    }

    // UI bindings transfer
    const trAddRow = $('tr_addRow');
    if(trAddRow) trAddRow.addEventListener('click', ()=>addTransferRow());

    const trClearRows = $('tr_clearRows');
    if(trClearRows) trClearRows.addEventListener('click', ()=>clearTransferRows());

    // init rows once
    if(document.querySelector('#tr_vinTable tbody') && document.querySelector('#tr_vinTable tbody').children.length===0){
      clearTransferRows();
    }

    const trTo = $('tr_to');
    if(trTo){
      trTo.addEventListener('change', ()=>{
        // صندوق الملاحظة يظهر لو الحالة = بها ملاحظات أو المكان = سيارات بها ملاحظات
        const st = document.getElementById('tr_status')?.value || '';
        if(isNotesLocation(trTo.value) || st==='بها ملاحظات') $('tr_note_box').classList.remove('hidden');
        else { $('tr_note_box').classList.add('hidden'); $('tr_note').value=''; }
      });
    }
    const trPreviewBtn = $('tr_preview');
    if(trPreviewBtn) trPreviewBtn.addEventListener('click', ()=>doPreview().catch(()=>toast('فشل المعاينة')));

    const trSubmitBtn = $('tr_submit');
    if(trSubmitBtn) trSubmitBtn.addEventListener('click', ()=>submitTransfer().catch(e=>toast(e.message||'فشل التنفيذ')));


const trNoteEl = document.getElementById('tr_note');
const trMissEl = document.getElementById('tr_notesMissing');

// حفظ تلقائي لأي تعديل في (حجز - نواقص - تحديد مكان) + الملاحظة
[trNoteEl, trMissEl].forEach(el=>{
  if(!el) return;
  el.addEventListener('input', ()=>{ scheduleSaveTransferNotes();

    // ===== Transfer (Agency) Checklist + Interior Color =====
    const TR_CHECK_ITEMS = [
      {key:'sensors', label:'حساس'},
      {key:'camera', label:'كاميرا'},
      {key:'ac', label:'مكيف'},
      {key:'recorder', label:'مسجل'},
      {key:'screen', label:'شاشة'},
      {key:'remote', label:'ريموت'},
      {key:'farshat', label:'فرشات'},
      {key:'tafaia', label:'طفاية'},
      {key:'shanta', label:'شنطة سلامة'},
      {key:'spare', label:'اسبير'},
    ];

    function fillTransferInteriorColors(){
      const sel = document.getElementById('tr_int_color');
      if(!sel) return;
      const cur = sel.value || '';
      const base = (APP_LISTS.interiorColors && APP_LISTS.interiorColors.length) ? APP_LISTS.interiorColors : DEFAULT_INTERIOR_COLORS;
      const uniq = Array.from(new Set(base.map(x=>(x||'').toString().trim()).filter(Boolean)));
      sel.innerHTML = '<option value="">— اختر —</option>' + uniq.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if(cur && uniq.includes(cur)) sel.value = cur;
    }

    function renderTransferChecklistUI(){
      const host = document.getElementById('tr_checklist_grid');
      if(!host) return;
      host.innerHTML = TR_CHECK_ITEMS.map(it=>{
        return `
          <div class="field" style="margin:0">
            <label style="font-weight:800">${escapeHtml(it.label)}</label>
            <div class="trSeg" data-tr-check="${escapeHtml(it.key)}" data-value="true" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <button type="button" class="btn secondary trSegBtn active" data-val="true" style="padding:6px 12px">نعم</button>
              <button type="button" class="btn secondary trSegBtn" data-val="false" style="padding:6px 12px">لا</button>
            </div>
          </div>
        `;
      }).join('');

      // bind segmented choices
      host.querySelectorAll('.trSeg').forEach(seg=>{
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest('.trSegBtn');
          if(!btn) return;
          const v = (btn.getAttribute('data-val')||'true') === 'true';
          setTransferChecklistSeg(seg, v);
          try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
        });
      });
    }

    function setTransferChecklistSeg(seg, bool){
      if(!seg) return;
      const v = bool ? 'true' : 'false';
      seg.dataset.value = v;
      const yes = seg.querySelector('[data-val="true"]');
      const no  = seg.querySelector('[data-val="false"]');
      if(yes) yes.classList.toggle('active', !!bool);
      if(no)  no.classList.toggle('active', !bool);
    }

    function setTransferChecklistValue(key, bool){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      if(seg) setTransferChecklistSeg(seg, !!bool);
    }

    function getTransferChecklistValue(key){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      return ((seg?.dataset?.value || 'true') === 'true');
    }

    function setTransferAgencyBoxVisible(isVisible){
      const box = document.getElementById('tr_agency_box');
      if(!box) return;
      if(isVisible) box.classList.remove('hidden');
      else box.classList.add('hidden');
    }

    function hydrateTransferAgencyFromCar(car){
      // interior color
      const sel = document.getElementById('tr_int_color');
      if(sel){
        const v = (car?.interiorColor || '').toString().trim();
        if(v){
          // ensure exists
          if(!Array.from(sel.options||[]).some(o=>o.value===v)){
            const o=document.createElement('option');
            o.value=v; o.textContent=v;
            sel.appendChild(o);
          }
          sel.value = v;
        }else{
          sel.value = '';
        }
      }

      // checklist
      const ck = car?.checklist || {};
      TR_CHECK_ITEMS.forEach(it=>{
        const val = (ck[it.key]===false) ? false : true; // default نعم
        setTransferChecklistValue(it.key, val);
      });
    }

    function readTransferAgencyInputs(){
      // ✅ تأكد نحفظ آخر تعديل للهيكل الحالي قبل التنفيذ
      try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
      const out = {};
      try{
        const src = (__trAgencyByVin && typeof __trAgencyByVin==='object') ? __trAgencyByVin : {};
        Object.keys(src).forEach(v=>{
          if(!v) return;
          out[v] = src[v] || {};
        });
      }catch(_e){}
      return Object.keys(out).length ? out : null;
    }

    async function addInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(!wrap || !inp) return;
      wrap.classList.remove('hidden');
      try{ inp.focus(); }catch(_){}
    }

    async function saveInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      const value = (inp?.value || '').toString().trim();
      if(!value) return;
      await addItemToList('interiorColors', value);
      // reload lists best effort
      try{ await loadMetaLists(); }catch(_){}
      fillTransferInteriorColors();
      const sel = document.getElementById('tr_int_color');
      if(sel) sel.value = value;
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
      toast('تمت إضافة اللون الداخلي');
    }

    function cancelInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
    }

    // one-time init for UI
    renderTransferChecklistUI();
    fillTransferInteriorColors();
    document.getElementById('tr_int_color')?.addEventListener('change', ()=>{ try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){} });
    document.getElementById('tr_add_int_color')?.addEventListener('click', addInteriorColorFromTransfer);
    document.getElementById('tr_save_int_color')?.addEventListener('click', saveInteriorColorFromTransfer);
    document.getElementById('tr_cancel_int_color')?.addEventListener('click', cancelInteriorColorFromTransfer);
 });
  el.addEventListener('blur',  ()=>{ saveTransferNotesToCar(__trActiveVin); });
  el.addEventListener('change',()=>{ scheduleSaveTransferNotes();

    // ===== Transfer (Agency) Checklist + Interior Color =====
    const TR_CHECK_ITEMS = [
      {key:'sensors', label:'حساس'},
      {key:'camera', label:'كاميرا'},
      {key:'ac', label:'مكيف'},
      {key:'recorder', label:'مسجل'},
      {key:'screen', label:'شاشة'},
      {key:'remote', label:'ريموت'},
      {key:'farshat', label:'فرشات'},
      {key:'tafaia', label:'طفاية'},
      {key:'shanta', label:'شنطة سلامة'},
      {key:'spare', label:'اسبير'},
    ];

    function fillTransferInteriorColors(){
      const sel = document.getElementById('tr_int_color');
      if(!sel) return;
      const cur = sel.value || '';
      const base = (APP_LISTS.interiorColors && APP_LISTS.interiorColors.length) ? APP_LISTS.interiorColors : DEFAULT_INTERIOR_COLORS;
      const uniq = Array.from(new Set(base.map(x=>(x||'').toString().trim()).filter(Boolean)));
      sel.innerHTML = '<option value="">— اختر —</option>' + uniq.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if(cur && uniq.includes(cur)) sel.value = cur;
    }

    function renderTransferChecklistUI(){
      const host = document.getElementById('tr_checklist_grid');
      if(!host) return;
      host.innerHTML = TR_CHECK_ITEMS.map(it=>{
        return `
          <div class="field" style="margin:0">
            <label style="font-weight:800">${escapeHtml(it.label)}</label>
            <div class="trSeg" data-tr-check="${escapeHtml(it.key)}" data-value="true" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <button type="button" class="btn secondary trSegBtn active" data-val="true" style="padding:6px 12px">نعم</button>
              <button type="button" class="btn secondary trSegBtn" data-val="false" style="padding:6px 12px">لا</button>
            </div>
          </div>
        `;
      }).join('');

      // bind segmented choices
      host.querySelectorAll('.trSeg').forEach(seg=>{
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest('.trSegBtn');
          if(!btn) return;
          const v = (btn.getAttribute('data-val')||'true') === 'true';
          setTransferChecklistSeg(seg, v);
          try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
        });
      });
    }

    function setTransferChecklistSeg(seg, bool){
      if(!seg) return;
      const v = bool ? 'true' : 'false';
      seg.dataset.value = v;
      const yes = seg.querySelector('[data-val="true"]');
      const no  = seg.querySelector('[data-val="false"]');
      if(yes) yes.classList.toggle('active', !!bool);
      if(no)  no.classList.toggle('active', !bool);
    }

    function setTransferChecklistValue(key, bool){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      if(seg) setTransferChecklistSeg(seg, !!bool);
    }

    function getTransferChecklistValue(key){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      return ((seg?.dataset?.value || 'true') === 'true');
    }

    function setTransferAgencyBoxVisible(isVisible){
      const box = document.getElementById('tr_agency_box');
      if(!box) return;
      if(isVisible) box.classList.remove('hidden');
      else box.classList.add('hidden');
    }

    function hydrateTransferAgencyFromCar(car){
      // interior color
      const sel = document.getElementById('tr_int_color');
      if(sel){
        const v = (car?.interiorColor || '').toString().trim();
        if(v){
          // ensure exists
          if(!Array.from(sel.options||[]).some(o=>o.value===v)){
            const o=document.createElement('option');
            o.value=v; o.textContent=v;
            sel.appendChild(o);
          }
          sel.value = v;
        }else{
          sel.value = '';
        }
      }

      // checklist
      const ck = car?.checklist || {};
      TR_CHECK_ITEMS.forEach(it=>{
        const val = (ck[it.key]===false) ? false : true; // default نعم
        setTransferChecklistValue(it.key, val);
      });
    }

    function readTransferAgencyInputs(){
      // ✅ تأكد نحفظ آخر تعديل للهيكل الحالي قبل التنفيذ
      try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
      const out = {};
      try{
        const src = (__trAgencyByVin && typeof __trAgencyByVin==='object') ? __trAgencyByVin : {};
        Object.keys(src).forEach(v=>{
          if(!v) return;
          out[v] = src[v] || {};
        });
      }catch(_e){}
      return Object.keys(out).length ? out : null;
    }

    async function addInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(!wrap || !inp) return;
      wrap.classList.remove('hidden');
      try{ inp.focus(); }catch(_){}
    }

    async function saveInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      const value = (inp?.value || '').toString().trim();
      if(!value) return;
      await addItemToList('interiorColors', value);
      // reload lists best effort
      try{ await loadMetaLists(); }catch(_){}
      fillTransferInteriorColors();
      const sel = document.getElementById('tr_int_color');
      if(sel) sel.value = value;
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
      toast('تمت إضافة اللون الداخلي');
    }

    function cancelInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
    }

    // one-time init for UI
    renderTransferChecklistUI();
    fillTransferInteriorColors();
    document.getElementById('tr_int_color')?.addEventListener('change', ()=>{ try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){} });
    document.getElementById('tr_add_int_color')?.addEventListener('click', addInteriorColorFromTransfer);
    document.getElementById('tr_save_int_color')?.addEventListener('click', saveInteriorColorFromTransfer);
    document.getElementById('tr_cancel_int_color')?.addEventListener('click', cancelInteriorColorFromTransfer);
 });
});


    // Logs live (last movements)
    function deriveMovementType(d){
      d = d || {};
      const fromLoc = (d.fromLocation||d.from||'').toString();
      const toLoc   = (d.toLocation||d.to||'').toString();
      const fromSt  = (d.fromStatus||'').toString();
      const toSt    = (d.toStatus||'').toString();
      const parts = [];
      if(fromLoc && toLoc && fromLoc !== toLoc) parts.push('نقل مكان');
      if(fromSt && toSt && fromSt !== toSt) parts.push('تغيير حالة');
      if((d.notesMissing||'').toString().trim()) parts.push('حجز/نواقص');
      if((d.note||'').toString().trim()) parts.push('ملاحظة حالة');
      if(!parts.length){
        if((d.action||'')==='transfer') return 'نقل';
        return (d.action||'').toString() || '—';
      }
      return parts.join(' + ');
    }


    let logUnsub = null;
    function stopLogsLive(){ if(logUnsub){logUnsub(); logUnsub=null;} }
    function startLogsLive(tableId='log_table', metaId='log_meta'){
      if(logUnsub) return;
      logUnsub = db.collection('logs').orderBy('at','desc').limit(50).onSnapshot((snap)=>{
        const tb = document.querySelector('#'+tableId+' tbody');
        if(!tb) return;
        tb.innerHTML = '';
        let count = 0;
        snap.forEach(doc=>{
          const d = doc.data()||{};
          const tr = document.createElement('tr');
          const type = (d.action||'').includes('request_') ? 'طلبات' : ((d.action||'')==='transfer' ? 'نقل' : (d.action||''));
          const cells = [type, d.vin||'', d.fromLocation||d.from||'', d.toLocation||d.to||'', d.note||'', d.by||'', deriveMovementType(d)];
          cells.forEach(t=>{
            const td = document.createElement('td');
            td.textContent = t;
            tr.appendChild(td);
          });
          tb.appendChild(tr);
          count++;
        });
        const meta = document.getElementById(metaId);
        if(meta) meta.textContent = `آخر الحركات: ${count}`;
      }, (err)=>toast(err.message||'فشل تحميل السجل'));
    }

    // تعديل openView لتفعيل السجل داخل تبويب النقل
    const _openView = openView;
    openView = function(viewId){
      _openView(viewId);
      if(viewId==='view-transfer'){
        stopLogsLive();
        startLogsLive('log_table','log_meta');
      }else if(viewId==='view-requests'){
        stopLogsLive();
        startLogsLive('log_table_req','log_meta_req');
      }else{
        stopLogsLive();
      }
      if(viewId==='view-logs') loadLogs().catch(e=>toast(e.message||'فشل تحميل السجل'));
    }


    
    // ===== Logs (Global) =====
    async function logAction(tab, action, extra){
      try{
        const user = auth.currentUser;
        if(!user) return;
        const payload = Object.assign({}, extra||{});
        // حاول التقاط اسم السيارة/الموديل لو موجود
        const doc = {
          tab: tab || '',
          action: action || '',
          vin: payload.vin || '',
          carName: payload.carName || payload.car || '',
          model: payload.model || '',
          fromLocation: payload.fromLocation || payload.from || '',
          toLocation: payload.toLocation || payload.to || '',
          by: user.email || '',
          at: firebase.firestore.FieldValue.serverTimestamp(),
          payload
        };
        await db.collection('logs').add(doc);
      }catch(e){
        // لا نوقف العملية الأساسية بسبب اللوج
        console.warn('logAction failed', e);
      }
    }

    function boolTag(v){ return v===true ? '✓' : (v===false ? '✗' : ''); }

    // --- قوائم النظام (الفروع + الحالات) من Firestore: meta/lists ---
    const META_LISTS_PATH = {col:'meta', doc:'lists'};
    const DEFAULT_BRANCHES = ['الملتقى','القادسية','الصالة','الوكالة','المستودع'];
    const DEFAULT_STATUSES = ['مباع تحت التسليم','متاح للبيع','حجز','مباع تم التسليم','بها ملاحظات'];
    const DEFAULT_INTERIOR_COLORS = ['احمر','اسود','برتقالي','بني غامق','بيج','جملي','رمادي'];

    let APP_LISTS = { branches:[...DEFAULT_BRANCHES], statuses:[...DEFAULT_STATUSES], interiorColors:[...DEFAULT_INTERIOR_COLORS] };

    async function ensureMetaLists(){
      const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
      const snap = await ref.get();
      if(!snap.exists){
        await ref.set({
          branches: DEFAULT_BRANCHES,
          statuses: DEFAULT_STATUSES,
          interiorColors: DEFAULT_INTERIOR_COLORS,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser?.email || ''
        });
      }
    }

    async function loadMetaLists(){
      // لازم القوائم تشتغل حتى لو meta/lists عليها صلاحيات/غير موجودة
      try{
        await ensureMetaLists();
        const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
        const snap = await ref.get();
        const d = snap.data() || {};
        const b = Array.isArray(d.branches) ? d.branches.filter(Boolean) : DEFAULT_BRANCHES;
        const s = Array.isArray(d.statuses) ? d.statuses.filter(Boolean) : DEFAULT_STATUSES;
        const ic = Array.isArray(d.interiorColors) ? d.interiorColors.filter(Boolean) : DEFAULT_INTERIOR_COLORS;
        APP_LISTS = { branches: b.length?b:DEFAULT_BRANCHES, statuses: s.length?s:DEFAULT_STATUSES, interiorColors: ic.length?ic:DEFAULT_INTERIOR_COLORS };
      }catch(e){
        console.warn('loadMetaLists fallback', e);
        APP_LISTS = { branches:[...DEFAULT_BRANCHES], statuses:[...DEFAULT_STATUSES], interiorColors:[...DEFAULT_INTERIOR_COLORS] };
      }

      // الاتفاق: الفروع تُقرأ من meta/list/branches
      try{
        const snap2 = await db.collection('meta').doc('list').collection('branches').get();
        const arr = [];
        snap2.forEach(d=>{
          const data = d.data() || {};
          const name = (data.name || data.title || data.branch || data.value || d.id || '').toString().trim();
          if(name) arr.push(name);
        });
        const branches = Array.from(new Set(arr)).sort((a,b)=>a.localeCompare(b,'ar'));
        if(branches.length) APP_LISTS.branches = branches;
      }catch(e){
        console.warn('load branches meta/list/branches failed', e);
      }

      fillAllLists();
    }

    function makeOption(val, text){
      const o=document.createElement('option');
      o.value=val; o.textContent=text;
      return o;
    }

    function fillSelect(sel, items, addLabel){
      if(!sel) return;
      const cur = sel.value;
      sel.innerHTML='';
      sel.appendChild(makeOption('', '— اختر —'));
      items.forEach(x=> sel.appendChild(makeOption(x, x)));
      sel.appendChild(makeOption('__add__', addLabel));
      // restore if exists
      if(items.includes(cur)) sel.value=cur;
      else sel.value = '';
    }

    function fillAllLists(){
      fillSelect(document.getElementById('f_location'), APP_LISTS.branches, '➕ إضافة مكان جديد');
      fillSelect(document.getElementById('n_location'), APP_LISTS.branches, '➕ إضافة مكان جديد');
      fillSelect(document.getElementById('tr_to'), APP_LISTS.branches, '➕ إضافة مكان جديد');
      fillSelect(document.getElementById('req_to'), APP_LISTS.branches, '➕ إضافة مكان جديد');

      fillSelect(document.getElementById('f_status'), APP_LISTS.statuses, '➕ إضافة حالة جديدة');
      fillSelect(document.getElementById('n_status'), APP_LISTS.statuses, '➕ إضافة حالة جديدة');
      fillSelect(document.getElementById('tr_status'), APP_LISTS.statuses, '➕ إضافة حالة جديدة');
      // سجل الحركات: فلتر (من)
      fillLogsLocations();
    }

    async function addItemToList(kind, value){
      value = (value||'').trim();
      if(!value) return;

      // تحديث meta/lists (للتوافق)
      try{
        const ref = db.collection(META_LISTS_PATH.col).doc(META_LISTS_PATH.doc);
        const snap = await ref.get();
        const d = snap.data() || {};
        const arr = (kind==='branches') ? (d.branches||[]) : (kind==='statuses' ? (d.statuses||[]) : (d.interiorColors||[]));
        if(!arr.includes(value)){
          arr.push(value);
          const payload = { updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: auth.currentUser?.email || '' };
          payload[kind] = arr;
          await ref.set(payload, {merge:true});
        }
      }catch(e){
        console.warn('addItemToList meta/lists failed', e);
      }

      // الاتفاق: الفروع تُحفظ أيضًا في meta/list/branches
      if(kind==='branches'){
        try{
          await db.collection('meta').doc('list').collection('branches').doc(value).set({
            name: value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: auth.currentUser?.email || ''
          }, {merge:true});
        }catch(e){
          console.warn('add branch meta/list/branches failed', e);
        }
      }

      // ✅ الألوان الداخلية تُحفظ أيضًا في meta/list/interiorColors
      if(kind==='interiorColors'){
        try{
          await db.collection('meta').doc('list').collection('interiorColors').doc(value).set({
            name: value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: auth.currentUser?.email || ''
          }, {merge:true});
        }catch(e){
          console.warn('add interiorColors meta/list/interiorColors failed', e);
        }
      }


      try{ await logAction('admin','list_add',{kind, value}); }catch(e){}
      await loadMetaLists();
    }

    async function handleSelectAdd(e){
      const sel = e.target;
      if(!sel || sel.value!=='__add__') return;
      sel.value='';
      const isBranch = (sel.id==='f_location' || sel.id==='tr_to' || sel.id==='req_to');
      const kind = isBranch ? 'branches' : 'statuses';
      const label = isBranch ? 'اكتب اسم المكان الجديد' : 'اكتب اسم الحالة الجديدة';
      const v = prompt(label);
      if(v) await addItemToList(kind, v);
    }

    function bindListsEvents(){
      ['f_location','n_location','tr_to','req_to','f_status','n_status','tr_status'].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.addEventListener('change', handleSelectAdd);
      });
    }

    function uiStatusNotesToggle(){
      const st = document.getElementById('f_status')?.value || '';
      const box = document.getElementById('f_carNotes_box');
      if(!box) return;
      if(st==='بها ملاحظات') box.classList.remove('hidden');
      else { box.classList.add('hidden'); document.getElementById('f_carNotes').value=''; }
    }

    function uiNewStatusNotesToggle(){
      const st = document.getElementById('n_status')?.value || '';
      const box = document.getElementById('n_carNotes_box');
      if(!box) return;
      if(st==='بها ملاحظات') box.classList.remove('hidden');
      else { box.classList.add('hidden'); const inp=document.getElementById('n_carNotes'); if(inp) inp.value=''; }
    }

    function uiTransferNoteToggle(){
      const st = (document.getElementById('tr_status')?.value || '').trim();
      const toLoc = (document.getElementById('tr_to')?.value || '').trim();
      const box = document.getElementById('tr_note_box');
      if(!box) return;

      const need = (st==='بها ملاحظات') || isNotesLocation(toLoc);
      if(need){
        box.classList.remove('hidden');
      }else{
        box.classList.add('hidden');
        const inp = document.getElementById('tr_note'); 
        if(inp) inp.value = '';
      }
    }
    scheduleSaveTransferNotes();

    // ===== Transfer (Agency) Checklist + Interior Color =====
    const TR_CHECK_ITEMS = [
      {key:'sensors', label:'حساس'},
      {key:'camera', label:'كاميرا'},
      {key:'ac', label:'مكيف'},
      {key:'recorder', label:'مسجل'},
      {key:'screen', label:'شاشة'},
      {key:'remote', label:'ريموت'},
      {key:'farshat', label:'فرشات'},
      {key:'tafaia', label:'طفاية'},
      {key:'shanta', label:'شنطة سلامة'},
      {key:'spare', label:'اسبير'},
    ];

    function fillTransferInteriorColors(){
      const sel = document.getElementById('tr_int_color');
      if(!sel) return;
      const cur = sel.value || '';
      const base = (APP_LISTS.interiorColors && APP_LISTS.interiorColors.length) ? APP_LISTS.interiorColors : DEFAULT_INTERIOR_COLORS;
      const uniq = Array.from(new Set(base.map(x=>(x||'').toString().trim()).filter(Boolean)));
      sel.innerHTML = '<option value="">— اختر —</option>' + uniq.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('');
      if(cur && uniq.includes(cur)) sel.value = cur;
    }

    function renderTransferChecklistUI(){
      const host = document.getElementById('tr_checklist_grid');
      if(!host) return;
      host.innerHTML = TR_CHECK_ITEMS.map(it=>{
        return `
          <div class="field" style="margin:0">
            <label style="font-weight:800">${escapeHtml(it.label)}</label>
            <div class="trSeg" data-tr-check="${escapeHtml(it.key)}" data-value="true" style="display:flex;gap:6px;align-items:center;flex-wrap:wrap">
              <button type="button" class="btn secondary trSegBtn active" data-val="true" style="padding:6px 12px">نعم</button>
              <button type="button" class="btn secondary trSegBtn" data-val="false" style="padding:6px 12px">لا</button>
            </div>
          </div>
        `;
      }).join('');

      // bind segmented choices
      host.querySelectorAll('.trSeg').forEach(seg=>{
        seg.addEventListener('click', (e)=>{
          const btn = e.target.closest('.trSegBtn');
          if(!btn) return;
          const v = (btn.getAttribute('data-val')||'true') === 'true';
          setTransferChecklistSeg(seg, v);
          try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
        });
      });
    }

    function setTransferChecklistSeg(seg, bool){
      if(!seg) return;
      const v = bool ? 'true' : 'false';
      seg.dataset.value = v;
      const yes = seg.querySelector('[data-val="true"]');
      const no  = seg.querySelector('[data-val="false"]');
      if(yes) yes.classList.toggle('active', !!bool);
      if(no)  no.classList.toggle('active', !bool);
    }

    function setTransferChecklistValue(key, bool){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      if(seg) setTransferChecklistSeg(seg, !!bool);
    }

    function getTransferChecklistValue(key){
      const seg = document.querySelector(`[data-tr-check="${key}"]`);
      return ((seg?.dataset?.value || 'true') === 'true');
    }

    function setTransferAgencyBoxVisible(isVisible){
      const box = document.getElementById('tr_agency_box');
      if(!box) return;
      if(isVisible) box.classList.remove('hidden');
      else box.classList.add('hidden');
    }

    function hydrateTransferAgencyFromCar(car){
      // interior color
      const sel = document.getElementById('tr_int_color');
      if(sel){
        const v = (car?.interiorColor || '').toString().trim();
        if(v){
          // ensure exists
          if(!Array.from(sel.options||[]).some(o=>o.value===v)){
            const o=document.createElement('option');
            o.value=v; o.textContent=v;
            sel.appendChild(o);
          }
          sel.value = v;
        }else{
          sel.value = '';
        }
      }

      // checklist
      const ck = car?.checklist || {};
      TR_CHECK_ITEMS.forEach(it=>{
        const val = (ck[it.key]===false) ? false : true; // default نعم
        setTransferChecklistValue(it.key, val);
      });
    }

    function readTransferAgencyInputs(){
      // ✅ تأكد نحفظ آخر تعديل للهيكل الحالي قبل التنفيذ
      try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){}
      const out = {};
      try{
        const src = (__trAgencyByVin && typeof __trAgencyByVin==='object') ? __trAgencyByVin : {};
        Object.keys(src).forEach(v=>{
          if(!v) return;
          out[v] = src[v] || {};
        });
      }catch(_e){}
      return Object.keys(out).length ? out : null;
    }

    async function addInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(!wrap || !inp) return;
      wrap.classList.remove('hidden');
      try{ inp.focus(); }catch(_){}
    }

    async function saveInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      const value = (inp?.value || '').toString().trim();
      if(!value) return;
      await addItemToList('interiorColors', value);
      // reload lists best effort
      try{ await loadMetaLists(); }catch(_){}
      fillTransferInteriorColors();
      const sel = document.getElementById('tr_int_color');
      if(sel) sel.value = value;
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
      toast('تمت إضافة اللون الداخلي');
    }

    function cancelInteriorColorFromTransfer(){
      const wrap = document.getElementById('tr_int_color_add_wrap');
      const inp  = document.getElementById('tr_int_color_new');
      if(inp) inp.value = '';
      if(wrap) wrap.classList.add('hidden');
    }

    // one-time init for UI
    renderTransferChecklistUI();
    fillTransferInteriorColors();
    document.getElementById('tr_int_color')?.addEventListener('change', ()=>{ try{ __captureAgencyUIToVin(__trActiveVin); }catch(_e){} });
    document.getElementById('tr_add_int_color')?.addEventListener('click', addInteriorColorFromTransfer);
    document.getElementById('tr_save_int_color')?.addEventListener('click', saveInteriorColorFromTransfer);
    document.getElementById('tr_cancel_int_color')?.addEventListener('click', cancelInteriorColorFromTransfer);



    function uiReqTypeChanged(){
      const t = document.getElementById('req_type')?.value || 'transfer';
      const label = document.getElementById('req_loc_label');
      if(label) label.textContent = (t==='photo') ? 'مكان التصوير' : 'مكان النقل';
      const box = document.getElementById('req_photo_date_box');
      if(box){
        if(t==='photo') box.classList.remove('hidden');
        else box.classList.add('hidden');
      }
    }

    function uiReqNoteToggle(){
      const st = document.getElementById('req_status')?.value || '';
      // ملاحظة الطلب لكل VIN موجودة في الجدول؛ لا نضيف صندوق هنا.
    }

    // --- أماكن سجل الحركات (تعتمد على الفروع) ---
    function fillLogsLocations(){
      const selFrom = document.getElementById('lg_from_loc');
      const selTo = document.getElementById('lg_to_loc');
      if(!selFrom && !selTo) return;
      if(selFrom) selFrom.innerHTML='';
      if(selTo) selTo.innerHTML='';
      (APP_LISTS.branches||[]).forEach(l=>{
        if(selFrom) selFrom.appendChild(makeOption(l,l));
        if(selTo) selTo.appendChild(makeOption(l,l));
      });
    }
    function uiLogsFilterChanged(){
      const mode = document.getElementById('lg_filter')?.value || 'all';
      const searchBox = document.getElementById('lg_search_box');
      const fromBox = document.getElementById('lg_from_box');
      const toBox = document.getElementById('lg_to_box');
      if(!searchBox || !fromBox || !toBox) return;

      if(mode==='from'){
        // عند اختيار (من): نعرض اختيار (من) + اختيار (إلى) معًا
        fromBox.classList.remove('hidden');
        toBox.classList.remove('hidden');
        searchBox.classList.add('hidden');
      }else if(mode==='to'){
        toBox.classList.remove('hidden');
        fromBox.classList.add('hidden');
        searchBox.classList.add('hidden');
      }else if(mode==='all'){
        fromBox.classList.add('hidden');
        toBox.classList.add('hidden');
        searchBox.classList.add('hidden');
      }else{
        fromBox.classList.add('hidden');
        toBox.classList.add('hidden');
        searchBox.classList.remove('hidden');
        document.getElementById('lg_search').placeholder = (mode==='vin') ? 'اكتب رقم الهيكل' : 'اكتب اسم السيارة';
      }
    }

    async function loadLogs(){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const fromStr = document.getElementById('lg_from')?.value || '';
      const toStr = document.getElementById('lg_to')?.value || '';
      const mode = document.getElementById('lg_filter')?.value || 'all';
      const qSearch = (document.getElementById('lg_search')?.value || '').trim();

      const fromLoc = document.getElementById('lg_from_loc')?.value || '';
      const toLoc = document.getElementById('lg_to_loc')?.value || '';

      // افتراضي: آخر 7 أيام لو ما اختار تاريخ
      const now = new Date();
      const fromDate = fromStr ? new Date(fromStr+'T00:00:00') : new Date(now.getTime()-7*24*60*60*1000);
      const toDate = toStr ? new Date(toStr+'T23:59:59') : now;

      let q = db.collection('logs')
        .where('at','>=', firebase.firestore.Timestamp.fromDate(fromDate))
        .where('at','<=', firebase.firestore.Timestamp.fromDate(toDate))
        .orderBy('at','desc')
        .limit(500);

      // ⚠️ لتفادي طلب Index مركب: نجلب آخر الحركات حسب التاريخ فقط، ثم نفلتر محليًا.
      const snap = await q.get();
      let logs = [];
      snap.forEach(d=>logs.push({id:d.id, ...(d.data()||{})}));

      // فلترة محلية حسب وضع الفلتر
      if(mode==='vin' && qSearch){
        logs = logs.filter(l=> (l.vin||'').toString().trim() === qSearch);
      }
      if(mode==='from'){
        // عند اختيار (من): ممكن تختار من + إلى معًا
        if(fromLoc) logs = logs.filter(l=> (l.fromLocation||'') === fromLoc);
        if(toLoc)   logs = logs.filter(l=> (l.toLocation||'') === toLoc);
      }
      if(mode==='to'){
        if(toLoc) logs = logs.filter(l=> (l.toLocation||'') === toLoc);
      }
      if(mode==='car' && qSearch){
        const ss = qSearch.toLowerCase();
        logs = logs.filter(l=> (l.carName||'').toLowerCase().includes(ss));
      }

      // اجلب بيانات السيارات (Join) لإظهار التشيك + الموافقات + المكان الحالي + اللون الداخلي
      const vins = Array.from(new Set(logs.map(l=>l.vin).filter(Boolean))).slice(0,300);
      const carMap = {};
      await Promise.all(vins.map(async (vin)=>{
        try{
          const cs = await db.collection('cars').doc(vin).get();
          if(cs.exists) carMap[vin] = cs.data()||{};
        }catch(e){}
      }));

      const tb = document.querySelector('#lg_table tbody');
      tb.innerHTML = '';
      let shown=0;

      logs.forEach(l=>{
        const car = carMap[l.vin] || {};
        const c = car.checklist || {};
        const a = car.approvals || {};
        const dt = l.at && l.at.toDate ? l.at.toDate() : null;
        const time = dt ? dt.toLocaleString('ar-SA') : '';

        const row = [
          l.vin||'',
          (l.carName || car.carName || ''),
          (car.statement || ''),
          (car.agent || ''),
          (car.interiorColor || ''),
          (car.exteriorColor || ''),
          (car.model || ''),
          (car.plate || ''),
          (car.batchName || ''),
          time,
          (l.toLocation||l.fromLocation||car.location||''),
          (car.notesLocation || car.noteLocation || ''),
          (car.notesMissing || car.noteMissing || ''),
          (car.status || ''),
          boolTag( (c.sensors===true) || (c.sensor===true) ),
          boolTag( c.camera===true ),
          boolTag( c.ac===true ),
          boolTag( (c.musajjal===true) || (c.recorder===true) ),
          boolTag( c.screen===true ),
          boolTag( c.remote===true ),
          boolTag( c.farshat===true ),
          boolTag( c.tafaia===true ),
          boolTag( c.shanta===true ),
          boolTag( c.spare===true ),
          boolTag( a.financial===true ),
          boolTag( a.admin===true ),
          (l.by||''), deriveMovementType(l)
        ];

        const tr = document.createElement('tr');
        row.forEach(val=>{
          const td = document.createElement('td');
          td.textContent = val;
          tr.appendChild(td);
        });
        tb.appendChild(tr);
        shown++;
      });

      const meta = document.getElementById('lg_meta');
      if(meta) meta.textContent = `المعروض: ${shown} (الحد الأقصى 300)`;
      window.__lastLogsExport = logs.map(l=>{
        const car = carMap[l.vin] || {};
        const c = car.checklist || {};
        const a = car.approvals || {};
        const dt = l.at && l.at.toDate ? l.at.toDate() : null;
        return {          'رقم الهيكل (VIN)': l.vin||'',
          السيارة: l.carName || car.carName || '',
          البيان: car.statement || '',
          الوكيل: car.agent || '',
          'اللون الداخلي': car.interiorColor || '',
          'اللون الخارجي': car.exteriorColor || '',
          موديل: car.model || '',
          اللوحة: car.plate || '',
          'اسم الدفعة': car.batchName || '',
          بالتاريخ: dt ? dt.toLocaleString('ar-SA') : '',
          المكان: (l.toLocation||l.fromLocation||car.location||''),
          'ملاحظات في السيارة': (car.notesLocation || car.noteLocation || ''),
          'حجز - نواقص - تحديد مكان': (car.notesMissing || car.noteMissing || ''),
          الحالة: (car.status || ''),
          حساس: (c.sensors===true)||(c.sensor===true) ? '✓' : '✗',
          كاميرا: c.camera===true ? '✓':'✗',
          مكيف: c.ac===true ? '✓':'✗',
          مسجل: (c.musajjal===true)||(c.recorder===true) ? '✓':'✗',
          شاشة: c.screen===true ? '✓':'✗',
          ريموت: c.remote===true ? '✓':'✗',
          فرشات: c.farshat===true ? '✓':'✗',
          طفاية: c.tafaia===true ? '✓':'✗',
          'شنطة سلامة': c.shanta===true ? '✓':'✗',
          اسبير: c.spare===true ? '✓':'✗',
          'الموافقة المالية': a.financial===true ? '✓':'✗',
          'الموافقة الادارية': a.admin===true ? '✓':'✗',
          'منفذ الحركة': l.by||'',
          'نوع الحركة': deriveMovementType(l)
        };
      });
    }

    function exportLogsExcel(){
      const tbl = document.getElementById('lg_table');
      if(!tbl) return toast('لا يوجد جدول للتصدير');
      // تصدير مباشر من الجدول للحفاظ على ترتيب الأعمدة
      const wb = XLSX.utils.table_to_book(tbl, { sheet: 'سجل الحركات' });
      downloadWorkbook(wb, 'movement_log.xlsx');
    }

    function exportLogsPDF(){
      const rows = window.__lastLogsExport || [];
      if(!rows.length) return toast('لا يوجد بيانات للتصدير');

      const paper = (document.getElementById('lg_paper')?.value || 'A3');

      // نفتح نافذة طباعة بإعدادات Landscape
      const cols = [
        'رقم الهيكل (VIN)','السيارة','البيان','الوكيل','اللون الداخلي','اللون الخارجي','موديل','اللوحة','اسم الدفعة',
        'بالتاريخ','المكان','ملاحظات في السيارة','حجز - نواقص - تحديد مكان','الحالة',
        'حساس','كاميرا','مكيف','مسجل','شاشة','ريموت','فرشات','طفاية','شنطة سلامة','اسبير','الموافقة المالية','الموافقة الادارية','منفذ الحركة','نوع الحركة'
      ];

      const esc = (s)=>String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

      let html = `<!doctype html><html lang="ar" dir="rtl"><head><meta charset="utf-8" />
        <title>تصدير سجل الحركات</title>
        <style>
          @page{ size: ${paper} landscape; margin: 10mm; }
          body{ font-family: Tajawal, Arial, sans-serif; direction: rtl; }
          h2{ margin:0 0 8px 0; font-size: 16px; }
          table{ width:100%; border-collapse: collapse; font-size: 10px; table-layout: fixed; }
          td,th{ word-break: break-word; }
          th,td{ border:1px solid #999; padding:6px; vertical-align: top; }
          th{ background:#f3f3f3; }
        
/* ---- Badge alignment override ---- */
.dashTotalWrap{
  justify-content:flex-start;
  align-items:center;
  margin-top:-6px;
  margin-bottom:8px;
}

</style></head><body>
        <h2>سجل الحركات</h2>
        <table><thead><tr>${cols.map(c=>`<th>${esc(c)}</th>`).join('')}</tr></thead><tbody>`;

      for(const r of rows){
        html += '<tr>' + cols.map(c=>`<td>${esc(r[c] ?? r[c.replace(/\s+/g,' ')] ?? '')}</td>`).join('') + '</tr>';
      }
      html += `</tbody></table></body></html>`;

      const w = window.open('', '_blank');
      if(!w) return toast('تم منع فتح نافذة الطباعة (Pop-up)');
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      // تأخير بسيط لضمان تحميل الخط/الجدول
      setTimeout(()=>{ try{ w.print(); }catch(e){} }, 300);
    }

    
    // ===== Requests Tab =====
    let reqUnsub = null;

    function stopRequestsLive(){
      // no-op (no live listener)
      reqUnsub = null;
    }

    function fmtDate(ts){
      try{
        const d = ts && ts.toDate ? ts.toDate() : (ts instanceof Date ? ts : null);
        return d ? d.toLocaleString('ar-SA') : '';
      }catch(_){ return ''; }
    }

    function reqTypeLabel(t){
      return t==='photo' ? 'تصوير' : 'نقل';
    }


    function reqFromLabel(r){
      try{
        const locs = [];
        const items = (r && Array.isArray(r.items)) ? r.items : [];
        items.forEach(it=>{
          const l = (it && (it.fromLocation || it.from || it.fromLoc)) ? String(it.fromLocation || it.from || it.fromLoc).trim() : '';
          if(l) locs.push(l);
        });
        if(!locs.length){
          const l1 = (r && r.fromLocation) ? String(r.fromLocation).trim() : '';
          if(l1) locs.push(l1);
          const arr = (r && Array.isArray(r.fromLocations)) ? r.fromLocations : [];
          arr.forEach(x=>{ const l=String(x||'').trim(); if(l) locs.push(l); });
        }
        const uniq = Array.from(new Set(locs));
        if(!uniq.length) return '';
        if(uniq.length===1) return uniq[0];
        return 'متعدد';
      }catch(e){ return ''; }
    }


    

    function buildReqBody(r, carMap){
      const items = r.items || [];
      const statusTxt = reqStatusLabel(r);
      const meta = `
        <div class="small">
          <div><b>نوع الطلب:</b> ${reqTypeLabel(r.type)}</div>
          <div><b>من:</b> ${reqFromLabel(r)}</div>
          <div><b>المكان المستهدف:</b> ${r.toLocation||''}</div>
          <div><b>الحالة:</b> ${statusTxt}</div>
          ${r.type==='photo' ? `<div><b>تاريخ التصوير:</b> ${r.photoDate||''}</div>` : ``}
          <div><b>تاريخ الطلب:</b> ${fmtDate(r.createdAt)}</div>
          <div><b>المنشئ:</b> ${r.createdBy||''}</div>
        </div>`;

      const rows = items.map(it=>{
        const c = (carMap && carMap[it.vin]) ? carMap[it.vin] : {};
        return `
          <tr>
            <td>${escapeHtml(it.vin||'')}</td>
            <td>${escapeHtml(c.carName||'')}</td>
            <td>${escapeHtml(c.statement||'')}</td>
            <td>${escapeHtml(c.exteriorColor||'')}</td>
            <td>${escapeHtml(c.interiorColor||'')}</td>
            <td>${escapeHtml(c.model||'')}</td>
            <td>${escapeHtml(it.fromLocation||'')}</td>
            <td>${escapeHtml(c.location||'')}</td>
            <td>${escapeHtml(it.note||'')}</td>
          </tr>`;
      }).join('');

      const carsTable = `
        <div style="margin-top:12px">
          <div style="font-weight:900;color:var(--brown);margin-bottom:8px">تفاصيل الطلب</div>
          <div class="tableWrap" style="max-height:320px">
            <table>
              <thead>
                <tr>
                  <th>رقم الهيكل</th>
                  <th>السيارة</th>
                  <th>الفئة</th>
                  <th>الخارجي</th>
                  <th>الداخلي</th>
                  <th>الموديل</th>
                  <th>من</th>
                  <th>المكان الحالي</th>
                  <th>ملاحظات</th>
                </tr>
              </thead>
              <tbody>${rows || ''}</tbody>
            </table>
          </div>
        </div>`;

      const steps = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
          <div class="checkItem" style="background:#fff"><span>تم استلام الطلب</span><div>${r.step1At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم ارسال السيارة</span><div>${r.step2At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم استلام السيارة</span><div>${r.step3At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
          <div class="checkItem" style="background:#fff"><span>تم الانتهاء</span><div>${r.step4At ? '<span class="tag ok">✓</span>' : '<span class="tag no">✗</span>'}</div></div>
        </div>`;

      return meta + carsTable + steps;
    }

function reqStatusLabel(r){
      const s1 = !!r.step1At;
      const s2 = !!r.step2At;
      const s3 = !!r.step3At;
      const s4 = !!r.step4At;
      if(s4) return 'تم الانتهاء';
      if(s3) return 'تم استلام السيارة';
      if(s2) return 'تم ارسال السيارة';
      if(s1) return 'تم استلام الطلب';
      return 'جديد';
    }

    function canDeleteReq(r){
      // ✅ الحذف مسموح لحد المرحلة 2 (تم ارسال السيارة)
      // يعني يتعطل مباشرة بعد المرحلة 3 (تم استلام السيارة) أو 4 (تم الانتهاء)
      return !r.step3At && !r.step4At;
    }

    // ----- Create Request VIN table -----
    function clearReqRows(){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return;
      tb.innerHTML = '';
      addReqRow();
    }

    async function fillReqRowFromVin(tr, vin){
      const c = {
        car: tr.querySelector('[data-cell=car]'),
        cat: tr.querySelector('[data-cell=cat]'),
        ext: tr.querySelector('[data-cell=ext]'),
        int: tr.querySelector('[data-cell=int]'),
        model: tr.querySelector('[data-cell=model]'),
        loc: tr.querySelector('[data-cell=loc]'),
      };
      if(!vin){
        Object.values(c).forEach(el=>el.textContent='');
        tr.dataset.vin='';
        tr.dataset.missing='0';
        return;
      }
      tr.style.opacity = '.65';
      try{
        const snap = await db.collection('cars').doc(vin).get();
        if(!snap.exists){
          c.car.textContent = 'غير موجود';
          c.cat.textContent = '—';
          c.ext.textContent = '—';
          c.int.textContent = '—';
          c.model.textContent = '—';
          c.loc.textContent = '—';
          tr.dataset.vin = vin;
          tr.dataset.missing = '1';
          try{ setTransferAgencyBoxVisible(false);
        try{ refreshTransferAgencyVinSelector(); }catch(_e){} }catch(_){ }
        }else{
          const d = snap.data()||{};
          c.car.textContent = d.carName || '';
          c.cat.textContent = d.statement || '';
          c.ext.textContent = d.exteriorColor || '';
          c.int.textContent = d.interiorColor || '';
          c.model.textContent = d.model || '';
          c.loc.textContent = d.location || '';
          tr.dataset.vin = d.vin || vin;
          tr.dataset.missing = '0';
        }
      }finally{
        tr.style.opacity = '1';
      }
    }

    function addReqRow(vin=''){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return;
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input data-req-vin placeholder="اكتب VIN" value="${(vin||'').replace(/"/g,'&quot;')}" style="min-width:210px" /></td>
        <td data-cell="car"></td>
        <td data-cell="cat"></td>
        <td data-cell="ext"></td>
        <td data-cell="int"></td>
        <td data-cell="model"></td>
        <td data-cell="loc"></td>
        <td><button class="btn danger" type="button" data-del-req style="padding:7px 10px;border-radius:10px">حذف</button></td>
      `;
      tb.appendChild(tr);

      const inp = tr.querySelector('input[data-req-vin]');
      let t=null;
      inp.addEventListener('input', ()=>{
        const v = inp.value.trim();
        if(t) clearTimeout(t);
        t = setTimeout(()=>fillReqRowFromVin(tr, v), 250);
      });
      inp.addEventListener('blur', ()=>fillReqRowFromVin(tr, inp.value.trim()));

      tr.querySelector('[data-del-req]').addEventListener('click', ()=>tr.remove());

      if(vin) fillReqRowFromVin(tr, vin);
    }

    function getReqItems(){
      const tb = document.querySelector('#req_vinTable tbody');
      if(!tb) return [];
      const items = [];
      tb.querySelectorAll('tr').forEach(tr=>{
        const vin = (tr.querySelector('input[data-req-vin]')?.value || '').trim();
        if(vin) items.push({ vin });
      });
      // remove duplicates by VIN (keep first)
      const seen = new Set();
      return items.filter(it=>{
        if(seen.has(it.vin)) return false;
        seen.add(it.vin);
        return true;
      });
    }

    function statusFromLocation(loc){
      if(!loc) return '';
      if(loc.includes('المخزون المتاح')) return 'المخزون المتاح';
      if(loc.includes('سيارات بها ملاحظات')) return 'بها ملاحظات';
      if(loc.includes('مباع تحت التسليم')) return 'مباع تحت التسليم';
      if(loc.includes('مباع تم التسليم')) return 'مباع تم التسليم';
      return '';
    }

    async function submitRequest(){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');

      const mode = $('req_mode')?.value || 'create';
      if(mode!=='create') return;

      const type = $('req_type').value;
      const toLocation = $('req_to').value;
      if(!toLocation) return toast('اختر المكان');

      const photoDate = $('req_photo_date').value;
      if(type==='photo' && !photoDate) return toast('اختر تاريخ التصوير');

      const items = getReqItems();
      if(items.length===0) return toast('اكتب VIN واحد على الأقل');

      // تحقق وجود السيارات + حفظ (من) لكل هيكل وقت إنشاء الطلب
      const missing = [];
      const fromMap = {};
      for(const it of items){
        const snap = await db.collection('cars').doc(it.vin).get();
        if(!snap.exists){
          missing.push(it.vin);
          continue;
        }
        const d = snap.data() || {};
        fromMap[it.vin] = (d.location || d.branch || '').toString().trim();
      }
      if(missing.length){
        return toast('في هياكل غير موجودة: ' + missing.slice(0,5).join(', ') + (missing.length>5?'...':''));
      }

      const itemsFull = items.map(it=>({
        vin: it.vin,
        fromLocation: fromMap[it.vin] || ''
      }));

      const fromLocations = Array.from(new Set(Object.values(fromMap).filter(Boolean)));

      const req = {
        type, // transfer | photo
        items: itemsFull,
        vins: itemsFull.map(x=>x.vin),
        fromLocations,
        toLocation,
        photoDate: type==='photo' ? photoDate : null,

        createdBy: user.email,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        step1At: null, step2At: null, step3At: null, step4At: null,
        step1By: null, step2By: null, step3By: null, step4By: null,
      };

      const ref = await db.collection('requests').add(req);

      // حفظ ملاحظة كل VIN داخل المخزون في (ملاحظات تحديد المكان)
      try{
        const batch = db.batch();
        let has = false;
        (items||[]).forEach(it=>{
          const note = (it.note||'').trim();
          if(!note) return;
          const carRef = db.collection('cars').doc(it.vin);
          batch.set(carRef, {
            noteLocation: note,
            notesLocation: note,
            noteLocationUpdatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            noteLocationUpdatedBy: user.email
          }, { merge:true });
          has = true;
        });
        if(has) await batch.commit();
      }catch(e){
        console.warn('req->cars noteLocation update failed', e);
      }

      toast('تم إرسال الطلب');
      logAction('requests','request_create',{requestId: ref.id, type:type, toLocation:toLocation, vins: (items||[]).map(x=>x.vin)});
      // reset
      clearReqRows();
      $('req_to').value = '';
if(type==='photo'){ $('req_photo_date').value=''; }
      // انتقل لمتابعة الطلبات
      $('req_mode').value='track';
      switchReqMode();
      // افتح مباشرة
      openReqModal({ id: ref.id, ...req });
    }

    // ----- Requests lists -----
    function renderReqList(rows, tableSel, metaEl, onlyDone){
      const tb = document.querySelector(tableSel+' tbody');
      tb.innerHTML = '';
      let c=0;
      rows.forEach(r=>{
        const done = !!r.step4At;
        if(onlyDone && !done) return;
        if(!onlyDone && done) return;

        const tr = document.createElement('tr');
        const created = fmtDate(r.createdAt);
        const status = reqStatusLabel(r);
        const cells = onlyDone
          ? [
              created,
              reqTypeLabel(r.type),
              (r.vins||[]).length,
              reqFromLabel(r),
              r.toLocation || '',
              fmtDate(r.step4At),
              '__OPEN__'
            ]
          : [
              created,
              reqTypeLabel(r.type),
              (r.vins||[]).length,
              reqFromLabel(r),
              r.toLocation || '',
              '__OPEN__'
            ];
        cells.forEach((t,idx)=>{
          const td = document.createElement('td');
          if(t==='__OPEN__'){
            const b = document.createElement('button');
            b.className='linkBtn';
            b.textContent='فتح';
            b.type='button';
            b.addEventListener('click', ()=>openReqModal(r));
            td.appendChild(b);
          }else{
            td.textContent = t;
          }
          tr.appendChild(td);
        });
        tb.appendChild(tr);
        c++;
      });
      metaEl.textContent = `الطلبات: ${c}`;
    }

    function startRequestsLive(){
      // ✅ Requests now loads ONCE (get) to reduce quota
      stopRequestsLive();
      db.collection('requests').orderBy('createdAt','desc').limit(200).get().then((snap)=>{
        const all = [];
        snap.forEach(d=>all.push({ id:d.id, ...(d.data()||{}) }));
        renderReqList(all, '#req_table_open', $('req_open_meta'), false);
        renderReqList(all, '#req_table_done', $('req_done_meta'), true);
      }).catch((err)=>toast(err?.message || 'فشل تحميل الطلبات'));
    }

    // ----- Request modal actions -----
    const reqModal = document.getElementById('reqModal');
    const reqModalBody = document.getElementById('reqModalBody');
    const reqModalFoot = document.getElementById('reqModalFoot');
    const reqModalTitle = document.getElementById('reqModalTitle');

    function closeReqModal(){
      reqModal.classList.remove('show');
      reqModalBody.innerHTML='';
      reqModalFoot.innerHTML='';
      reqModal.dataset.id='';
    }

    document.getElementById('reqClose')?.addEventListener('click', closeReqModal);
    reqModal?.addEventListener('click', (e)=>{ if(e.target===reqModal) closeReqModal(); });

    async function markStep(reqId, step){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');
      const ref = db.collection('requests').doc(reqId);
      const snap = await ref.get();
      if(!snap.exists) return toast('الطلب غير موجود');
      const r = snap.data()||{};

      const updates = {};
      const now = firebase.firestore.FieldValue.serverTimestamp();

      if(step===1){ updates.step1At = now; updates.step1By = user.email; }
      if(step===2){ updates.step2At = now; updates.step2By = user.email; }
      if(step===3){ updates.step3At = now; updates.step3By = user.email; }
      if(step===4){ updates.step4At = now; updates.step4By = user.email; }

      // منع ترتيب خاطئ بسيط
      if(step>1 && !r.step1At) return toast('لازم تم استلام الطلب أولاً');
      if(step>2 && !r.step2At) return toast('لازم تم ارسال السيارة أولاً');
      if(step>3 && !r.step3At) return toast('لازم تم استلام السيارة أولاً');

      await ref.set(updates, {merge:true});
      logAction('requests','request_step',{requestId:reqId, step:step, type:r.type||'', toLocation:r.toLocation||'', vins:(r.vins||[])});

      // لو خطوة (تم استلام السيارة) و نوع نقل: حدّث مكان السيارات
      if(step===3 && r.type==='transfer'){
        const batch = db.batch();
        const toLoc = r.toLocation || '';
        const st = statusFromLocation(toLoc);
        const items = r.items || [];
        items.forEach(it=>{
          const carRef = db.collection('cars').doc(it.vin);
          const upd = { location: toLoc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
          if(st) upd.status = st;
          batch.set(carRef, upd, {merge:true});

          const logRef = db.collection('logs').doc();
          batch.set(logRef, {
            action: 'request_transfer_receive_car',
            requestId: reqId,
            vin: it.vin,
            toLocation: toLoc,
            by: user.email,
            at: firebase.firestore.FieldValue.serverTimestamp()
          });
        });
        await batch.commit();
      }

      toast('تم تحديث الطلب');
      // refresh modal
      const snap2 = await ref.get();
      openReqModal({ id:reqId, ...(snap2.data()||{}) }, true);
    }

    async function deleteRequest(reqId){
      const user = auth.currentUser;
      if(!user) return toast('سجّل دخول أولاً');
      const ref = db.collection('requests').doc(reqId);
      const snap = await ref.get();
      if(!snap.exists) return toast('الطلب غير موجود');
      const r = snap.data()||{};
      if(!canDeleteReq(r)) return toast('ممنوع حذف الطلب بعد تنفيذ إجراءات');
      await ref.delete();
      toast('تم حذف الطلب');
      logAction('requests','request_delete',{requestId:reqId, type:r.type||'', toLocation:r.toLocation||'', vins:(r.vins||[])});
      closeReqModal();
    }
    async function openReqModal(r, keepOpen=false){
      if(!r || !r.id){
        toast('لا يمكن فتح الطلب');
        return;
      }
      reqModal.dataset.id = r.id;
      reqModalTitle.textContent = `تفاصيل الطلب — ${reqTypeLabel(r.type)} (${(r.vins||[]).length})`;
      
      const carMap = {};
      const its = r.items || [];
      await Promise.all(its.map(async (it)=>{
        try{
          const cs = await db.collection('cars').doc(it.vin).get();
          if(cs.exists) carMap[it.vin] = cs.data() || {};
        }catch(e){}
      }));
      reqModalBody.innerHTML = buildReqBody(r, carMap);
    

      const id = r.id;
      reqModalFoot.innerHTML = '';

      const mkBtn = (label, cls, fn, disabled=false)=>{
        const b = document.createElement('button');
        b.className = 'btn ' + cls;
        b.type = 'button';
        b.textContent = label;
        b.disabled = !!disabled;
        b.addEventListener('click', fn);
        return b;
      };

      // أزرار الخطوات
      reqModalFoot.appendChild(mkBtn('تم استلام الطلب', 'secondary', ()=>markStep(id,1), !!r.step1At));
      reqModalFoot.appendChild(mkBtn('تم ارسال السيارة', 'secondary', ()=>markStep(id,2), !r.step1At || !!r.step2At));
      reqModalFoot.appendChild(mkBtn('تم استلام السيارة', 'secondary', ()=>markStep(id,3), !r.step2At || !!r.step3At));
      reqModalFoot.appendChild(mkBtn('تم الانتهاء', 'primary', ()=>markStep(id,4), !r.step3At || !!r.step4At));

      // حذف
      reqModalFoot.appendChild(mkBtn('حذف الطلب', 'danger', ()=>deleteRequest(id), !canDeleteReq(r)));

      reqModal.classList.add('show');
    }

    // ----- Requests UI mode switch -----
    function switchReqMode(){
      const v = $('req_mode').value;

      // أقسام التاب
      $('req_create_box').classList.toggle('hidden', v!=='create');
      $('req_track_box').classList.toggle('hidden', v!=='track');
      $('req_done_box').classList.toggle('hidden', v!=='done');

      // عناصر إنشاء الطلب فقط (نوع الطلب / مكان النقل / تاريخ التصوير)
      document.querySelectorAll('.reqOnlyCreate').forEach(el=>{
        el.classList.toggle('hidden', v!=='create');
      });

      if(v==='track' || v==='done') startRequestsLive();
      else stopRequestsLive();
    }

    if($('req_mode')) $('req_mode').addEventListener('change', switchReqMode);

    if($('req_type')){
      $('req_type').addEventListener('change', ()=>{
        const t = $('req_type').value;
        $('req_photo_date_box').classList.toggle('hidden', t!=='photo');
        $('req_loc_label').textContent = (t==='photo') ? 'مكان التصوير' : 'مكان النقل';
        if(t!=='photo') $('req_photo_date').value='';
      });
    }

    if($('req_addRow')) $('req_addRow').addEventListener('click', ()=>addReqRow());
    if($('req_clearRows')) $('req_clearRows').addEventListener('click', clearReqRows);
    if($('req_submit')) $('req_submit').addEventListener('click', ()=>submitRequest().catch(e=>toast(e.message||'فشل إرسال الطلب')));

    // init request rows
    if(document.querySelector('#req_vinTable tbody') && document.querySelector('#req_vinTable tbody').children.length===0){
      clearReqRows();
    }
    if($('req_create_hint')){
      $('req_create_hint').innerHTML = 'تنبيه: <b>النقل</b> يغيّر مكان السيارة في المخزون عند زر <b>تم استلام السيارة</b>.';
    }

    
    /****************************************************
     * كل السيارات (تجميع + تصدير)
     ****************************************************/
    let _allCarsUnsub = null;
    let _allCarsRows = [];

    function startAllCarsLive(){
      // ✅ All Cars now loads ONCE (get) to reduce quota
      const tbody = document.querySelector('#allCarsTable tbody');
      const meta  = document.getElementById('allCarsMeta');
      if(!tbody) return;

      meta.textContent = 'جاري التحميل...';
      db.collection('cars').get().then((snap)=>{
        const map = new Map();
        snap.forEach(doc=>{
          const d = doc.data() || {};
          const carName = (d.carName || d['سيارة'] || '').toString().trim();
          const statement = (d.statement || d['البيان'] || '').toString().trim();
          const model = (d.model || d['موديل'] || '').toString().trim();

          const key = [carName, statement, model].join('||');
          if(!map.has(key)){
            map.set(key, {carName, statement, model, count:0});
          }
          map.get(key).count += 1;
        });

        _allCarsRows = Array.from(map.values())
          .sort((a,b)=>{
            return (a.carName||'').localeCompare(b.carName||'') ||
                   (a.model||'').localeCompare(b.model||'') ||
                   (a.statement||'').localeCompare(b.statement||'');
          });

        tbody.innerHTML = '';
        _allCarsRows.forEach((r,i)=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${i+1}</td>
            <td>${escapeHtml(r.carName||'—')}</td>
            <td>${escapeHtml(r.statement||'—')}</td>
            <td>${escapeHtml(r.model||'—')}</td>
            <td style="font-weight:700">${r.count}</td>
          `;
          tbody.appendChild(tr);
        });

        meta.textContent = `إجمالي السجلات في المخزون: ${snap.size} | إجمالي الصفوف بعد التجميع: ${_allCarsRows.length}`;
      }).catch((err)=>{
        meta.textContent = 'تعذر تحميل البيانات. راجع الصلاحيات.';
        console.error(err);
      });
    }

    function stopAllCarsLive(){
      // no-op (no live listener)
      if(_allCarsUnsub){ _allCarsUnsub(); _allCarsUnsub = null; }
    }

    function exportAllCars(){
      const data = _allCarsRows.map((r,i)=>({
        '#': i+1,
        'السيارة': r.carName || '',
        'البيان': r.statement || '',
        'الموديل': r.model || '',
        'إجمالي العدد': r.count || 0
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'كل السيارات');
      XLSX.writeFile(wb, 'كل_السيارات.xlsx');
    }

    const btnExportAllCars = document.getElementById('btnExportAllCars');
    if(btnExportAllCars){
      btnExportAllCars.addEventListener('click', exportAllCars);
    }


    // Hook into main tabs: when opening requests tab ensure mode is applied
    const __openViewBase = openView;
    openView = function(viewId){
      __openViewBase(viewId);
      if(viewId==='view-requests'){
        switchReqMode();
      }else{
        stopRequestsLive();
      }

      if(viewId==='view-allcars'){
        startAllCarsLive();
      }else{
        stopAllCarsLive();
      }
    };

    // ===== Logs Tab bindings =====
    fillLogsLocations();
    document.getElementById('lg_filter')?.addEventListener('change', uiLogsFilterChanged);
    document.getElementById('lg_apply')?.addEventListener('click', ()=>loadLogs().catch(e=>toast(e.message||'فشل تحميل السجل')));
    document.getElementById('lg_export')?.addEventListener('click', exportLogsExcel);
    document.getElementById('lg_pdf')?.addEventListener('click', exportLogsPDF);
    uiLogsFilterChanged();


    // ===== Users Admin (Firestore users collection) =====
    let usersUnsub = null;
    let uaCache = [];
    let uaSelected = null;

    const UA_TABS = [
      { key: 'dashboard', label: 'الداش بورد' },
      { key: 'admin', label: 'الإدارة' },
      { key: 'inventory', label: 'المخزون' },
      { key: 'car_transfer', label: 'الحركة' },
      { key: 'requests', label: 'الطلبات' },
      { key: 'all_cars', label: 'كل السيارات' },
      { key: 'movement_log', label: 'سجل الحركات' },
      { key: 'tracking', label: 'التراكينج' },
      { key: 'archive', label: 'الأرشيف' },
      { key: 'users_admin', label: 'إدارة المستخدمين' },
    ];

    // قالب الصلاحيات المعتمد (بنفس هيكل الرسالة)
    const UA_TEMPLATE = {
      name: '',
      email: '',
      active: true,
      tabs: {
        dashboard: true,
        admin: false,
        inventory: false,
        car_transfer: false,
        requests: false,
        all_cars: false,
        movement_log: false,
        tracking: false,
        archive: false,
        users_admin: false
      },
      permissions: {
        dashboard: { buttons: { save: false, clear: false } },
        inventory: { buttons: { add_car: false, clear_list: false, delete: false, execute_transfer_request: false } },
        requests: {
          dropdowns: { choose_section: false },
          sections: { create_request: false, follow_requests: false, completed_requests: false },
          fields: { request_type_select: false, vin_input: false, transfer_location_select: false },
          buttons: { add_vin: false, clear_list: false, delete: false, send_request: false },
          workflow_actions: { receive_order: false, send_car: false, receive_car: false, finish_order: false }
        },
        all_cars: { view: true },
        movement_log: { view: true },
        tracking: { view: true },
        archive: { view: true },
        users_admin: { view_users: false, edit_permissions: false, create_user_record: false, disable_user: false }
      }
    };

    // JS doesn't have true/false literals in object above when written as string.

    function uaCloneTemplate(){
      // deep clone
      return JSON.parse(JSON.stringify(UA_TEMPLATE));
    }

    function uaTs(v){
      try{
        if(!v) return '';
        if(typeof v.toDate === 'function') return v.toDate().toLocaleString('ar-SA');
        if(typeof v === 'number') return new Date(v).toLocaleString('ar-SA');
        return '';
      }catch(e){ return ''; }
    }

    function uaNormalizeUser(docId, d){
      const base = uaCloneTemplate();
      // merge shallow
      base.name = (d && d.name) ? d.name : '';
      base.email = (d && d.email) ? d.email : '';
      base.active = (d && typeof d.active === 'boolean') ? d.active : true;
      base.tabs = Object.assign({}, base.tabs, (d && d.tabs) ? d.tabs : {});
      base.permissions = Object.assign({}, base.permissions, (d && d.permissions) ? d.permissions : {});
      return {
        id: docId,
        uid: d && (d.uid || d.UID) ? (d.uid || d.UID) : docId,
        createdAt: d && d.createdAt ? d.createdAt : null,
        updatedAt: d && d.updatedAt ? d.updatedAt : null,
        updatedBy: d && d.updatedBy ? d.updatedBy : '',
        data: base
      };
    }

    function uaMatch(u, q){
      if(!q) return true;
      const bag = [u.data?.name, u.data?.email, u.uid, u.id].map(v=>String(v||'').toLowerCase()).join(' | ');
      return bag.includes(q);
    }

    function uaFilterList(){
      const q = (document.getElementById('ua_search')?.value || '').trim().toLowerCase();
      const af = document.getElementById('ua_active_filter')?.value || 'all';
      return uaCache.filter(u=>{
        if(af==='active' && !u.data.active) return false;
        if(af==='inactive' && u.data.active) return false;
        return uaMatch(u, q);
      });
    }

    function uaRenderList(){
      const tb = document.getElementById('ua_tbody');
      if(!tb) return;
      const list = uaFilterList();
      if(!list.length){
        tb.innerHTML = '<tr><td colspan="6" class="small muted">لا يوجد مستخدمون</td></tr>';
        return;
      }
      tb.innerHTML = list.map(u=>{
        const name = escapeHtml(u.data.name||'—');
        const email = escapeHtml(u.data.email||'—');
        const uid = escapeHtml(u.uid||u.id||'—');
        const st = u.data.active ? '<span class="tag ok">نشط</span>' : '<span class="tag no">غير نشط</span>';
        const upd = escapeHtml(uaTs(u.updatedAt||u.createdAt));
        return `<tr>
          <td>${name}</td>
          <td>${email}</td>
          <td dir="ltr">${uid}</td>
          <td>${st}</td>
          <td>${upd}</td>
          <td><button class="btn secondary" data-ua-edit="${escapeHtml(u.id)}">تعديل</button></td>
        </tr>`;
      }).join('');

      tb.querySelectorAll('[data-ua-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-ua-edit');
          const u = uaCache.find(x=>x.id===id);
          if(u) uaOpenEditor(u);
        });
      });
    }

    function uaTabItem(key, label, checked){
      return `<label class="checkItem">
        <span>${escapeHtml(label)}</span>
        <input type="checkbox" data-ua-tab="${escapeHtml(key)}" ${checked?'checked':''} />
      </label>`;
    }

    function uaPermBlock(title, html){
      return `<div class="card" style="box-shadow:none;border:1px solid var(--line);margin-bottom:10px">
        <h3 style="border:none;padding:12px 12px 0 12px;font-size:14px">${escapeHtml(title)}</h3>
        <div class="body" style="padding:12px">${html}</div>
      </div>`;
    }

    function uaRenderPerms(perms){
      // perms is UA_TEMPLATE.permissions-like
      const blocks = [];

      // dashboard buttons
      blocks.push(uaPermBlock('Dashboard', [
        uaBoolField('dashboard.buttons.save','حفظ (save)', !!perms.dashboard?.buttons?.save),
        uaBoolField('dashboard.buttons.clear','مسح (clear)', !!perms.dashboard?.buttons?.clear)
      ].join('')));

      // inventory buttons
      blocks.push(uaPermBlock('Inventory', [
        uaBoolField('inventory.buttons.add_car','إضافة سيارة', !!perms.inventory?.buttons?.add_car),
        uaBoolField('inventory.buttons.clear_list','مسح القائمة', !!perms.inventory?.buttons?.clear_list),
        uaBoolField('inventory.buttons.delete','حذف', !!perms.inventory?.buttons?.delete),
        uaBoolField('inventory.buttons.execute_transfer_request','تنفيذ طلب نقل', !!perms.inventory?.buttons?.execute_transfer_request)
      ].join('')));

      // requests (dropdowns, sections, fields, buttons, workflow_actions)
      blocks.push(uaPermBlock('Requests', [
        '<div class="small" style="margin-bottom:6px"><b>Dropdowns</b></div>',
        uaBoolField('requests.dropdowns.choose_section','اختر القسم', !!perms.requests?.dropdowns?.choose_section),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Sections</b></div>',
        uaBoolField('requests.sections.create_request','إنشاء طلب', !!perms.requests?.sections?.create_request),
        uaBoolField('requests.sections.follow_requests','متابعة الطلبات', !!perms.requests?.sections?.follow_requests),
        uaBoolField('requests.sections.completed_requests','الطلبات المكتملة', !!perms.requests?.sections?.completed_requests),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Fields</b></div>',
        uaBoolField('requests.fields.request_type_select','تحديد نوع الطلب', !!perms.requests?.fields?.request_type_select),
        uaBoolField('requests.fields.vin_input','كتابة رقم الهيكل', !!perms.requests?.fields?.vin_input),
        uaBoolField('requests.fields.transfer_location_select','اختيار مكان النقل', !!perms.requests?.fields?.transfer_location_select),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Buttons</b></div>',
        uaBoolField('requests.buttons.add_vin','إضافة هيكل', !!perms.requests?.buttons?.add_vin),
        uaBoolField('requests.buttons.clear_list','مسح القائمة', !!perms.requests?.buttons?.clear_list),
        uaBoolField('requests.buttons.delete','حذف', !!perms.requests?.buttons?.delete),
        uaBoolField('requests.buttons.send_request','إرسال الطلب', !!perms.requests?.buttons?.send_request),
        '<div class="hr" style="margin:10px 0"></div>',
        '<div class="small" style="margin-bottom:6px"><b>Workflow Actions</b></div>',
        uaBoolField('requests.workflow_actions.receive_order','تم استلام الطلب', !!perms.requests?.workflow_actions?.receive_order),
        uaBoolField('requests.workflow_actions.send_car','تم ارسال السيارة', !!perms.requests?.workflow_actions?.send_car),
        uaBoolField('requests.workflow_actions.receive_car','تم استلام السيارة', !!perms.requests?.workflow_actions?.receive_car),
        uaBoolField('requests.workflow_actions.finish_order','تم الانتهاء', !!perms.requests?.workflow_actions?.finish_order)
      ].join('')));

      // view permissions
      blocks.push(uaPermBlock('Views', [
        uaBoolField('all_cars.view','عرض كل السيارات', !!perms.all_cars?.view),
        uaBoolField('movement_log.view','عرض سجل الحركات', !!perms.movement_log?.view),
        uaBoolField('tracking.view','عرض التراكينج', !!perms.tracking?.view),
        uaBoolField('archive.view','عرض الأرشيف', !!perms.archive?.view)
      ].join('')));

      // users_admin
      blocks.push(uaPermBlock('Users Admin', [
        uaBoolField('users_admin.view_users','عرض المستخدمين', !!perms.users_admin?.view_users),
        uaBoolField('users_admin.edit_permissions','تعديل الصلاحيات', !!perms.users_admin?.edit_permissions),
        uaBoolField('users_admin.create_user_record','إنشاء سجل مستخدم', !!perms.users_admin?.create_user_record),
        uaBoolField('users_admin.disable_user','تعطيل مستخدم', !!perms.users_admin?.disable_user)
      ].join('')));

      return blocks.join('');
    }

    function uaBoolField(pathKey, label, checked){
      return `<label class="checkItem" style="background:#fff">
        <span>${escapeHtml(label)}</span>
        <input type="checkbox" data-ua-perm="${escapeHtml(pathKey)}" ${checked?'checked':''} />
      </label>`;
    }

    function uaOpenEditor(u){
      uaSelected = u;
      const ed = document.getElementById('ua_editor');
      if(!ed) return;
      ed.style.display = 'block';
      document.getElementById('ua_editor_user').innerHTML = `المستخدم: <b>${escapeHtml(u.data.email||'')}</b> <span class="small muted">(uid: ${escapeHtml(u.uid||u.id||'')})</span>`;
      document.getElementById('ua_name').value = u.data.name || '';
      document.getElementById('ua_email').value = u.data.email || '';
      document.getElementById('ua_active').value = (u.data.active ? 'true' : 'false');

      const tabsBox = document.getElementById('ua_tabs_box');
      tabsBox.innerHTML = UA_TABS.map(t=>uaTabItem(t.key, t.label, !!u.data.tabs?.[t.key])).join('');

      const permsBox = document.getElementById('ua_perms_box');
      permsBox.innerHTML = uaRenderPerms(u.data.permissions || uaCloneTemplate().permissions);
    }

    function uaSetDeep(obj, pathKey, val){
      const parts = pathKey.split('.');
      let cur = obj;
      for(let i=0;i<parts.length-1;i++){
        const k = parts[i];
        if(!cur[k] || typeof cur[k] !== 'object') cur[k] = {};
        cur = cur[k];
      }
      cur[parts[parts.length-1]] = val;
    }

    async function uaSave(){
      if(!uaSelected) return;
      const name = (document.getElementById('ua_name')?.value || '').trim();
      const email = (document.getElementById('ua_email')?.value || '').trim();
      const active = (document.getElementById('ua_active')?.value || 'true') === 'true';

      const payload = uaCloneTemplate();
      payload.name = name;
      payload.email = email;
      payload.active = active;

      // tabs
      document.querySelectorAll('[data-ua-tab]').forEach(ch=>{
        const k = ch.getAttribute('data-ua-tab');
        if(k) payload.tabs[k] = !!ch.checked;
      });

      // detailed perms
      document.querySelectorAll('[data-ua-perm]').forEach(ch=>{
        const p = ch.getAttribute('data-ua-perm');
        if(p) uaSetDeep(payload.permissions, p, !!ch.checked);
      });

      // enforce: if user is inactive -> hide all tabs except dashboard/users_admin? (keep as is, only save active)
      try{
        await db.collection('users').doc(uaSelected.id).set({
          uid: uaSelected.uid || uaSelected.id,
          name: payload.name,
          email: payload.email,
          active: payload.active,
          tabs: payload.tabs,
          permissions: payload.permissions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedBy: auth.currentUser?.email || ''
        }, { merge: true });
        toast('تم حفظ المستخدم');
      }catch(e){
        toast(e?.message || 'فشل حفظ المستخدم');
      }
    }

    async function uaCreateRecord(){
      const name = (document.getElementById('ua_new_name')?.value || '').trim();
      const email = (document.getElementById('ua_new_email')?.value || '').trim();
      const uid = (document.getElementById('ua_new_uid')?.value || '').trim();
      if(!email){ toast('اكتب البريد الإلكتروني'); return; }
      const docId = uid || email; // لو مفيش UID نخزن بالميل
      const tpl = uaCloneTemplate();
      tpl.name = name || 'اسم المستخدم';
      tpl.email = email;

      try{
        await db.collection('users').doc(docId).set({
          uid: uid || docId,
          name: tpl.name,
          email: tpl.email,
          active: true,
          tabs: tpl.tabs,
          permissions: tpl.permissions,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: auth.currentUser?.email || '',
          updatedBy: auth.currentUser?.email || ''
        }, { merge: true });
        toast('تم إنشاء سجل المستخدم');
        document.getElementById('ua_new_name').value = '';
        document.getElementById('ua_new_email').value = '';
        document.getElementById('ua_new_uid').value = '';
      }catch(e){
        toast(e?.message || 'فشل إنشاء سجل المستخدم');
      }
    }

    function uaStartLive(){
      // ✅ Users admin now loads ONCE (get) to reduce quota
      let q = db.collection('users');
      try{ q = q.orderBy('email'); }catch(_){ /* ignore */ }

      q.get().then((snap)=>{
        const arr = [];
        snap.forEach(doc=>{
          const d = doc.data() || {};
          arr.push(uaNormalizeUser(doc.id, d));
        });
        uaCache = arr;
        uaRenderList();
      }).catch((err)=>{
        console.warn('users load error', err);
      });
    }

    function uaStopLive(){
      // no-op (no live listener)
      usersUnsub = null;
    }

    // Bind UI
    document.getElementById('ua_refresh')?.addEventListener('click', ()=>uaRenderList());
    document.getElementById('ua_search')?.addEventListener('input', ()=>uaRenderList());
    document.getElementById('ua_active_filter')?.addEventListener('change', ()=>uaRenderList());
    document.getElementById('ua_create')?.addEventListener('click', uaCreateRecord);
    document.getElementById('ua_save')?.addEventListener('click', uaSave);
    document.getElementById('ua_close')?.addEventListener('click', ()=>{
      const ed = document.getElementById('ua_editor');
      if(ed) ed.style.display = 'none';
      uaSelected = null;
    });

    // Hook into openView to start/stop live
    const __openView_users_admin = openView;
    openView = function(viewId){
      __openView_users_admin(viewId);
      if(viewId === 'view-users'){
        uaStartLive();
      }else{
        uaStopLive();
      }
    };

</script>

<script>
// ===== Dashboard Card: Car Shortages (نواقص السيارات) =====
(function(){
  function __cs_norm(v){ return (v||'').toString().trim(); }

  // Grouping key: (السيارة + البيان + الموديل + اللون الخارجي + اللون الداخلي)
  function __cs_key(c){
    return [
      __cs_norm(c.carName),
      __cs_norm(c.statement),
      __cs_norm(c.model),
      __cs_norm(c.exteriorColor),
      __cs_norm(c.interiorColor)
    ].join('||');
  }

  function __cs_isActual(st){
    const s = __cs_norm(st);
    return (s==='متاح للبيع' || s==='محجوز' || s==='حجز' || s==='بها ملاحظات');
  }

  function __cs_isExcludedStatement(statement){
    const s = (__cs_norm(statement)).toLowerCase();
    if(!s) return false;
    const bad = [
      'حساس','حساسات',
      'كاميرا',
      'شاشة',
      'مسجل',
      'ريموت',
      'فرشات',
      'طفاية',
      'شنطة سلامة','شنطة السلامة',
      'اسبير','إسبير','اسبـير'
    ];
    return bad.some(x => s.includes(x.toLowerCase()));
  }

  function buildCarShortageRowsForBranch(branch){
    const br = __cs_norm(branch);
    if(!br) return [];

    // Allowed locations = (المستودع + الفروع) بدون الوكالة
    let allowed = Array.isArray(window.__missingBranchesList) ? window.__missingBranchesList.slice() : [];
    if(!allowed.length){
      allowed = ['الملتقى','القادسية','الصالة','المستودع'];
    }
    const allowedSet = new Set(allowed.map(__cs_norm).filter(x=>x && x!=='الوكالة'));

    const totals = new Map();       // key -> total across allowed locations
    const branchCounts = new Map(); // key -> count in this branch

    (window.dashCars||[]).forEach(c=>{
      if(!__cs_isActual(c.status)) return;

      // استبعاد البنود غير السيارات
      if(__cs_isExcludedStatement(c.statement)) return;

      const loc = __cs_norm(c.location);
      if(!allowedSet.has(loc)) return;

      const key = __cs_key(c);
      if(!key) return;

      totals.set(key, (totals.get(key)||0) + 1);
      if(loc===br) branchCounts.set(key, (branchCounts.get(key)||0) + 1);
    });

    const rows = [];
    totals.forEach((totalCount, key)=>{
      const bCount = branchCounts.get(key) || 0;
      if(bCount===0 && totalCount>0){
        const parts = key.split('||');
        rows.push({
          carName: parts[0]||'',
          statement: parts[1]||'',
          model: parts[2]||'',
          exteriorColor: parts[3]||'',
          interiorColor: parts[4]||'',
          totalCount: totalCount
        });
      }
    });

    rows.sort((a,b)=>{
      const A = (a.carName+a.model+a.exteriorColor+a.interiorColor+a.statement).toString();
      const B = (b.carName+b.model+b.exteriorColor+b.interiorColor+b.statement).toString();
      return A.localeCompare(B,'ar');
    });
    return rows;
  }

  function __cs_setText(id, val){
    const el = document.getElementById(id);
    if(el) el.textContent = (val===null || typeof val==='undefined') ? '—' : String(val);
  }

  function __cs_updateCounts(){
    try{
      const m = buildCarShortageRowsForBranch('الملتقى').length;
      const s = buildCarShortageRowsForBranch('الصالة').length;
      const q = buildCarShortageRowsForBranch('القادسية').length;

      __cs_setText('cs_cnt_moltaqa', m);
      __cs_setText('cs_cnt_salah', s);
      __cs_setText('cs_cnt_qadisiyah', q);
      __cs_setText('dash_cs_total', (m+s+q));
    }catch(e){}
  }

  // Modal rendering
  let __cs_lastRows = [];
  function __cs_renderRows(rows){
    const tb = document.getElementById('carShortageBody');
    if(!tb) return;
    tb.innerHTML = '';
    rows.forEach(r=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(r.carName||'')}</td>
        <td>${escapeHtml(r.statement||'')}</td>
        <td>${escapeHtml(r.model||'')}</td>
        <td>${escapeHtml(r.exteriorColor||'')}</td>
        <td>${escapeHtml(r.interiorColor||'')}</td>
        <td><b>${escapeHtml(String(r.totalCount||0))}</b></td>
      `;
      tb.appendChild(tr);
    });
    const cnt = document.getElementById('carShortageCount');
    if(cnt) cnt.textContent = String(rows.length);
  }

  function openCarShortageModal(branch){
    const br = __cs_norm(branch);
    const modal = document.getElementById('carShortageModal');
    if(!modal) return;

    const title = document.getElementById('carShortageTitle');
    const sub = document.getElementById('carShortageSubMeta');
    const meta = document.getElementById('carShortageMeta');
    if(title) title.textContent = 'نواقص السيارات - ' + br;
    if(sub) sub.textContent = 'التركيبات التي إجماليها الفعلي > 0 وكمية الفرع = 0';
    if(meta) meta.textContent = '—';

    const rows = buildCarShortageRowsForBranch(br);
    __cs_lastRows = rows.slice();
    __cs_renderRows(rows);

    modal.classList.add('show');
  }

  // Search inside modal
  function __cs_applySearch(){
    const q = __cs_norm((document.getElementById('carShortageSearch')||{}).value).toLowerCase();
    const rows = !q ? __cs_lastRows : __cs_lastRows.filter(r=>{
      const blob = (r.carName+' '+r.statement+' '+r.model+' '+r.exteriorColor+' '+r.interiorColor).toLowerCase();
      return blob.includes(q);
    });
    __cs_renderRows(rows);
  }

  // Export Excel
  function __cs_export(){
    try{
      const rows = __cs_lastRows || [];
      const data = rows.map(r=>({
        'السيارة': r.carName,
        'البيان': r.statement,
        'الموديل': r.model,
        'اللون الخارجي': r.exteriorColor,
        'اللون الداخلي': r.interiorColor,
        'الإجمالي الفعلي': r.totalCount
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'نواقص السيارات');
      XLSX.writeFile(wb, 'نواقص_السيارات.xlsx');
    }catch(e){}
  }

  // Bind buttons once DOM is ready
  function __cs_bind(){
    const btnM = document.getElementById('cs_btn_moltaqa');
    const btnS = document.getElementById('cs_btn_salah');
    const btnQ = document.getElementById('cs_btn_qadisiyah');

    if(btnM && !btnM.__csBound){ btnM.__csBound=true; btnM.addEventListener('click', ()=>openCarShortageModal('الملتقى')); }
    if(btnS && !btnS.__csBound){ btnS.__csBound=true; btnS.addEventListener('click', ()=>openCarShortageModal('الصالة')); }
    if(btnQ && !btnQ.__csBound){ btnQ.__csBound=true; btnQ.addEventListener('click', ()=>openCarShortageModal('القادسية')); }

    const close = document.getElementById('carShortageClose');
    if(close && !close.__csBound){
      close.__csBound=true;
      close.addEventListener('click', ()=>{ document.getElementById('carShortageModal')?.classList.remove('show'); });
    }
    const backdrop = document.getElementById('carShortageModal');
    if(backdrop && !backdrop.__csBound){
      backdrop.__csBound=true;
      backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) backdrop.classList.remove('show'); });
    }
    const search = document.getElementById('carShortageSearch');
    if(search && !search.__csBound){
      search.__csBound=true;
      search.addEventListener('input', __cs_applySearch);
    }
    const ex = document.getElementById('carShortageExport');
    if(ex && !ex.__csBound){
      ex.__csBound=true;
      ex.addEventListener('click', __cs_export);
    }
  }

  // Update counts whenever dashboard data refreshes
  // We hook into existing dashboard refresh by polling lightly until dashCars ready then once per second for 5 seconds.
  async function __cs_init(){
    __cs_bind();
    try{
      if(typeof window.__ensureDashCarsReady === 'function'){
        await window.__ensureDashCarsReady();
      }
    }catch(e){}
    __cs_updateCounts();

    // also refresh after filters apply (button already exists)
    const showBtn = document.getElementById('dash_filter_show');
    if(showBtn && !showBtn.__csBound){
      showBtn.__csBound=true;
      showBtn.addEventListener('click', ()=>setTimeout(__cs_updateCounts, 450));
    }
  }

  document.addEventListener('DOMContentLoaded', __cs_init);
  // expose opener for possible reuse
  window.openCarShortageModal = openCarShortageModal;
})();
</script>



<script>
(function(){
  // Make the table area show about ~20 rows while keeping scroll inside modal
  function tuneCarShortageWrap(){
    const wrap = document.getElementById('carShortageTableWrap');
    if(!wrap) return;
    // 20 rows * ~26px + header ~42px ≈ 560px (cap by viewport via 60vh anyway)
    wrap.style.maxHeight = '560px';
  }
  document.addEventListener('click', function(e){
    const btn = e.target.closest && e.target.closest('#cs_btn_moltaqa, #cs_btn_salah, #cs_btn_qadisiyah');
    if(!btn) return;
    setTimeout(tuneCarShortageWrap, 50);
  }, true);
})();
</script>

<!-- ===== MOBILE SIDEBAR JS (Added for Mobile Support) ===== -->
<script>
(function(){
  'use strict';
  
  // Elements
  const sidebarToggle = document.getElementById('sidebarToggle');
  const mobileSidebar = document.getElementById('mobileSidebar');
  const sidebarOverlay = document.getElementById('sidebarOverlay');
  const sidebarClose = document.getElementById('sidebarClose');
  const sidebarNavItems = document.getElementById('sidebarNavItems');
  const sidebarAuthArea = document.getElementById('sidebarAuthArea');
  
  if(!sidebarToggle || !mobileSidebar) return;
  
  // Open sidebar
  function openSidebar(){
    mobileSidebar.classList.add('sidebar-open');
    sidebarOverlay.classList.add('sidebar-open');
    document.body.style.overflow = 'hidden';
  }
  
  // Close sidebar
  function closeSidebar(){
    mobileSidebar.classList.remove('sidebar-open');
    sidebarOverlay.classList.remove('sidebar-open');
    document.body.style.overflow = '';
  }
  
  // Toggle button
  sidebarToggle.addEventListener('click', openSidebar);
  
  // Close button
  if(sidebarClose){
    sidebarClose.addEventListener('click', closeSidebar);
  }
  
  // Overlay click closes sidebar
  if(sidebarOverlay){
    sidebarOverlay.addEventListener('click', closeSidebar);
  }
  
  // Clone tabs to sidebar
  function populateSidebarTabs(){
    const tabbar = document.querySelector('.tabbar');
    if(!tabbar || !sidebarNavItems) return;
    
    sidebarNavItems.innerHTML = '';
    
    const tabs = tabbar.querySelectorAll('.tab');
    tabs.forEach(function(tab){
      const btn = document.createElement('button');
      btn.className = 'sidebarTab';
      btn.textContent = tab.textContent;
      btn.type = 'button';
      
      if(tab.classList.contains('active')){
        btn.classList.add('active');
      }
      
      const viewId = tab.getAttribute('data-view');
      btn.setAttribute('data-view', viewId);
      
      btn.addEventListener('click', function(){
        // Update active state in sidebar
        sidebarNavItems.querySelectorAll('.sidebarTab').forEach(function(t){
          t.classList.remove('active');
        });
        btn.classList.add('active');
        
        // Trigger original tab click
        tab.click();
        
        // Close sidebar
        closeSidebar();
      });
      
      sidebarNavItems.appendChild(btn);
    });
  }
  
  // Clone auth info to sidebar
  function populateSidebarAuth(){
    if(!sidebarAuthArea) return;
    
    const authPill = document.getElementById('authPill');
    const btnLogout = document.getElementById('btnLogout');
    
    sidebarAuthArea.innerHTML = '';
    
    if(authPill){
      const pillClone = document.createElement('span');
      pillClone.className = 'pill';
      pillClone.id = 'sidebarAuthPill';
      pillClone.textContent = authPill.textContent;
      sidebarAuthArea.appendChild(pillClone);
      
      // Keep in sync
      const observer = new MutationObserver(function(){
        pillClone.textContent = authPill.textContent;
      });
      observer.observe(authPill, { childList: true, characterData: true, subtree: true });
    }
    
    if(btnLogout && !btnLogout.classList.contains('hidden')){
      const logoutClone = document.createElement('button');
      logoutClone.className = 'btn secondary';
      logoutClone.type = 'button';
      logoutClone.textContent = 'تسجيل خروج';
      logoutClone.addEventListener('click', function(){
        btnLogout.click();
        closeSidebar();
      });
      sidebarAuthArea.appendChild(logoutClone);
    }
  }
  
  // Sync active tab with sidebar
  function syncActiveTab(){
    const tabbar = document.querySelector('.tabbar');
    if(!tabbar || !sidebarNavItems) return;
    
    const activeTab = tabbar.querySelector('.tab.active');
    if(!activeTab) return;
    
    const viewId = activeTab.getAttribute('data-view');
    
    sidebarNavItems.querySelectorAll('.sidebarTab').forEach(function(t){
      t.classList.remove('active');
      if(t.getAttribute('data-view') === viewId){
        t.classList.add('active');
      }
    });
  }
  
  // Watch for logout button visibility changes
  function watchLogoutButton(){
    const btnLogout = document.getElementById('btnLogout');
    if(!btnLogout) return;
    
    const observer = new MutationObserver(function(){
      populateSidebarAuth();
    });
    
    observer.observe(btnLogout, { attributes: true, attributeFilter: ['class'] });
  }
  
  // Watch for tab changes in desktop tabbar
  function watchTabChanges(){
    const tabbar = document.querySelector('.tabbar');
    if(!tabbar) return;
    
    const observer = new MutationObserver(function(){
      syncActiveTab();
    });
    
    tabbar.querySelectorAll('.tab').forEach(function(tab){
      observer.observe(tab, { attributes: true, attributeFilter: ['class'] });
    });
  }
  
  // Initialize when DOM ready
  function initSidebar(){
    populateSidebarTabs();
    populateSidebarAuth();
    watchLogoutButton();
    watchTabChanges();
  }
  
  // Run on DOMContentLoaded
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initSidebar);
  }else{
    initSidebar();
  }
  
  // Re-populate auth when app becomes visible (after login)
  const appEl = document.getElementById('app');
  if(appEl){
    const appObserver = new MutationObserver(function(){
      setTimeout(populateSidebarAuth, 100);
    });
    appObserver.observe(appEl, { attributes: true, attributeFilter: ['class'] });
  }
})();
</script>
<!-- ===== END MOBILE SIDEBAR JS ===== -->

</body>
</html>
